# Rails Credentials Management

This project uses Rails encrypted credentials to securely store sensitive configuration data.

## Overview

Rails credentials are stored in two files:
- `config/credentials.yml.enc` - Encrypted credentials (safe to commit)
- `config/master.key` - Decryption key (NEVER commit)

## Accessing Credentials

### View Current Credentials

```bash
bin/rails credentials:show
```

### Edit Credentials

#### Dans Docker (recommandé)

Utilisez le script helper :
```bash
bin/edit-credentials [dev|staging|production]
```

Ou directement avec docker compose :
```bash
docker compose -f ops/dev/docker-compose.yml run --rm -it -e EDITOR=nano web bin/rails credentials:edit
```

**Important** : Utilisez `docker compose run` (pas `exec`) avec l'option `-it` pour avoir un terminal interactif.

#### En local (si Rails installé)

```bash
bin/rails credentials:edit
```

This will:
1. Decrypt `config/credentials.yml.enc` using `config/master.key`
2. Open it in your default editor (nano dans Docker)
3. Re-encrypt and save when you close the editor

### Using Credentials in Code

```ruby
# Access credentials
Rails.application.credentials.secret_key_base
Rails.application.credentials.dig(:helloasso, :token)
Rails.application.credentials.dig(:smtp, :user_name)
Rails.application.credentials.dig(:minio, :access_key_id)
Rails.application.credentials.dig(:minio, :secret_access_key)
Rails.application.credentials.dig(:minio, :endpoint)
```

## Regenerating Credentials

If you've lost `config/master.key` or need to regenerate:

```bash
# Remove old encrypted file
rm config/credentials.yml.enc

# Create new credentials
bin/rails credentials:edit
```

This will:
1. Generate a new `master.key`
2. Create a new `credentials.yml.enc` with `secret_key_base`
3. Display the new master key (save it securely!)

## Current Credentials Structure

The project currently uses:

```yaml
secret_key_base: <auto-generated>
```

Current credentials structure:

```yaml
secret_key_base: <auto-generated>
minio:
  access_key_id: minioadmin
  secret_access_key: minioadmin
  endpoint: http://minio:9000  # Dev: http://minio:9000, Staging: http://minio:9000, Prod: http://minio:9000
```

Future credentials to add:
- `helloasso_token` - For HelloAsso API integration
- `smtp` - Email server configuration
- `aws` - For Active Storage (if using AWS S3 instead of MinIO)

## Security Best Practices

1. **Never commit `config/master.key`**
   - It's in `.gitignore` by default
   - If accidentally committed, rotate credentials immediately

2. **Share master.key securely**
   - Use a password manager
   - Use encrypted channels (Signal, Keybase)
   - Never send via email or chat

3. **Rotate credentials regularly**
   - Especially if team members leave
   - After security incidents
   - When credentials are exposed

4. **Use environment-specific credentials**
   - Development: local `master.key`
   - Production: set via `RAILS_MASTER_KEY` environment variable
   - Staging: separate credentials file

## Docker Environment

In Docker, you can set the master key via environment variable:

```yaml
# docker-compose.yml
environment:
  RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
```

Or mount the key file:

```yaml
volumes:
  - ./config/master.key:/rails/config/master.key:ro
```

## Production Deployment

For production, set `RAILS_MASTER_KEY` as an environment variable:

```bash
export RAILS_MASTER_KEY=$(cat config/master.key)
```

Or use your deployment platform's secrets management (Heroku, AWS Secrets Manager, etc.).

