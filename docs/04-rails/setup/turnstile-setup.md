# üîí Cloudflare Turnstile - Configuration

**Derni√®re mise √† jour** : 2025-12-07  
**Statut** : ‚úÖ **Configur√©**

---

## üìã Vue d'ensemble

Cloudflare Turnstile est un syst√®me de v√©rification anti-bot qui prot√®ge les formulaires d'inscription et de connexion. Le mode "normal" affiche un widget discret et visible, garantissant une meilleure exp√©rience utilisateur.

### Avantages

- ‚úÖ **Widget visible et discret** : Petit widget visible, interaction uniquement si n√©cessaire
- ‚úÖ **Meilleure UX** : L'utilisateur voit toujours la protection en place (contrairement au mode invisible)
- ‚úÖ **Priv√©** : Collecte minimale de donn√©es (conforme RGPD)
- ‚úÖ **Ultra-l√©ger** : Moins de 1KB, impact minimal sur les performances
- ‚úÖ **Gratuit** : 1M requ√™tes/mois gratuites
- ‚úÖ **Flexible** : Personnalisable, design √©pur√©

---

## ‚öôÔ∏è Configuration

### 1. Obtenir les cl√©s Cloudflare Turnstile

1. Se connecter au dashboard Cloudflare : https://dash.cloudflare.com/
2. Aller dans **Security** ‚Üí **Turnstile**
3. Cliquer sur **Add Site**
4. Configurer :
   - **Site Name** : `Grenoble Roller`
   - **Domain** : `grenoble-roller.org` (et `dev-grenoble-roller.flowtech-lab.org` pour dev)
   - **Widget Mode** : `Non-interactive` ou `Managed` (recommand√© pour UX et visibilit√©)
5. R√©cup√©rer :
   - **Site Key** (cl√© publique)
   - **Secret Key** (cl√© priv√©e)

### 2. Configuration dans Rails Credentials (recommand√©)

**Commande pour √©diter les credentials** :

```bash
docker compose -f ops/dev/docker-compose.yml run --rm -it -e EDITOR=nano web bin/rails credentials:edit
```

**Structure YAML compl√®te √† avoir dans les credentials** :

Si vous avez d√©j√† des credentials (minio, smtp, etc.), **ajoutez** la section `turnstile` :

```yaml
secret_key_base: <auto-generated>

# MinIO (si configur√©)
minio:
  access_key_id: minioadmin
  secret_access_key: minioadmin
  endpoint: http://minio:9000

# SMTP (si configur√©)
smtp:
  user_name: no-reply@grenoble-roller.org
  password: votre_mot_de_passe
  address: smtp.ionos.fr
  port: 465
  domain: grenoble-roller.org

# Cloudflare Turnstile (√Ä AJOUTER)
turnstile:
  site_key: votre_site_key_cloudflare
  secret_key: votre_secret_key_cloudflare
```

**Note** : Remplacez `votre_site_key_cloudflare` et `votre_secret_key_cloudflare` par les vraies cl√©s obtenues depuis Cloudflare Dashboard.

### Alternative : Variables d'environnement

Si vous pr√©f√©rez utiliser des variables d'environnement (non recommand√© pour production) :

```bash
# .env
TURNSTILE_SITE_KEY=your_site_key_here
TURNSTILE_SECRET_KEY=your_secret_key_here
```

### 3. Impl√©mentation

Turnstile est int√©gr√© **manuellement** (pas de gem disponible sur RubyGems) :

- **Concern** : `app/controllers/concerns/turnstile_verifiable.rb` - V√©rification c√¥t√© serveur
- **JavaScript** : Script Cloudflare directement int√©gr√© dans les vues
- **V√©rification serveur** : Requ√™te HTTP √† l'API Cloudflare

**Aucune installation de gem n√©cessaire** - Tout est d√©j√† en place dans le code.

---

## üöÄ Int√©gration

### Concern TurnstileVerifiable

Le concern `TurnstileVerifiable` est inclus dans `ApplicationController`, donc disponible dans tous les contr√¥leurs :

```ruby
# app/controllers/application_controller.rb
include TurnstileVerifiable
```

**M√©thode disponible** : `verify_turnstile` - Retourne `true` si v√©rification r√©ussie, `false` sinon.

### Contr√¥leurs

#### RegistrationsController
- ‚úÖ V√©rification Turnstile avant cr√©ation du compte via `verify_turnstile`
- ‚úÖ Message d'erreur si v√©rification √©choue

#### SessionsController
- ‚úÖ V√©rification Turnstile avant authentification via `verify_turnstile`
- ‚úÖ Message d'erreur si v√©rification √©choue

### Vues

#### Formulaire d'inscription (`app/views/devise/registrations/new.html.erb`)
- ‚úÖ Widget Turnstile invisible int√©gr√©
- ‚úÖ Script JavaScript pour gestion automatique

#### Formulaire de connexion (`app/views/devise/sessions/new.html.erb`)
- ‚úÖ Widget Turnstile invisible int√©gr√©
- ‚úÖ Script JavaScript pour gestion automatique

---

## üß™ Tests

### Mode Test

En environnement `test`, Turnstile est automatiquement d√©sactiv√© (skip verification) pour permettre les tests automatis√©s.

```ruby
# app/controllers/concerns/turnstile_verifiable.rb
def verify_turnstile
  return true if Rails.env.test? # Skip en test
  # ... v√©rification
end
```

### Tests Manuels

1. **D√©sactiver temporairement Turnstile** (si besoin de tester sans) :
   - Commenter la v√©rification dans les contr√¥leurs
   - OU utiliser des cl√©s de test Cloudflare

2. **Tester avec cl√©s r√©elles** :
   - Configurer les variables d'environnement
   - Tester l'inscription et la connexion
   - V√©rifier que la v√©rification fonctionne (dans les DevTools, onglet Network)

---

## üîí S√©curit√©

### Protection Multi-Couches

1. **Turnstile** : V√©rification invisible anti-bot
2. **Rate Limiting (Rack::Attack)** : 
   - 5 tentatives de connexion / 15 min par IP
   - 3 inscriptions / heure par IP
3. **Confirmation Email** : Validation de l'adresse email
4. **Validation Serveur** : V√©rification c√¥t√© serveur de tous les param√®tres

### Conformit√© RGPD

- ‚úÖ Cloudflare Turnstile est conforme RGPD
- ‚úÖ Collecte minimale de donn√©es
- ‚úÖ Pas de tracking utilisateur
- ‚úÖ Donn√©es h√©berg√©es en Europe (option disponible)

---

## üìä Monitoring

### Logs

Les √©checs de v√©rification Turnstile sont logg√©s automatiquement. V√©rifier les logs :

```bash
docker compose -f ops/dev/docker-compose.yml logs web | grep -i turnstile
```

### Dashboard Cloudflare

Le dashboard Cloudflare Turnstile permet de voir :
- Nombre de v√©rifications
- Taux de succ√®s/√©chec
- Statistiques par domaine

---

## ‚úÖ Comment v√©rifier que Turnstile fonctionne

### Mode invisible = Rien de visible !

En mode **invisible**, Turnstile fonctionne **en arri√®re-plan** sans aucun √©l√©ment visible pour l'utilisateur. C'est normal !

### M√©thodes de v√©rification

#### 1. V√©rifier dans les DevTools du navigateur (recommand√©)

**√âtapes** :
1. Ouvrir la page de connexion/inscription
2. Ouvrir les DevTools (F12 ou Cmd+Option+I)
3. **Onglet Network** :
   - Filtrer par `turnstile` ou `cloudflare`
   - Vous devriez voir une requ√™te vers `challenges.cloudflare.com/turnstile/v0/api.js` (chargement du script)
   - Quand vous soumettez le formulaire, une requ√™te vers `/siteverify` devrait appara√Ætre
4. **Onglet Console** :
   - Pas d'erreurs JavaScript li√©es √† Turnstile
   - Si vous voyez `turnstile` dans les variables globales, c'est bon signe

#### 2. V√©rifier les logs Rails

```bash
docker compose -f ops/dev/docker-compose.yml logs web | grep -i turnstile
```

**Logs √† rechercher** :
- `Turnstile verification failed` = √âchec de v√©rification (normal si cl√©s incorrectes)
- `Turnstile verification error` = Erreur technique
- Pas de logs Turnstile = Turnstile n'est peut-√™tre pas d√©clench√©

#### 3. Test simple : Tenter une connexion sans cl√© Turnstile

**Sans cl√© Turnstile configur√©e** :
- Le formulaire se soumet normalement (pas de v√©rification)
- En d√©veloppement, c'est normal (skip si cl√© manquante)

**Avec cl√© Turnstile configur√©e** :
- Le formulaire attend la v√©rification Turnstile
- Si v√©rification √©choue ‚Üí message "V√©rification de s√©curit√© √©chou√©e"

#### 4. Tester avec des cl√©s de test Cloudflare (mode visible temporaire)

Pour **voir** Turnstile en action, changez temporairement en mode **visible** :

Dans la vue, modifiez `data-size="invisible"` en `data-size="normal"` :

```erb
<div class="cf-turnstile" 
     data-sitekey="<%= turnstile_site_key %>"
     data-theme="light"
     data-size="normal"  <!-- Chang√© de "invisible" √† "normal" -->
     data-callback="onTurnstileLoginSuccess"
     data-error-callback="onTurnstileError">
</div>
```

Avec les cl√©s de test Cloudflare :
- Site Key : `1x00000000000000000000AA`
- Secret Key : `1x0000000000000000000000000000000AA`

Vous verrez alors le widget Turnstile visible.

#### 5. V√©rifier dans le code source HTML

Ouvrir le code source de la page de connexion et rechercher :
```html
<div class="cf-turnstile" data-sitekey="...">
```
Si cette div est pr√©sente avec une `site_key` valide, le widget est bien charg√©.

---

## üîç Comment V√©rifier que Turnstile Fonctionne

> ‚ö†Ô∏è **Important** : En mode invisible, **rien n'est visible** pour l'utilisateur ! Turnstile fonctionne compl√®tement en arri√®re-plan.

**Voir le guide complet de v√©rification** : [`turnstile-test-verification.md`](turnstile-test-verification.md)

### M√©thodes rapides

1. **DevTools Navigateur** (F12 ‚Üí Network) : V√©rifier les requ√™tes vers `cloudflare.com/turnstile`
2. **Logs Rails** : `docker compose logs web | grep -i turnstile`
3. **V√©rifier les cl√©s** : `bin/rails runner "puts Rails.application.credentials.dig(:turnstile, :site_key)"`

---

## üõ†Ô∏è D√©pannage

### Le widget ne se charge pas

**Sympt√¥mes** : Pas de requ√™te vers Cloudflare dans Network tab

**V√©rifications** :
1. V√©rifier que `turnstile_site_key` est pr√©sent dans les credentials
   ```bash
   docker compose -f ops/dev/docker-compose.yml run --rm web bin/rails runner "puts Rails.application.credentials.dig(:turnstile, :site_key) || 'CL√â MANQUANTE'"
   ```
2. V√©rifier la console JavaScript pour erreurs
3. V√©rifier que le script Cloudflare est charg√© (Network tab ‚Üí chercher `api.js`)

### V√©rification √©choue toujours

**Sympt√¥mes** : Message "V√©rification de s√©curit√© √©chou√©e"

**V√©rifications** :
1. V√©rifier que `TURNSTILE_SECRET_KEY` est configur√© correctement
   ```bash
   docker compose -f ops/dev/docker-compose.yml run --rm web bin/rails runner "puts Rails.application.credentials.dig(:turnstile, :secret_key).present? ? '‚úÖ Secret Key OK' : '‚ùå Secret Key manquante'"
   ```
2. V√©rifier les logs Rails pour erreurs d√©taill√©es :
   ```bash
   docker compose -f ops/dev/docker-compose.yml logs web | grep -i "turnstile\|verification"
   ```
3. V√©rifier que le domaine est bien configur√© dans Cloudflare Dashboard
4. V√©rifier que les cl√©s correspondent (site key et secret key du m√™me site Turnstile)

### En d√©veloppement local

Pour tester en d√©veloppement local (localhost), il faut :
1. Ajouter `localhost` ou `127.0.0.1` dans les domaines autoris√©s Cloudflare
2. OU utiliser les cl√©s de test Cloudflare :
   - Site Key : `1x00000000000000000000AA`
   - Secret Key : `1x0000000000000000000000000000000AA`
3. OU laisser vide (en dev, Turnstile est skip si cl√© manquante)

---

## üìö Documentation

- **Cloudflare Turnstile** : https://developers.cloudflare.com/turnstile/
- **Gem turnstile-rails** : https://github.com/patleb/turnstile-rails
- **Best Practices** : https://developers.cloudflare.com/turnstile/get-started/server-side-validation/

---

## ‚úÖ Checklist de D√©ploiement

### Pr√©-Production

- [ ] Cr√©er un site Turnstile dans Cloudflare dashboard
- [ ] Configurer les cl√©s dans Rails credentials (ou variables d'environnement)
- [ ] Tester l'inscription avec Turnstile
- [ ] Tester la connexion avec Turnstile
- [ ] V√©rifier les logs pour erreurs

### Production

- [ ] Configurer le domaine de production dans Cloudflare Turnstile
- [ ] Utiliser Rails credentials pour stocker les cl√©s secr√®tes
- [ ] V√©rifier que le rate limiting fonctionne correctement
- [ ] Monitorer les logs pour √©checs de v√©rification

---

---

## ‚ö†Ô∏è Correction Importante - Blocage Authentification

**Probl√®me identifi√© (2025-12-08)** : Si Turnstile √©choue, l'authentification Devise se faisait quand m√™me.

**Solution appliqu√©e** : Blocage complet AVANT l'appel √† `super` dans les contr√¥leurs.

**Fichiers modifi√©s** :
- `app/controllers/sessions_controller.rb` : Blocage avec `render :new` et `return false`
- `app/controllers/registrations_controller.rb` : Blocage avec `render :new` et `return`

**Test de validation** : Voir [`turnstile-test-guide.md`](turnstile-test-guide.md)

---

**Version** : 1.2  
**Date de cr√©ation** : 2025-12-07  
**Derni√®re mise √† jour** : 2025-12-08  
**Statut** : ‚úÖ Op√©rationnel (correction blocage appliqu√©e)

