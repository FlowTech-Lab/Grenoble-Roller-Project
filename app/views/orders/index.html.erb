<% 
  pending_orders = @orders.select { |o| o.status.downcase.in?(%w[pending en\ attente]) }
  preparation_orders = @orders.select { |o| o.status.downcase.in?(%w[preparation en\ pr√©paration preparing]) }
  sent_orders = @orders.select { |o| o.status.downcase.in?(%w[sent envoy√© shipped finished termin√© paid pay√©]) }
  cancelled_orders = @orders.select { |o| o.status.downcase.in?(%w[cancelled annul√© canceled]) }
  total_spent = sent_orders.sum(&:total_cents) / 100.0
%>

<div class="container py-4">
  <!-- HERO SECTION -->
  <div class="hero-orders">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h1 class="h2 mb-2">
          <i class="bi bi-box-seam me-2 fs-2"></i>
          Mes commandes
        </h1>
        <p class="mb-2 opacity-75" style="font-style: italic;">
          Suivez l'aventure de vos achats
        </p>
        <% if @orders.any? %>
          <div class="d-flex align-items-center gap-3 flex-wrap mt-3">
            <span class="badge bg-white text-dark px-3 py-2" style="font-size: 0.875rem;">
              <i class="bi bi-box me-1"></i>
              <%= @orders.count %> commande<%= 's' if @orders.count != 1 %>
            </span>
            <% if pending_orders.any? %>
              <span class="badge bg-white text-dark px-3 py-2" style="font-size: 0.875rem;">
                <i class="bi bi-hourglass-split text-warning me-1"></i>
                <%= pending_orders.count %> en attente
              </span>
            <% end %>
            <% if sent_orders.any? %>
              <span class="badge bg-white text-dark px-3 py-2" style="font-size: 0.875rem;">
                <i class="bi bi-truck text-success me-1"></i>
                <%= sent_orders.count %> exp√©di√©e<%= 's' if sent_orders.count != 1 %>
              </span>
            <% end %>
            <% if total_spent > 0 %>
              <span class="badge bg-white text-dark px-3 py-2" style="font-size: 0.875rem;">
                <i class="bi bi-currency-euro text-primary me-1"></i>
                <%= number_to_currency(total_spent, unit: "‚Ç¨", format: "%n %u") %> total
              </span>
            <% end %>
          </div>
        <% end %>
      </div>
      <% if @orders.empty? %>
        <div class="mt-3 mt-md-0">
          <%= link_to shop_path, class: "btn btn-light btn-lg" do %>
            <i class="bi bi-bag me-2"></i>D√©couvrir la boutique
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- LAYOUT 2 COLONNES -->
  <div class="row">
    <!-- SIDEBAR (COL-4) -->
    <div class="col-12 col-lg-4 mb-4 mb-lg-0">
      <%= render 'sidebar', 
          pending_orders: pending_orders, 
          sent_orders: sent_orders,
          preparation_orders: preparation_orders,
          cancelled_orders: cancelled_orders,
          total_spent: total_spent %>
    </div>

    <!-- CONTENU PRINCIPAL (COL-8) -->
    <div class="col-12 col-lg-8">
      <% if @orders.empty? %>
        <!-- EMPTY STATE -->
        <div class="text-center py-5">
          <div style="font-size: 2.5rem; margin-bottom: 1.5rem;">üõçÔ∏è</div>
          <h2 class="h5 fw-bold mb-2">Aucune commande</h2>
          <p class="text-muted small mb-4">D√©couvrez notre s√©lection de produits</p>
          <%= link_to "Voir la boutique ‚Üí", shop_path, class: "btn btn-primary" %>
        </div>
      <% else %>
        <!-- EN ATTENTE -->
        <% if pending_orders.any? %>
          <div id="pending" class="mb-4">
            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
              <i class="bi bi-hourglass-split me-2 fs-5" style="color: #ffc107;"></i>
              <h3 class="h5 mb-0">En attente de paiement</h3>
              <span class="badge bg-warning text-dark ms-2"><%= pending_orders.count %></span>
            </div>
            
            <div class="d-flex flex-column gap-2">
              <% pending_orders.each do |order| %>
                <%= render 'order_card_compact', order: order %>
              <% end %>
            </div>
          </div>
          <hr class="my-4">
        <% end %>

        <!-- EN PR√âPARATION -->
        <% if preparation_orders.any? %>
          <div id="preparation" class="mb-4">
            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
              <i class="bi bi-gear me-2 fs-5" style="color: #17a2b8;"></i>
              <h3 class="h5 mb-0">En pr√©paration</h3>
              <span class="badge bg-info text-white ms-2"><%= preparation_orders.count %></span>
            </div>
            
            <div class="d-flex flex-column gap-2">
              <% preparation_orders.each do |order| %>
                <%= render 'order_card_compact', order: order %>
              <% end %>
            </div>
          </div>
          <hr class="my-4">
        <% end %>

        <!-- EXP√âDI√âES -->
        <% if sent_orders.any? %>
          <div id="sent" class="mb-4">
            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
              <i class="bi bi-truck me-2 fs-5" style="color: #28a745;"></i>
              <h3 class="h5 mb-0">Exp√©di√©es / Termin√©es</h3>
              <span class="badge bg-success ms-2"><%= sent_orders.count %></span>
            </div>
            
            <div class="d-flex flex-column gap-2">
              <% sent_orders.each do |order| %>
                <%= render 'order_card_compact', order: order %>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- ANNUL√âES : Collapsible -->
        <% if cancelled_orders.any? %>
          <div id="cancelled" class="mt-4">
            <button class="order-section-toggle d-flex align-items-center w-100 text-start" 
                    type="button" data-bs-toggle="collapse" data-bs-target="#cancelledList"
                    aria-expanded="false" aria-controls="cancelledList">
              <i class="bi bi-chevron-down order-toggle-chevron me-2"></i>
              <i class="bi bi-x-circle me-2 text-danger"></i>
              <h3 class="h6 mb-0">Annul√©es</h3>
              <span class="badge bg-danger ms-2"><%= cancelled_orders.count %></span>
            </button>
            
            <div id="cancelledList" class="collapse mt-2">
              <div class="d-flex flex-column gap-2">
                <% cancelled_orders.each do |order| %>
                  <div class="card border-0 shadow-sm" style="border-left: 3px solid #dc3545;">
                    <div class="card-body py-2">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="small">
                          <strong>Commande #<%= order.id %></strong>
                          <br>
                          <span class="text-muted">
                            <%= l(order.created_at, format: "%d %b %Y") %>
                            ‚Ä¢ <%= order.order_items.sum(:quantity) %> article<%= 's' if order.order_items.sum(:quantity) != 1 %>
                          </span>
                        </div>
                        <strong class="text-danger">
                          <%= number_to_currency(order.total_cents / 100.0, unit: "‚Ç¨", format: "%n %u") %>
                        </strong>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
