<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="display-5 text-liquid-primary-white mb-2">
        <i class="bi bi-receipt me-2"></i>Checkout
      </h1>
      <p class="text-muted">Vérifiez votre commande avant de finaliser</p>
    </div>
  </div>

  <div class="row">
    <div class="col-12 col-lg-8 mx-auto">
      <div class="card card-liquid rounded-liquid shadow-liquid">
        <div class="card-body p-4">
          <% if @cart_items.empty? %>
            <div class="empty-state">
              <i class="bi bi-bag"></i>
              <p class="mb-3">Votre panier est vide.</p>
              <%= link_to shop_path, class: "btn btn-liquid-primary" do %>
                <i class="bi bi-arrow-left me-1"></i>Retour à la boutique
              <% end %>
            </div>
          <% else %>
            <!-- Order items list -->
            <div class="mb-4">
              <h3 class="h5 text-liquid-primary mb-3">
                <i class="bi bi-list-ul me-2"></i>Articles de votre commande
              </h3>
              <% @cart_items.each do |ci| %>
                <div class="cart-item">
                  <div class="cart-item-image">
                    <%= image_tag ci[:product].image_url, alt: ci[:product].name, loading: "lazy" %>
                  </div>
                  
                  <div class="cart-item-content">
                    <div class="cart-item-info">
                      <p class="cart-item-title mb-1"><%= ci[:product].name %></p>
                      <div class="d-flex align-items-center gap-2">
                        <p class="small text-muted mb-0"><%= ci[:variant].sku %></p>
                        <span class="small text-muted">•</span>
                        <p class="small text-muted mb-0"><%= format_price(ci[:unit_price_cents]) %> / u</p>
                      </div>
                    </div>
                    
                    <div class="cart-item-qty">
                      <div class="d-flex align-items-center gap-2">
                        <span class="badge badge-liquid-primary">Qté: <%= ci[:quantity] %></span>
                      </div>
                    </div>
                    
                    <div class="cart-item-price">
                      <div class="text-end">
                        <strong><%= format_price(ci[:subtotal_cents]) %></strong>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>

            <!-- Donation section -->
            <div class="card card-liquid rounded-liquid mb-3" aria-labelledby="donationTitle">
              <div class="card-body p-4">
                <h3 id="donationTitle" class="h5 text-liquid-primary mb-3">
                  <i class="bi bi-heart me-2"></i>Souhaitez-vous ajouter un don à Grenoble Roller ?
                </h3>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="donation" id="don0" value="0" checked onchange="setDonation(0)">
                    <label class="form-check-label" for="don0">Pas de don</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="donation" id="don2" value="2" onchange="setDonation(2)">
                    <label class="form-check-label" for="don2">2 €</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="donation" id="don3" value="3" onchange="setDonation(3)">
                    <label class="form-check-label" for="don3">3 €</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="donation" id="don5" value="5" onchange="setDonation(5)">
                    <label class="form-check-label" for="don5">5 €</label>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="donation" id="donCustom" value="custom" onchange="enableCustomDonation()">
                      <label class="form-check-label" for="donCustom">Choisir un montant</label>
                    </div>
                    <input type="number" min="0" step="0.5" class="form-control form-control-liquid" id="donationCustomInput" placeholder="0,00" style="max-width: 140px;" disabled oninput="setDonationCustom(this.value)">
                  </div>
                </div>
              </div>
            </div>

            <!-- Order summary -->
            <div class="border-top pt-3">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <%= link_to cart_path, class: "btn btn-outline-secondary btn-sm" do %>
                  <i class="bi bi-arrow-left me-1"></i>Retour au panier
                <% end %>
                <div class="text-end">
                  <div class="small text-muted mb-1">Sous-total: <%= format_price(@total_cents) %></div>
                  <div class="small text-muted mb-1">Don: <span id="donationDisplay">0€</span></div>
                  <strong class="fs-5">Total: <span id="orderTotalWithDonation"><%= format_price(@total_cents) %></span></strong>
                </div>
              </div>
            </div>

            <!-- Action buttons -->
            <div class="d-flex gap-2 mt-4">
              <%= link_to cart_path, class: "btn btn-outline-primary flex-fill" do %>
                <i class="bi bi-arrow-left me-1"></i>Modifier le panier
              <% end %>
              <%= button_to orders_path, method: :post, class: "btn btn-liquid-primary flex-fill", data: { turbo: false } do %>
                <i class="bi bi-check-circle me-2"></i>Payer Via HelloAsso*
              <% end %>
            </div>

            <!-- HelloAsso info box -->
            <div class="card card-liquid rounded-liquid mt-3 helloasso-info">
              <div class="card-body p-3">
                <p class="small mb-0">
                  <i class="bi bi-info-circle me-1 text-liquid-primary"></i>
                  <strong>HelloAsso</strong> est une entreprise sociale et solidaire, qui fournit gratuitement ses technologies de paiement à l'organisme Grenoble Roller. Une contribution au fonctionnement de HelloAsso, modifiable et facultative, vous sera proposée avant la validation de votre paiement.
                </p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    // Utiliser un namespace pour éviter les conflits et les redéclarations
    if (!window.orderDonation) {
      window.orderDonation = {
        donationAmount: 0,
        cartSubtotal: <%= @total_cents %> / 100.0,
        
        formatPrice: function(amount) {
          const formatted = amount === Math.floor(amount) ? amount.toString() : amount.toFixed(2);
          return formatted.replace('.', ',') + '€';
        },
        
        setDonation: function(amount) {
          window.orderDonation.donationAmount = Number(amount) || 0;
          const customInput = document.getElementById('donationCustomInput');
          if (customInput) customInput.disabled = true;
          window.orderDonation.updateDonationDisplay();
        },
        
        enableCustomDonation: function() {
          const customInput = document.getElementById('donationCustomInput');
          if (customInput) {
            customInput.disabled = false;
            customInput.focus();
          }
        },
        
        setDonationCustom: function(value) {
          const val = parseFloat(String(value).replace(',', '.'));
          window.orderDonation.donationAmount = Number.isFinite(val) ? Math.max(0, val) : 0;
          window.orderDonation.updateDonationDisplay();
        },
        
        updateDonationDisplay: function() {
          const donationDisplay = document.getElementById('donationDisplay');
          const orderTotalWithDonation = document.getElementById('orderTotalWithDonation');
          
          if (donationDisplay) {
            donationDisplay.textContent = window.orderDonation.formatPrice(window.orderDonation.donationAmount);
          }
          
          if (orderTotalWithDonation) {
            const total = window.orderDonation.cartSubtotal + window.orderDonation.donationAmount;
            orderTotalWithDonation.textContent = window.orderDonation.formatPrice(total);
          }
        },
        
        init: function() {
          // Réinitialiser donationAmount à 0 au chargement de la page
          window.orderDonation.donationAmount = 0;
          window.orderDonation.updateDonationDisplay();
        }
      };
      
      // Expose functions globally pour compatibilité avec les attributs HTML
      window.setDonation = window.orderDonation.setDonation;
      window.enableCustomDonation = window.orderDonation.enableCustomDonation;
      window.setDonationCustom = window.orderDonation.setDonationCustom;
    } else {
      // Mettre à jour cartSubtotal si la page est rechargée
      window.orderDonation.cartSubtotal = <%= @total_cents %> / 100.0;
    }
    
    // Initialiser au chargement
    function initDonation() {
      window.orderDonation.init();
    }
    
    // Écouter DOMContentLoaded et turbo:load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDonation);
    } else {
      initDonation();
    }
    
    document.addEventListener('turbo:load', initDonation);
  })();
</script>
