<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="card card-liquid rounded-liquid shadow-liquid">
        <div class="card-body p-4">
          
          <!-- ALERTE PAIEMENT PENDING avec bouton Rafraîchir + Auto-poll -->
          <% 
            order_status = @order.status.downcase
            is_pending = ['pending', 'en attente'].include?(order_status)
            is_cancelled = ['cancelled', 'annulé', 'canceled'].include?(order_status)
            # Afficher l'alerte si : commande pending + (payment pending helloasso OU pas de payment) + non annulée
            show_payment_alert = is_pending && 
                                 !is_cancelled && 
                                 (@order.payment.nil? || 
                                  (@order.payment.status == 'pending' && @order.payment.provider == 'helloasso'))
          %>
          <% if show_payment_alert %>
            <div class="alert alert-warning mb-4" role="alert">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                  <strong>⏳ Paiement en attente</strong>
                  <p class="small mb-0">Vérification automatique en cours...</p>
                </div>
                <%= button_to check_payment_order_path(@order),
                    method: :post,
                    class: "btn btn-sm btn-warning",
                    data: { turbo: true },
                    aria: { label: "Vérifier le statut du paiement maintenant" } do %>
                  <i class="bi bi-arrow-clockwise me-1" aria-hidden="true"></i>Vérifier maintenant
                <% end %>
              </div>
            </div>
            
            <!-- Auto-poll JS discret en arrière-plan (1 min max) -->
            <script>
              (function() {
                let attempts = 0;
                const maxAttempts = 12; // 12 * 5s = 1 min (plus fréquent)
                let isPolling = true;
                
                const poll = async () => {
                  if (!isPolling) return;
                  
                  try {
                    const response = await fetch('<%= payment_status_order_path(@order) %>', {
                      method: 'GET',
                      headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                      },
                      credentials: 'same-origin',
                      cache: 'no-cache'
                    });
                    
                    if (!response.ok) {
                      console.warn('[PaymentPoll] Failed to fetch status:', response.status);
                      if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 5000); // Réessayer après 5s
                      }
                      return;
                    }
                    
                    const data = await response.json();
                    const status = data.status;
                    
                    console.log('[PaymentPoll] Status check #' + attempts + ':', status);
                    
                    if (status !== 'pending' && status !== 'unknown') {
                      // Statut a changé → recharger la page
                      console.log('[PaymentPoll] Status changed to:', status, '- Reloading page');
                      isPolling = false;
                      window.location.reload();
                    } else if (attempts < maxAttempts) {
                      // Continuer le polling
                      attempts++;
                      setTimeout(poll, 5000); // 5 secondes (plus fréquent)
                    } else {
                      console.log('[PaymentPoll] Max attempts reached, stopping');
                      isPolling = false;
                    }
                  } catch (error) {
                    console.error('[PaymentPoll] Error:', error);
                    if (attempts < maxAttempts) {
                      attempts++;
                      setTimeout(poll, 5000);
                    }
                  }
                };
                
                // Démarrer le polling après 1 seconde (laisser le temps à la page de charger)
                setTimeout(poll, 1000);
              })();
            </script>
          <% end %>

          <!-- HEADER : Titre + Status Badge (séparés) -->
          <div class="mb-3 pb-3 border-bottom">
            <!-- Titre principal -->
            <h1 class="h5 mb-3">
              <i class="bi bi-receipt-cutoff text-liquid-primary me-2" aria-hidden="true"></i>
              Commande #<%= @order.id %>
            </h1>
            
            <!-- Status badge (séparé, avec icône + texte) -->
            <% 
              status_config = case @order.status.downcase
                when 'pending', 'en attente'
                  { 
                    badge_class: 'bg-warning text-dark', 
                    icon: 'bi-hourglass-split', 
                    label: 'En attente',
                    aria_label: 'Statut: En attente de paiement'
                  }
                when 'preparation', 'en préparation', 'preparing'
                  { 
                    badge_class: 'bg-info text-white', 
                    icon: 'bi-gear', 
                    label: 'En préparation',
                    aria_label: 'Statut: Commande en préparation'
                  }
                when 'paid', 'payé'
                  { 
                    badge_class: 'bg-success text-white', 
                    icon: 'bi-check-circle', 
                    label: 'Payée',
                    aria_label: 'Statut: Commande payée'
                  }
                when 'sent', 'envoyé', 'shipped', 'finished', 'terminé'
                  { 
                    badge_class: 'bg-success text-white', 
                    icon: 'bi-truck', 
                    label: 'Expédiée',
                    aria_label: 'Statut: Commande expédiée'
                  }
                when 'cancelled', 'annulé', 'canceled'
                  { 
                    badge_class: 'bg-danger text-white', 
                    icon: 'bi-x-circle', 
                    label: 'Annulée',
                    aria_label: 'Statut: Commande annulée'
                  }
                else
                  # Fallback : traduire le statut en français si possible
                  fallback_label = case @order.status.downcase
                    when 'failed', 'échoué'
                      'Échouée'
                    when 'refunded', 'remboursé'
                      'Remboursée'
                    when 'refund_requested', 'remboursement_demandé'
                      'Remboursement demandé'
                    else
                      @order.status.capitalize
                  end
                  { 
                    badge_class: 'bg-secondary text-white', 
                    icon: 'bi-question-circle', 
                    label: fallback_label,
                    aria_label: "Statut: #{fallback_label}"
                  }
              end
            %>
            <div class="d-flex align-items-center gap-2">
              <span class="badge <%= status_config[:badge_class] %> px-3 py-2" 
                    aria-label="<%= status_config[:aria_label] %>">
                <i class="bi <%= status_config[:icon] %> me-1" aria-hidden="true"></i>
                <%= status_config[:label] %>
              </span>
            </div>
          </div>

          <!-- INFOS RAPIDES (Date, Articles, Total) -->
          <div class="d-flex flex-wrap align-items-center gap-3 small text-muted mb-4 pb-3 border-bottom">
            <div class="d-flex align-items-center gap-1">
              <i class="bi bi-calendar" aria-hidden="true"></i>
              <span><%= l(@order.created_at, format: :short) %></span>
            </div>
            <span aria-hidden="true">•</span>
            <div class="d-flex align-items-center gap-1">
              <i class="bi bi-box-seam" aria-hidden="true"></i>
              <span><%= @order.order_items.sum(:quantity) %> article(s)</span>
            </div>
            <span class="ms-auto fw-bold text-liquid-primary">
              <%= format_price(@order.total_cents) %>
            </span>
          </div>

          <!-- ARTICLES -->
          <div class="mb-4">
            <h2 class="h6 text-liquid-primary mb-3">
              <i class="bi bi-list-ul me-2" aria-hidden="true"></i>Articles
            </h2>
            
            <div class="mb-3">
              <% @order.order_items.each_with_index do |item, index| %>
                <div class="cart-item mb-3 pb-3 <%= 'border-bottom' unless index == @order.order_items.count - 1 %>">
                  <div class="cart-item-image">
                    <% if item.variant.product.image.attached? %>
                      <%= image_tag item.variant.product.image, alt: item.variant.product.name, loading: "lazy", class: "img-fluid", style: "width: 80px; height: 80px; object-fit: cover; border-radius: 4px;" %>
                    <% elsif item.variant.product.image_url.present? %>
                      <%= image_tag item.variant.product.image_url, alt: item.variant.product.name, loading: "lazy", class: "img-fluid", style: "width: 80px; height: 80px; object-fit: cover; border-radius: 4px;" %>
                    <% end %>
                  </div>
                  
                  <div class="cart-item-content">
                    <div class="cart-item-info">
                      <p class="cart-item-title mb-1 fw-semibold"><%= item.variant.product.name %></p>
                      <div class="d-flex align-items-center gap-2">
                        <p class="small text-muted mb-0"><%= item.variant.sku %></p>
                        <span class="small text-muted" aria-hidden="true">•</span>
                        <p class="small text-muted mb-0"><%= format_price(item.unit_price_cents) %> / u</p>
                      </div>
                    </div>
                    
                    <div class="cart-item-qty">
                      <span class="badge badge-liquid-primary">Qté: <%= item.quantity %></span>
                    </div>
                    
                    <div class="cart-item-price">
                      <div class="text-end">
                        <strong><%= format_price(item.unit_price_cents * item.quantity) %></strong>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>

            <!-- Total -->
            <div class="pt-2 border-top">
              <% 
                # Calculer le sous-total (articles uniquement, sans don)
                articles_subtotal = @order.order_items.sum { |item| item.unit_price_cents * item.quantity }
                
                # Récupérer le don depuis la colonne, ou le calculer à partir de la différence
                donation_cents = @order.donation_cents || 0
                
                # Pour les anciennes commandes (avant migration), calculer le don à partir de la différence
                if donation_cents == 0 && @order.total_cents > articles_subtotal
                  donation_cents = @order.total_cents - articles_subtotal
                end
              %>
              
              <!-- Sous-total articles -->
              <div class="d-flex justify-content-between align-items-center mt-2 mb-2">
                <span class="text-muted">Sous-total:</span>
                <span class="text-muted"><%= format_price(articles_subtotal) %></span>
              </div>
              
              <!-- Don (si présent) -->
              <% if donation_cents > 0 %>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-muted">
                    <i class="bi bi-heart text-danger me-1" aria-hidden="true"></i>Don à l'association:
                  </span>
                  <span class="text-muted"><%= format_price(donation_cents) %></span>
                </div>
              <% end %>
              
              <!-- Total -->
              <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                <strong>Total:</strong>
                <strong class="text-liquid-primary fs-5"><%= format_price(@order.total_cents) %></strong>
              </div>
            </div>
          </div>

          <!-- ACTIONS CONTEXTUELLES (Une principale + secondaires) -->
          <div class="pt-3 border-top">
            <% 
              # Déterminer l'action principale selon le contexte
              order_status = @order.status.downcase
              is_pending = ['pending', 'en attente'].include?(order_status)
              is_cancelled = ['cancelled', 'annulé', 'canceled'].include?(order_status)
              # Afficher le bouton Payer si : commande pending + (payment pending helloasso OU pas de payment) + non annulée
              is_pending_payment = is_pending && 
                                   !is_cancelled && 
                                   (@order.payment.nil? || 
                                    (@order.payment.status == "pending" && @order.payment.provider == "helloasso"))
              is_preparation = ['preparation', 'en préparation', 'preparing'].include?(order_status)
              is_cancellable = is_pending || is_preparation
            %>
            
            <!-- Action principale -->
            <div class="mb-3">
              <% if is_pending_payment %>
                <!-- Payer (si paiement pending) -->
                <%= button_to pay_order_path(@order),
                    method: :post,
                    class: "btn btn-warning w-100 w-md-auto",
                    data: { turbo: false },
                    aria: { label: "Finaliser le paiement de la commande ##{@order.id}" } do %>
                  <i class="bi bi-credit-card me-2" aria-hidden="true"></i>Finaliser le paiement
                <% end %>
              <% elsif @order.status.downcase == 'paid' || @order.status.downcase == 'payé' %>
                <!-- Paiement confirmé (disabled) -->
                <button type="button" class="btn btn-success w-100 w-md-auto" disabled>
                  <i class="bi bi-check-circle me-2" aria-hidden="true"></i>Paiement confirmé
                </button>
              <% elsif is_preparation %>
                <!-- Préparation en cours (disabled) -->
                <button type="button" class="btn btn-info w-100 w-md-auto" disabled>
                  <i class="bi bi-gear me-2" aria-hidden="true"></i>Préparation en cours
                </button>
              <% elsif ['sent', 'envoyé', 'shipped'].include?(@order.status.downcase) %>
                <!-- Colis en route (disabled) -->
                <button type="button" class="btn btn-success w-100 w-md-auto" disabled>
                  <i class="bi bi-truck me-2" aria-hidden="true"></i>Colis en route
                </button>
              <% elsif ['cancelled', 'annulé', 'canceled'].include?(@order.status.downcase) %>
                <!-- Commande annulée (disabled) -->
                <button type="button" class="btn btn-danger w-100 w-md-auto" disabled>
                  <i class="bi bi-x-circle me-2" aria-hidden="true"></i>Commande annulée
                </button>
              <% end %>
            </div>

            <!-- Actions secondaires -->
            <div class="d-flex gap-2 flex-wrap">
              <%= link_to orders_path, 
                  class: "btn btn-outline-primary btn-sm",
                  aria: { label: "Retour à la liste des commandes" } do %>
                <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>Retour
              <% end %>
              
              <%= link_to shop_path, 
                  class: "btn btn-outline-primary btn-sm",
                  aria: { label: "Retour à la boutique" } do %>
                <i class="bi bi-bag me-1" aria-hidden="true"></i>Boutique
              <% end %>

              <!-- Annuler (en dropdown si cancellable) -->
              <% if is_cancellable %>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                          type="button" 
                          id="orderActionsDropdown" 
                          data-bs-toggle="dropdown" 
                          aria-expanded="false"
                          aria-label="Plus d'actions pour la commande ##{@order.id}">
                    <i class="bi bi-three-dots-vertical me-1" aria-hidden="true"></i>Plus d'actions
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="orderActionsDropdown">
                    <li>
                      <%= button_to cancel_order_path(@order), 
                          method: :patch,
                          class: "dropdown-item text-danger",
                          form: { 
                            data: { 
                              confirm: "Êtes-vous sûr(e) de vouloir annuler cette commande ? Cette action est irréversible",
                              turbo_confirm: "Êtes-vous sûr(e) de vouloir annuler cette commande ? Cette action est irréversible"
                            } 
                          },
                          aria: { label: "Annuler la commande ##{@order.id}" } do %>
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>Annuler cette commande
                      <% end %>
                    </li>
                  </ul>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>