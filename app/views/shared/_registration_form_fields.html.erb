<%# 
  Partial réutilisable pour les champs d'inscription aux initiations/événements
  Variables locales attendues:
  - form: l'objet form (form_with)
  - event: l'événement ou initiation
  - prefix_id: préfixe pour les IDs (pour éviter les conflits dans les modals)
  - show_alert: afficher l'alerte "presque complet" (défaut: true)
  - show_summary: afficher le résumé de l'événement (défaut: false, pour modals)
  - user_attendance: l'inscription de l'utilisateur (parent) si déjà inscrit (optionnel)
  - child_attendances: les inscriptions des enfants si déjà inscrits (optionnel)
%>
<% 
  prefix_id ||= ""
  show_alert = local_assigns.fetch(:show_alert, true)
  show_summary = local_assigns.fetch(:show_summary, false)
  is_waitlist = local_assigns.fetch(:is_waitlist, false)
  is_initiation = event.is_a?(Event::Initiation)
  is_modal = prefix_id.present?
  
  # Calculer les attendances si non fournies (pour les modals dans les cartes)
  if local_assigns[:user_attendance].nil? && user_signed_in?
    user_attendances = event.attendances.where(user: current_user).includes(:child_membership)
    user_attendance = user_attendances.find_by(child_membership_id: nil)
    child_attendances = user_attendances.where.not(child_membership_id: nil).to_a
  else
    user_attendance = local_assigns[:user_attendance]
    child_attendances = local_assigns[:child_attendances] || []
  end
  
  # Filtrer les enfants disponibles selon le type d'événement
  if user_signed_in?
    if is_initiation
      # Pour les initiations : inclure active, trial (essai gratuit) et pending (en attente)
      # IMPORTANT : Exclure les enfants pending qui ont déjà utilisé leur essai gratuit
      # (car ils ne peuvent plus s'inscrire sans adhésion active selon le contrôleur)
      child_memberships = current_user.memberships.where(is_child_membership: true)
        .where(status: [Membership.statuses[:active], Membership.statuses[:trial], Membership.statuses[:pending]])
      
      # Filtrer les enfants pending qui ont déjà utilisé leur essai gratuit
      # IMPORTANT : Utiliser .active pour exclure les attendances annulées (si annulation, l'essai gratuit redevient disponible)
      # Convertir en array pour pouvoir utiliser reject
      child_memberships_array = child_memberships.to_a
      child_memberships_filtered = child_memberships_array.reject do |child|
        if child.pending?
          # Si l'enfant est pending ET a déjà utilisé son essai gratuit, l'exclure du dropdown
          current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
        else
          false # Garder les enfants active et trial
        end
      end
      # Reconvertir en relation ActiveRecord pour compatibilité avec where.not plus bas
      child_memberships = Membership.where(id: child_memberships_filtered.map(&:id))
    else
      # Pour les événements normaux (randos) : afficher tous les enfants (active, expired, trial, pending)
      # Aucune restriction de statut pour les randos
      child_memberships = current_user.memberships.where(is_child_membership: true)
    end
  else
    child_memberships = []
  end
  child_memberships ||= []
  if child_attendances.any?
    registered_child_ids = child_attendances.map(&:child_membership_id).compact
    child_memberships = child_memberships.where.not(id: registered_child_ids)
  end
  
  # Déterminer si on doit afficher le dropdown et quel prompt utiliser
  user_already_registered = user_attendance.present?
  # Afficher le dropdown seulement si :
  # - L'utilisateur n'est pas encore inscrit (peut s'inscrire lui-même ou un enfant)
  # - OU il y a des enfants disponibles à inscrire (même si l'utilisateur est déjà inscrit)
  show_child_dropdown = !user_already_registered || child_memberships.any?
  dropdown_prompt = user_already_registered ? "Sélectionner un enfant" : "S'inscrire pour moi-même"
  
  # Calculer si on doit afficher l'essai gratuit pour les enfants (nécessaire pour le dropdown)
  # RÈGLE v4.0 : Les essais gratuits sont NOMINATIFS - chaque enfant DOIT utiliser son propre essai gratuit
  # Vérifier si on a des enfants avec statut trial OU pending (tous OBLIGATOIRES) disponibles qui n'ont pas encore utilisé leur essai
  # IMPORTANT : Utiliser .active pour exclure les attendances annulées (si annulation, l'essai gratuit redevient disponible)
  if is_initiation && user_signed_in?
    # Enfants trial : essai gratuit OBLIGATOIRE (nominatif)
    trial_children_preview = child_memberships.select { |m| m.trial? }
    # Enfants pending : essai gratuit OBLIGATOIRE (nominatif, même si parent adhérent)
    pending_children_preview = child_memberships.select { |m| m.pending? }
    # Afficher si on a des enfants trial OU pending qui peuvent utiliser leur essai
    show_free_trial_children = (trial_children_preview.any? { |child| 
      !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
    } || pending_children_preview.any? { |child| 
      !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
    })
  else
    show_free_trial_children = false
  end
%>

<% if show_alert %>
  <!-- Alerte "Presque complet" si ≤5 places restantes -->
  <% if is_initiation %>
    <% if event.available_places <= 5 && event.available_places > 0 %>
      <div class="alert alert-warning mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
        <strong>Attention !</strong> Il ne reste que <%= pluralize(event.available_places, "place disponible") %> pour cette séance.
      </div>
    <% end %>
  <% else %>
    <% if !event.unlimited? && event.remaining_spots <= 5 && event.remaining_spots > 0 %>
      <div class="alert alert-warning mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
        <strong>Attention !</strong> Il ne reste que <%= pluralize(event.remaining_spots, "place disponible") %> pour cet événement.
      </div>
    <% end %>
  <% end %>
<% end %>

<% if show_summary && is_modal %>
  <!-- Résumé de l'événement (pour modals) -->
  <p class="lead mb-3">
    Confirmez votre participation à <strong><%= event.title %></strong>
  </p>
  
  <div class="event-summary mb-3 p-3 bg-light rounded">
    <div class="row g-2">
      <div class="col-12">
        <p class="mb-2 small text-muted fw-semibold text-uppercase">Résumé</p>
      </div>
      <div class="col-12 col-sm-6">
        <p class="mb-1">
          <i class="bi bi-calendar-event text-primary me-2" aria-hidden="true"></i>
          <strong>Date :</strong> <%= l event.start_at, format: "%A %d %B %Y", locale: :fr %>
        </p>
      </div>
      <div class="col-12 col-sm-6">
        <p class="mb-1">
          <i class="bi bi-geo-alt text-primary me-2" aria-hidden="true"></i>
          <strong>Lieu :</strong> <%= truncate(event.location_text, length: 50) %>
        </p>
      </div>
      <% if is_initiation %>
        <div class="col-12 col-sm-6">
          <p class="mb-1">
            <i class="bi bi-clock text-primary me-2" aria-hidden="true"></i>
            <strong>Horaires :</strong> <%= l(event.start_at, format: :time) %> - <%= l(event.start_at + event.duration_min.minutes, format: :time) %> (<%= event.duration_min %> min)
          </p>
        </div>
        <div class="col-12 col-sm-6">
          <p class="mb-0">
            <i class="bi bi-people text-primary me-2" aria-hidden="true"></i>
            <strong>Places :</strong> 
            <% if event.allow_non_member_discovery? %>
              <%= event.available_member_places %> adhérents / <%= event.available_non_member_places %> découverte
              (<%= event.participants_count %> / <%= event.max_participants %>)
            <% else %>
              <%= event.available_places %> / <%= event.max_participants %>
            <% end %>
          </p>
        </div>
      <% else %>
        <div class="col-12 col-sm-6">
          <p class="mb-1">
            <i class="bi bi-clock text-primary me-2" aria-hidden="true"></i>
            <strong>Durée :</strong> <%= event.duration_min %> minutes
          </p>
        </div>
        <% if event.distance_km.present? && event.distance_km > 0 %>
          <div class="col-12 col-sm-6">
            <p class="mb-0">
              <i class="bi bi-signpost-2 text-primary me-2" aria-hidden="true"></i>
              <strong>Distance :</strong>
              <% if event.loops_count && event.loops_count > 1 %>
                <%= number_with_precision(event.total_distance_km, precision: 1, strip_insignificant_zeros: true) %> km
                <span class="badge bg-info ms-2"><%= event.loops_count %> boucles</span>
              <% else %>
                <%= number_with_precision(event.distance_km, precision: 1, strip_insignificant_zeros: true) %> km
              <% end %>
            </p>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Sélection enfant si applicable -->
<% if show_child_dropdown %>
  <div class="mb-3">
    <%= form.label :child_membership_id, "S'inscrire pour un enfant (optionnel)", class: "form-label" %>
    <%= form.collection_select :child_membership_id, 
        child_memberships, 
        :id, 
        ->(m) { "#{m.child_first_name} #{m.child_last_name}" }, 
        { prompt: dropdown_prompt }, 
        { class: "form-select", id: "child_membership_id#{prefix_id}", onchange: (is_modal && is_initiation) ? "toggleVolunteerVisibility#{prefix_id}(); #{show_free_trial_children ? "updateFreeTrialDisplay#{prefix_id}();" : ''}" : (show_free_trial_children ? "updateFreeTrialDisplay#{prefix_id}();" : nil) } %>
    <% if is_initiation %>
      <small class="text-muted">
        <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
        <% if user_already_registered %>
          Seuls les enfants avec une adhésion active, un essai gratuit ou une adhésion en attente, et non déjà inscrits sont affichés.
        <% else %>
          Seuls les enfants avec une adhésion active, un essai gratuit ou une adhésion en attente sont affichés. Laissez vide pour vous inscrire vous-même.
        <% end %>
      </small>
    <% end %>
  </div>
<% end %>

<!-- Demande matériel (uniquement pour initiations) -->
<% if is_initiation %>
  <div class="mb-3">
    <div class="form-check mb-2">
      <%= check_box_tag :needs_equipment, "1", false, { 
          class: "form-check-input", 
          id: "needs_equipment#{prefix_id}", 
          onchange: "toggleRollerSize#{prefix_id}()" 
      } %>
      <%= label_tag "needs_equipment#{prefix_id}", class: "form-check-label" do %>
        <i class="bi bi-roller-skate me-1" aria-hidden="true"></i>
        <strong>Besoin de matériel</strong>
      <% end %>
    </div>
      <div id="roller_size_container<%= prefix_id %>" style="display: none;" class="ms-4">
      <%= label_tag "roller_size_select#{prefix_id}", class: "form-label" do %>
        Taille de rollers
      <% end %>
      <%= select_tag :roller_size, 
          options_from_collection_for_select(RollerStock.available.ordered_by_size, :size, :size_with_stock),
          { include_blank: "Choisir une taille", class: "form-select", id: "roller_size_select#{prefix_id}", aria: { describedby: "roller_size_help#{prefix_id}" } } %>
      <small id="roller_size_help<%= prefix_id %>" class="text-muted">
        <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
        Sous réserve de disponibilité du matériel.
      </small>
    </div>
  </div>
  
  <script>
    function toggleRollerSize<%= prefix_id %>() {
      const checkbox = document.getElementById('needs_equipment<%= prefix_id %>');
      const container = document.getElementById('roller_size_container<%= prefix_id %>');
      const select = document.getElementById('roller_size_select<%= prefix_id %>');
      
      if (checkbox && container && select) {
        if (checkbox.checked) {
          container.style.display = 'block';
          select.required = true;
          // S'assurer que le champ est accessible pour la validation
          select.removeAttribute('disabled');
          select.removeAttribute('hidden');
        } else {
          container.style.display = 'none';
          select.required = false;
          select.value = '';
          // Réinitialiser le champ quand la checkbox est décochée
        }
      }
    }
    
    // Initialiser l'état au chargement (au cas où la checkbox serait déjà cochée)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        toggleRollerSize<%= prefix_id %>();
      });
    } else {
      toggleRollerSize<%= prefix_id %>();
    }
  </script>
<% end %>

<!-- Option bénévole si éligible (uniquement pour initiations et pour le parent, pas pour la liste d'attente) -->
<% if is_initiation && current_user.can_be_volunteer == true && !is_waitlist %>
  <div class="mb-3 form-check form-switch" id="volunteer_toggle<%= prefix_id %>" <%= 'style="display: none;"' if child_memberships.any? %>>
    <%= check_box_tag :is_volunteer, "1", false, { class: "form-check-input", id: "is_volunteer#{prefix_id}" } %>
    <%= label_tag "is_volunteer#{prefix_id}", class: "form-check-label" do %>
      <i class="bi bi-heart-fill text-danger me-1" aria-hidden="true"></i>
      <strong>S'inscrire en tant que bénévole encadrant</strong>
    <% end %>
    <small class="text-muted d-block mt-1">
      <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
      En tant que bénévole, vous encadrerez les participants. Votre présence sera enregistrée séparément.
    </small>
  </div>
  
  <%# Définir la fonction JavaScript si c'est une initiation dans un modal ET que le select enfant existe %>
  <% if is_modal && show_child_dropdown %>
    <script>
      function toggleVolunteerVisibility<%= prefix_id %>() {
        const childSelect = document.getElementById('child_membership_id<%= prefix_id %>');
        const volunteerToggle = document.getElementById('volunteer_toggle<%= prefix_id %>');
        const volunteerCheckbox = document.getElementById('is_volunteer<%= prefix_id %>');
        
        if (childSelect && volunteerToggle) {
          if (childSelect.value === '' || childSelect.value === null) {
            volunteerToggle.style.display = 'block';
          } else {
            volunteerToggle.style.display = 'none';
            if (volunteerCheckbox) volunteerCheckbox.checked = false;
          }
        }
      }
      
      // Initialiser au chargement
      function initVolunteerVisibility<%= prefix_id %>() {
        toggleVolunteerVisibility<%= prefix_id %>();
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initVolunteerVisibility<%= prefix_id %>);
      } else {
        initVolunteerVisibility<%= prefix_id %>();
      }
      
      // Support Turbo
      document.addEventListener('turbo:load', initVolunteerVisibility<%= prefix_id %>);
      
      // Fonction générique pour configurer l'écouteur modal (définie ici pour être disponible)
      if (typeof window.setupModalListenerGeneric<%= prefix_id %> === 'undefined') {
        window.setupModalListenerGeneric<%= prefix_id %> = function(callback) {
          const prefixIdClean = '<%= prefix_id %>'.replace(/^_/, '');
          const formElement = document.getElementById('attendForm<%= prefix_id %>') || 
                             document.getElementById('attendForm' + prefixIdClean) ||
                             document.getElementById('joinWaitlistForm<%= prefix_id %>') ||
                             document.getElementById('joinWaitlistForm' + prefixIdClean) ||
                             document.querySelector('form[id*="attendForm"]') ||
                             document.querySelector('form[id*="waitlist"]');
          
          if (formElement) {
            const modalElement = formElement.closest('.modal');
            if (modalElement && typeof callback === 'function') {
              const handler = function() {
                setTimeout(callback, 100);
              };
              modalElement.addEventListener('shown.bs.modal', handler);
            }
          }
        };
      }
      
      // Configurer l'écouteur pour le bénévole
      if (typeof window.setupModalListenerGeneric<%= prefix_id %> === 'function') {
        window.setupModalListenerGeneric<%= prefix_id %>(function() {
          toggleVolunteerVisibility<%= prefix_id %>();
        });
        setTimeout(function() {
          window.setupModalListenerGeneric<%= prefix_id %>(function() {
            toggleVolunteerVisibility<%= prefix_id %>();
          });
        }, 500);
      }
    </script>
  <% end %>
<% end %>

<!-- Essai gratuit si disponible (pour initiations, parent ou enfant avec statut trial) -->
<% 
  # Conditions pour afficher l'essai gratuit :
  # 1. C'est une initiation
  # 2. L'utilisateur n'est pas déjà inscrit (pour lui-même)
  # 3. Soit :
  #    a. Pour le parent : pas d'adhésion active ET pas déjà utilisé son essai gratuit
  #    b. Pour un enfant : l'enfant a un statut trial OU pending ET n'a pas déjà utilisé son essai gratuit (OBLIGATOIRE - nominatif)
  # 4. Si allow_non_member_discovery est activé, on affiche quand même l'option (l'utilisateur peut choisir)
  # RÈGLE v4.0 : Les essais gratuits sont NOMINATIFS - chaque enfant DOIT utiliser son propre essai gratuit, même si le parent est adhérent
  
  # RÈGLE v4.0 : Les essais gratuits sont NOMINATIFS - chaque enfant DOIT utiliser son propre essai gratuit
  # Vérifier si on a des enfants avec statut trial OU pending (tous OBLIGATOIRES) disponibles
  trial_children = child_memberships.select { |m| m.trial? }
  pending_children = child_memberships.select { |m| m.pending? }
  has_trial_children = trial_children.any?
  has_pending_children = pending_children.any?
  
  # Pour le parent (sans enfant sélectionné)
  # Le parent peut utiliser son essai gratuit s'il n'a pas d'adhésion active PERSONNELLE ET n'a pas déjà utilisé son essai
  # IMPORTANT : Utiliser .personal pour vérifier uniquement les adhésions personnelles (pas les enfants)
  # IMPORTANT : Utiliser .active pour exclure les attendances annulées (si annulation, l'essai gratuit redevient disponible)
  # RÈGLE v4.0 : Les essais gratuits sont NOMINATIFS - le statut des enfants n'a AUCUNE influence sur l'essai gratuit du parent
  parent_can_use_trial = !current_user.memberships.personal.active_now.exists? && 
                         !current_user.attendances.active.where(free_trial_used: true, child_membership_id: nil).exists?
  
  # NOUVELLE LOGIQUE : Si le parent n'a plus d'essai gratuit mais qu'un enfant en a un, on permet quand même
  # Et inversement : si aucun enfant n'a d'essai gratuit mais que le parent en a un, on permet aussi
  parent_has_trial = parent_can_use_trial
  any_child_has_trial = (trial_children.any? { |child| 
    !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
  } || pending_children.any? { |child| 
    !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
  })
  
  # L'option sera affichée dynamiquement via JavaScript selon l'enfant sélectionné
  # On prépare les données pour JavaScript
  # IMPORTANT : Utiliser .active pour exclure les attendances annulées
  # RÈGLE v4.0 : Inclure les enfants trial ET pending (tous OBLIGATOIRES - essais gratuits nominatifs)
  trial_children_data = (trial_children + pending_children).map do |child|
    {
      id: child.id,
      name: "#{child.child_first_name} #{child.child_last_name}",
      status: child.status, # 'trial' ou 'pending' - tous OBLIGATOIRES (essais gratuits nominatifs)
      has_used_trial: current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?,
      can_use_trial: !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?,
      is_trial: child.trial?, # Essai gratuit OBLIGATOIRE (nominatif)
      is_pending: child.pending? # Essai gratuit OBLIGATOIRE (nominatif, même si parent adhérent)
    }
  end.to_json
  
  # Afficher l'essai gratuit si :
  # - Le parent peut l'utiliser, OU
  # - Un enfant peut l'utiliser, OU
  # - Le parent n'a plus d'essai mais un enfant en a un (et inversement)
  show_free_trial_parent = is_initiation && !user_already_registered && parent_has_trial
  # show_free_trial_children est déjà défini plus haut (avant le dropdown)
  # Variable combinée : afficher si parent OU enfant peut utiliser (même si l'autre ne peut plus)
  show_free_trial = is_initiation && !user_already_registered && (parent_has_trial || any_child_has_trial)
  
  # Vérifier si le parent a une adhésion active PERSONNELLE (pour déterminer si l'essai est obligatoire pour les enfants pending)
  # IMPORTANT : Utiliser .personal pour vérifier uniquement les adhésions personnelles (pas les enfants)
  # RÈGLE v4.0 : Les essais gratuits sont NOMINATIFS - le statut des enfants n'a AUCUNE influence sur l'essai gratuit du parent
  parent_has_active_membership = current_user.memberships.personal.active_now.exists?
%>
<% if show_free_trial_parent || show_free_trial_children %>
  <%# Style initial : afficher si parent peut utiliser OU si enfant trial/pending disponible %>
  <% initial_display = show_free_trial_parent || (show_free_trial_children && (child_memberships.any? { |m| m.trial? } || child_memberships.any? { |m| m.pending? })) %>
  <div class="mb-3 form-check" id="free_trial_container<%= prefix_id %>" style="<%= initial_display ? '' : 'display: none;' %>">
    <%= check_box_tag :use_free_trial, "1", false, { 
        class: "form-check-input", 
        id: "use_free_trial#{prefix_id}",
        aria: { describedby: "free_trial_help#{prefix_id}" }
    } %>
    <%= label_tag "use_free_trial#{prefix_id}", class: "form-check-label", id: "use_free_trial_label#{prefix_id}" do %>
      <i class="bi bi-gift me-1" aria-hidden="true"></i>
      <span id="free_trial_text<%= prefix_id %>">Utiliser mon essai gratuit</span>
    <% end %>
    <small id="free_trial_help<%= prefix_id %>" class="text-muted d-block mt-1">
      <span id="free_trial_help_text<%= prefix_id %>">
        <% if is_initiation && event.allow_non_member_discovery? %>
          Vous pouvez utiliser votre essai gratuit maintenant ou vous inscrire dans les places découverte disponibles. Après cet essai, une adhésion sera requise pour continuer.
        <% else %>
          Vous pouvez utiliser votre essai gratuit. <strong>Après cet essai, une adhésion sera requise pour continuer.</strong>
        <% end %>
      </span>
    </small>
  </div>
  
  <% if show_free_trial_parent || show_free_trial_children %>
    <script>
      // Données des enfants avec statut trial (peut être vide si seulement parent)
      const trialChildrenData<%= prefix_id %> = <%= show_free_trial_children ? raw(trial_children_data) : '[]' %>;
      
      // Fonction pour mettre à jour l'affichage de l'essai gratuit selon l'enfant sélectionné
      function updateFreeTrialDisplay<%= prefix_id %>() {
        // Utiliser un sélecteur strict pour éviter les conflits multi-instances
        const prefixIdClean = '<%= prefix_id %>'.replace(/^_/, '');
        const form = document.getElementById('attendForm<%= prefix_id %>') || 
                     document.getElementById('attendForm' + prefixIdClean) ||
                     document.getElementById('joinWaitlistForm<%= prefix_id %>') ||
                     document.getElementById('joinWaitlistForm' + prefixIdClean) ||
                     document.querySelector('form[id*="attendForm"]') ||
                     document.querySelector('form[action*="attend"]');
        if (!form) return;
        
        const childSelect = document.getElementById('child_membership_id<%= prefix_id %>') || 
                           form.querySelector('select[name="child_membership_id"]');
        const freeTrialContainer = document.getElementById('free_trial_container<%= prefix_id %>');
        const freeTrialCheckbox = document.getElementById('use_free_trial<%= prefix_id %>');
        const freeTrialText = document.getElementById('free_trial_text<%= prefix_id %>');
        const freeTrialHelpText = document.getElementById('free_trial_help_text<%= prefix_id %>');
        
        if (!freeTrialContainer || !freeTrialText) return;
        
        const selectedChildId = childSelect ? parseInt(childSelect.value) : null;
        const selectedChild = trialChildrenData<%= prefix_id %>.find(c => c.id === selectedChildId);
        
        if (selectedChild) {
          // Un enfant est sélectionné dans le menu déroulant
          // IMPORTANT : Afficher la checkbox UNIQUEMENT si cet enfant a un essai gratuit disponible
          // RÈGLE v4.0 : Les essais gratuits sont NOMINATIFS - tous les enfants pending et trial DOIVENT utiliser leur essai gratuit
          const isTrial = selectedChild.is_trial || selectedChild.status === 'trial'; // Essai gratuit OBLIGATOIRE (nominatif)
          const isPending = selectedChild.is_pending || selectedChild.status === 'pending'; // Essai gratuit OBLIGATOIRE (nominatif)
          const canUseTrial = selectedChild.can_use_trial && !selectedChild.has_used_trial;
          
          if (canUseTrial && (isTrial || isPending)) {
            // L'enfant sélectionné peut utiliser son essai gratuit → AFFICHER la checkbox
            freeTrialContainer.style.display = 'block';
            const childNameEscaped = String(selectedChild.name || '').replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            if (isTrial) {
              // Enfant trial : essai gratuit OBLIGATOIRE
              freeTrialText.textContent = 'Utiliser l\'essai gratuit de ' + childNameEscaped + ' (OBLIGATOIRE)';
              freeTrialHelpText.innerHTML = '<strong>Essai gratuit pour ' + childNameEscaped + ' (OBLIGATOIRE) :</strong> Cet enfant peut utiliser son essai gratuit pour cette initiation. <strong>Cette case doit être cochée pour confirmer l\'inscription.</strong> Après cet essai, une adhésion sera requise pour continuer.';
              if (freeTrialCheckbox) {
                freeTrialCheckbox.checked = true; // Cocher par défaut pour les enfants trial
                freeTrialCheckbox.required = true; // Rendre obligatoire
              }
            } else if (isPending) {
              // RÈGLE v4.0 : Essais gratuits NOMINATIFS - l'essai gratuit est OBLIGATOIRE pour les enfants pending, même si le parent est adhérent
              freeTrialText.textContent = 'Utiliser l\'essai gratuit de ' + childNameEscaped + ' (OBLIGATOIRE)';
              freeTrialHelpText.innerHTML = '<strong>Essai gratuit pour ' + childNameEscaped + ' (OBLIGATOIRE) :</strong> Cet enfant doit utiliser son essai gratuit pour cette initiation. Les essais gratuits sont nominatifs - chaque enfant a droit à son propre essai gratuit. <strong>Cette case doit être cochée pour confirmer l\'inscription.</strong> Après cet essai, une adhésion sera requise pour continuer.';
              if (freeTrialCheckbox) {
                freeTrialCheckbox.checked = true; // Cocher par défaut pour les enfants pending (obligatoire)
                freeTrialCheckbox.required = true; // Rendre obligatoire
              }
            }
          } else {
            // L'enfant sélectionné n'a PAS d'essai gratuit disponible → MASQUER la checkbox
            freeTrialContainer.style.display = 'none';
            if (freeTrialCheckbox) {
              freeTrialCheckbox.checked = false;
              freeTrialCheckbox.required = false;
            }
          }
        } else {
          // Aucun enfant sélectionné dans le menu déroulant
          // Si le parent s'inscrit lui-même ET qu'il a un essai gratuit → Afficher la checkbox pour le parent
          // Sinon → Masquer la checkbox
          const parentCanUseTrial = <%= parent_has_trial ? 'true' : 'false' %>;
          
          if (parentCanUseTrial) {
            // Le parent peut utiliser son essai gratuit (inscription pour lui-même)
            freeTrialContainer.style.display = 'block';
            if (freeTrialText) {
              freeTrialText.textContent = 'Utiliser mon essai gratuit';
            }
            <% if is_initiation && event.allow_non_member_discovery? %>
              freeTrialHelpText.innerHTML = 'Vous pouvez utiliser votre essai gratuit maintenant ou vous inscrire dans les places découverte disponibles. Après cet essai, une adhésion sera requise pour continuer.';
            <% else %>
              freeTrialHelpText.innerHTML = 'Vous n\'avez pas encore utilisé votre essai gratuit. <strong>Cette case doit être cochée pour confirmer votre inscription.</strong> Après cet essai, une adhésion sera requise pour continuer.';
            <% end %>
            if (freeTrialCheckbox) {
              freeTrialCheckbox.checked = false; // Pas cochée par défaut, l'utilisateur doit cocher explicitement
              freeTrialCheckbox.required = false; // Pas obligatoire si allow_non_member_discovery est activé
            }
          } else {
            // Le parent n'a pas d'essai gratuit disponible → MASQUER la checkbox
            freeTrialContainer.style.display = 'none';
            if (freeTrialCheckbox) {
              freeTrialCheckbox.checked = false;
              freeTrialCheckbox.required = false;
            }
          }
        }
        
        // Appeler toggleSubmitButton après chaque mise à jour de l'affichage
        toggleSubmitButton<%= prefix_id %>();
      }
      
      // Fonction pour gérer le toggle du bouton submit selon tous les cas de figure
      // ⚠️ IMPORTANT : Cette fonction ne s'applique QUE pour les initiations (essai gratuit uniquement pour initiations)
      // RÈGLE v4.0 : Conforme à 100% avec la documentation et le contrôleur
      // Documentation ligne 88 : "Uniquement pour les initiations : L'essai gratuit n'est disponible que pour les initiations, pas pour les événements/randos normaux"
      function toggleSubmitButton<%= prefix_id %>() {
        // PROTECTION : Ne s'applique QUE si c'est une initiation ET qu'il y a une checkbox essai gratuit
        const freeTrialContainer = document.getElementById('free_trial_container<%= prefix_id %>');
        if (!freeTrialContainer) {
          // Pas de container essai gratuit = événement normal (rando) → Ne rien faire, laisser le comportement par défaut
          return;
        }
        
        const prefixIdClean = '<%= prefix_id %>'.replace(/^_/, '');
        const form = document.getElementById('attendForm<%= prefix_id %>') || 
                     document.getElementById('attendForm' + prefixIdClean) ||
                     document.getElementById('joinWaitlistForm<%= prefix_id %>') ||
                     document.getElementById('joinWaitlistForm' + prefixIdClean) ||
                     document.querySelector('form[id*="attendForm"]') ||
                     document.querySelector('form[action*="attend"]');
        if (!form) return;
        
        const submitButton = form.querySelector('input[type="submit"], button[type="submit"]');
        const freeTrialCheckbox = document.getElementById('use_free_trial<%= prefix_id %>');
        const childSelect = document.getElementById('child_membership_id<%= prefix_id %>');
        
        if (!submitButton) return;
        
        // Variables de contexte
        const noChildSelected = !childSelect || childSelect.value === '' || childSelect.value === null;
        const selectedChildId = childSelect && childSelect.value ? parseInt(childSelect.value) : null;
        const trialChildrenDataArray = Array.isArray(trialChildrenData<%= prefix_id %>) ? trialChildrenData<%= prefix_id %> : [];
        const selectedChild = selectedChildId ? trialChildrenDataArray.find(c => c.id === selectedChildId) : null;
        const parentCanUseTrial = <%= parent_has_trial ? 'true' : 'false' %>;
        const parentHasActiveMembership = <%= parent_has_active_membership ? 'true' : 'false' %>;
        const allowDiscovery = <%= is_initiation && event.allow_non_member_discovery? ? 'true' : 'false' %>;
        const isCheckboxVisible = freeTrialContainer && freeTrialContainer.style.display !== 'none';
        const isCheckboxChecked = freeTrialCheckbox && freeTrialCheckbox.checked;
        
        // CAS 1 : Parent adhérent actif → Toujours BLEU (documentation ligne 2184)
        if (parentHasActiveMembership) {
          submitButton.disabled = false;
          submitButton.style.opacity = '1';
          submitButton.style.cursor = 'pointer';
          return;
        }
        
        // CAS 2 : Enfant sélectionné
        if (selectedChild) {
          const isTrial = selectedChild.is_trial || selectedChild.status === 'trial';
          const isPending = selectedChild.is_pending || selectedChild.status === 'pending';
          const isActive = selectedChild.status === 'active';
          const canUseTrial = selectedChild.can_use_trial && !selectedChild.has_used_trial;
          
          // CAS 2.1 : Enfant active → Toujours BLEU (documentation ligne 2302)
          if (isActive) {
            submitButton.disabled = false;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
            return;
          }
          
          // CAS 2.2 : Enfant trial/pending + essai disponible → Bouton GRIS si checkbox non cochée (documentation ligne 2273, 2242)
          if ((isTrial || isPending) && canUseTrial) {
            // Checkbox obligatoire → Bouton GRIS si non cochée, BLEU si cochée
            if (isCheckboxVisible && !isCheckboxChecked) {
              submitButton.disabled = true;
              submitButton.style.opacity = '0.6';
              submitButton.style.cursor = 'not-allowed';
            } else {
              submitButton.disabled = false;
              submitButton.style.opacity = '1';
              submitButton.style.cursor = 'pointer';
            }
            return;
          }
          
          // CAS 2.3 : Enfant essai déjà utilisé → Toujours BLEU (mais bloqué côté serveur - documentation ligne 2258, 2289)
          submitButton.disabled = false;
          submitButton.style.opacity = '1';
          submitButton.style.cursor = 'pointer';
          return;
        }
        
        // CAS 3 : Parent non-adhérent (aucun enfant sélectionné)
        if (noChildSelected && parentCanUseTrial) {
          // RÈGLE CRITIQUE : Même avec allow_non_member_discovery, le bouton reste GRIS si checkbox non cochée
          // Cela force l'utilisation explicite de l'essai gratuit (documentation ligne 2204)
          if (isCheckboxVisible && !isCheckboxChecked) {
            submitButton.disabled = true;
            submitButton.style.opacity = '0.6';
            submitButton.style.cursor = 'not-allowed';
          } else {
            submitButton.disabled = false;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
          }
          return;
        }
        
        // CAS 4 : Pas de checkbox visible ou autres cas → Toujours BLEU
        submitButton.disabled = false;
        submitButton.style.opacity = '1';
        submitButton.style.cursor = 'pointer';
      }
      
      // Fonction d'initialisation réutilisable
      function setupFreeTrialDisplay<%= prefix_id %>() {
        // Utiliser un sélecteur strict pour éviter les conflits multi-instances
        const prefixIdClean = '<%= prefix_id %>'.replace(/^_/, '');
        const form = document.getElementById('attendForm<%= prefix_id %>') || 
                     document.getElementById('attendForm' + prefixIdClean) ||
                     document.getElementById('joinWaitlistForm<%= prefix_id %>') ||
                     document.getElementById('joinWaitlistForm' + prefixIdClean) ||
                     document.querySelector('form[id*="attendForm"]') ||
                     document.querySelector('form[action*="attend"]');
        if (form) {
          const childSelect = document.getElementById('child_membership_id<%= prefix_id %>') || 
                             form.querySelector('select[name="child_membership_id"]');
          const freeTrialCheckbox = document.getElementById('use_free_trial<%= prefix_id %>');
          
          if (childSelect) {
            // Retirer l'ancien listener s'il existe
            childSelect.removeEventListener('change', updateFreeTrialDisplay<%= prefix_id %>);
            childSelect.addEventListener('change', function() {
              updateFreeTrialDisplay<%= prefix_id %>();
              toggleSubmitButton<%= prefix_id %>();
            });
            // Appeler une première fois pour initialiser l'affichage
            updateFreeTrialDisplay<%= prefix_id %>();
          } else {
            // Pas de select enfant, vérifier si on doit afficher pour le parent
            updateFreeTrialDisplay<%= prefix_id %>();
          }
          
          // Ajouter listener sur la checkbox pour toggle le bouton submit
          if (freeTrialCheckbox) {
            freeTrialCheckbox.removeEventListener('change', toggleSubmitButton<%= prefix_id %>);
            freeTrialCheckbox.addEventListener('change', toggleSubmitButton<%= prefix_id %>);
          }
          
          // Initialiser le bouton submit au chargement
          toggleSubmitButton<%= prefix_id %>();
        }
      }
      
      // Écouter les changements sur le select enfant : support à la fois du chargement normal et Turbo
      function initFreeTrialDisplay<%= prefix_id %>() {
        setupFreeTrialDisplay<%= prefix_id %>();
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFreeTrialDisplay<%= prefix_id %>);
      } else {
        // Le DOM est déjà chargé, initialiser immédiatement
        initFreeTrialDisplay<%= prefix_id %>();
      }

      // Support Turbo : réinitialiser lors des navigations Turbo
      document.addEventListener('turbo:load', initFreeTrialDisplay<%= prefix_id %>);
      document.addEventListener('turbo:frame-load', function(e) {
        // Vérifier si le formulaire est dans le frame chargé
        if (e.target.querySelector('form[id*="attendForm"]') || e.target.querySelector('form[action*="attend"]')) {
          initFreeTrialDisplay<%= prefix_id %>();
        }
      });
      
      // Fonction générique pour configurer l'écouteur modal (réutilisable)
      if (typeof window.setupModalListenerGeneric<%= prefix_id %> === 'undefined') {
        window.setupModalListenerGeneric<%= prefix_id %> = function(callback) {
          const prefixIdClean = '<%= prefix_id %>'.replace(/^_/, '');
          const formElement = document.getElementById('attendForm<%= prefix_id %>') || 
                             document.getElementById('attendForm' + prefixIdClean) ||
                             document.getElementById('joinWaitlistForm<%= prefix_id %>') ||
                             document.getElementById('joinWaitlistForm' + prefixIdClean) ||
                             document.querySelector('form[id*="attendForm"]') ||
                             document.querySelector('form[id*="waitlist"]');
          
          if (formElement) {
            const modalElement = formElement.closest('.modal');
            if (modalElement && typeof callback === 'function') {
              const handler = function() {
                setTimeout(callback, 100);
              };
              modalElement.addEventListener('shown.bs.modal', handler);
            }
          }
        };
      }
      
      // Configurer l'écouteur pour l'essai gratuit
      if (typeof window.setupModalListenerGeneric<%= prefix_id %> === 'function') {
        window.setupModalListenerGeneric<%= prefix_id %>(function() {
          setupFreeTrialDisplay<%= prefix_id %>();
        });
        setTimeout(function() {
          window.setupModalListenerGeneric<%= prefix_id %>(function() {
            setupFreeTrialDisplay<%= prefix_id %>();
          });
        }, 500);
      }
      
      // Initialiser au chargement si pas d'enfants (seulement parent)
      <% unless show_free_trial_children %>
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            setupFreeTrialDisplay<%= prefix_id %>();
          });
        } else {
          setupFreeTrialDisplay<%= prefix_id %>();
        }
        
        // Support Turbo
        document.addEventListener('turbo:load', setupFreeTrialDisplay<%= prefix_id %>);
      <% end %>
    </script>
  <% end %>
<% end %>

<!-- Rappel email -->
<div class="mb-4 form-check">
  <%= form.check_box :wants_reminder, { checked: true, class: "form-check-input", id: "wants_reminder#{prefix_id}" }, "1", "0" %>
  <%= form.label "wants_reminder#{prefix_id}", class: "form-check-label" do %>
    <i class="bi bi-bell me-1" aria-hidden="true"></i>
    Recevoir un rappel la veille à 19h
  <% end %>
</div>

<script>
  // Fonction générique pour configurer l'écouteur modal (définie une seule fois, réutilisable partout)
  if (typeof window.setupModalListenerGeneric<%= prefix_id %> === 'undefined') {
    window.setupModalListenerGeneric<%= prefix_id %> = function(callback) {
      const prefixIdClean = '<%= prefix_id %>'.replace(/^_/, '');
      const formElement = document.getElementById('attendForm<%= prefix_id %>') || 
                         document.getElementById('attendForm' + prefixIdClean) ||
                         document.getElementById('joinWaitlistForm<%= prefix_id %>') ||
                         document.getElementById('joinWaitlistForm' + prefixIdClean) ||
                         document.querySelector('form[id*="attendForm"]') ||
                         document.querySelector('form[id*="waitlist"]');
      
      if (formElement) {
        const modalElement = formElement.closest('.modal');
        if (modalElement && typeof callback === 'function') {
          const handler = function() {
            setTimeout(callback, 100);
          };
          modalElement.addEventListener('shown.bs.modal', handler);
        }
      }
    };
  }
  
  // Validation JavaScript avant soumission (spécifique à ce formulaire)
  (function() {
    // Trouver le formulaire parent qui contient ce partial
    const form = document.querySelector('form[id*="attendForm"]');
    if (!form) return;
    
    const submitButton = form.querySelector('input[type="submit"], button[type="submit"]');
    if (!submitButton) return;
    
    // Utiliser un flag pour éviter les doubles soumissions
    let isSubmitting = false;
    
    form.addEventListener('submit', function(e) {
      // Empêcher la soumission si déjà en cours
      if (isSubmitting) {
        e.preventDefault();
        return false;
      }
      
      // Vérifier si l'utilisateur est déjà inscrit (via data attributes)
      <% if user_attendance.present? %>
        const childSelect = document.getElementById('child_membership_id<%= prefix_id %>');
        if (!childSelect || !childSelect.value || childSelect.value === '') {
          e.preventDefault();
          alert('Vous êtes déjà inscrit(e) à cette séance. Veuillez sélectionner un enfant si vous souhaitez en inscrire un.');
          return false;
        }
      <% end %>
      
      // Vérifier que roller_size est sélectionné si needs_equipment est coché
      <% if is_initiation %>
        const needsEquipment = document.getElementById('needs_equipment<%= prefix_id %>');
        const rollerSize = document.getElementById('roller_size_select<%= prefix_id %>');
        
        if (needsEquipment && needsEquipment.checked && rollerSize && (!rollerSize.value || rollerSize.value === '')) {
          e.preventDefault();
          alert('Veuillez sélectionner une taille de rollers si vous avez besoin de matériel.');
          rollerSize.focus();
          return false;
        }
      <% end %>
      
      // NOTE : La validation serveur existe pour sécuriser l'inscription
      // Les erreurs seront affichées via des notifications
      
      // Marquer comme en cours de soumission
      isSubmitting = true;
      
      // Désactiver le bouton pour éviter les doubles soumissions
      submitButton.disabled = true;
      if (submitButton.tagName === 'INPUT') {
        submitButton.value = submitButton.value || 'Inscription en cours...';
      } else {
        submitButton.textContent = 'Inscription en cours...';
      }
    });
  })();
</script>

