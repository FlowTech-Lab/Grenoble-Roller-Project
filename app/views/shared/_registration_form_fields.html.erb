<%# 
  Partial réutilisable pour les champs d'inscription aux initiations/événements
  Variables locales attendues:
  - form: l'objet form (form_with)
  - event: l'événement ou initiation
  - prefix_id: préfixe pour les IDs (pour éviter les conflits dans les modals)
  - show_alert: afficher l'alerte "presque complet" (défaut: true)
  - show_summary: afficher le résumé de l'événement (défaut: false, pour modals)
  - user_attendance: l'inscription de l'utilisateur (parent) si déjà inscrit (optionnel)
  - child_attendances: les inscriptions des enfants si déjà inscrits (optionnel)
%>
<% 
  prefix_id ||= ""
  show_alert = local_assigns.fetch(:show_alert, true)
  show_summary = local_assigns.fetch(:show_summary, false)
  is_waitlist = local_assigns.fetch(:is_waitlist, false)
  is_initiation = event.is_a?(Event::Initiation)
  is_modal = prefix_id.present?
  
  # Calculer les attendances si non fournies (pour les modals dans les cartes)
  if local_assigns[:user_attendance].nil? && user_signed_in?
    user_attendances = event.attendances.where(user: current_user).includes(:child_membership)
    user_attendance = user_attendances.find_by(child_membership_id: nil)
    child_attendances = user_attendances.where.not(child_membership_id: nil).to_a
  else
    user_attendance = local_assigns[:user_attendance]
    child_attendances = local_assigns[:child_attendances] || []
  end
  
  # Filtrer les enfants disponibles selon le type d'événement
  if user_signed_in?
    if is_initiation
      # Pour les initiations : inclure active, trial (essai gratuit) et pending (en attente)
      # pending est autorisé car l'enfant peut utiliser l'essai gratuit même si l'adhésion n'est pas encore payée
      child_memberships = current_user.memberships.where(is_child_membership: true)
        .where(status: [Membership.statuses[:active], Membership.statuses[:trial], Membership.statuses[:pending]])
    else
      # Pour les événements normaux (randos) : afficher tous les enfants (active, expired, trial, pending)
      # Aucune restriction de statut pour les randos
      child_memberships = current_user.memberships.where(is_child_membership: true)
    end
  else
    child_memberships = []
  end
  child_memberships ||= []
  if child_attendances.any?
    registered_child_ids = child_attendances.map(&:child_membership_id).compact
    child_memberships = child_memberships.where.not(id: registered_child_ids)
  end
  
  # Déterminer si on doit afficher le dropdown et quel prompt utiliser
  user_already_registered = user_attendance.present?
  # Afficher le dropdown seulement si :
  # - L'utilisateur n'est pas encore inscrit (peut s'inscrire lui-même ou un enfant)
  # - OU il y a des enfants disponibles à inscrire (même si l'utilisateur est déjà inscrit)
  show_child_dropdown = !user_already_registered || child_memberships.any?
  dropdown_prompt = user_already_registered ? "Sélectionner un enfant" : "S'inscrire pour moi-même"
  
  # Calculer si on doit afficher l'essai gratuit pour les enfants (nécessaire pour le dropdown)
  # Vérifier si on a des enfants avec statut trial (obligatoire) OU pending (optionnel) disponibles qui n'ont pas encore utilisé leur essai
  # IMPORTANT : Utiliser .active pour exclure les attendances annulées (si annulation, l'essai gratuit redevient disponible)
  if is_initiation && user_signed_in?
    # Enfants trial : essai gratuit OBLIGATOIRE
    trial_children_preview = child_memberships.select { |m| m.trial? }
    # Enfants pending : essai gratuit OPTIONNEL (selon 02-statut-pending.md)
    pending_children_preview = child_memberships.select { |m| m.pending? }
    # Afficher si on a des enfants trial OU pending qui peuvent utiliser leur essai
    show_free_trial_children = (trial_children_preview.any? { |child| 
      !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
    } || pending_children_preview.any? { |child| 
      !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
    })
  else
    show_free_trial_children = false
  end
%>

<% if show_alert %>
  <!-- Alerte "Presque complet" si ≤5 places restantes -->
  <% if is_initiation %>
    <% if event.available_places <= 5 && event.available_places > 0 %>
      <div class="alert alert-warning mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
        <strong>Attention !</strong> Il ne reste que <%= pluralize(event.available_places, "place disponible", "places disponibles") %> pour cette séance.
      </div>
    <% end %>
  <% else %>
    <% if !event.unlimited? && event.remaining_spots <= 5 && event.remaining_spots > 0 %>
      <div class="alert alert-warning mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
        <strong>Attention !</strong> Il ne reste que <%= pluralize(event.remaining_spots, "place disponible", "places disponibles") %> pour cet événement.
      </div>
    <% end %>
  <% end %>
<% end %>

<% if show_summary && is_modal %>
  <!-- Résumé de l'événement (pour modals) -->
  <p class="lead mb-3">
    Confirmez votre participation à <strong><%= event.title %></strong>
  </p>
  
  <div class="event-summary mb-3 p-3 bg-light rounded">
    <div class="row g-2">
      <div class="col-12">
        <p class="mb-2 small text-muted fw-semibold text-uppercase">Résumé</p>
      </div>
      <div class="col-12 col-sm-6">
        <p class="mb-1">
          <i class="bi bi-calendar-event text-primary me-2" aria-hidden="true"></i>
          <strong>Date :</strong> <%= l event.start_at, format: "%A %d %B %Y", locale: :fr %>
        </p>
      </div>
      <div class="col-12 col-sm-6">
        <p class="mb-1">
          <i class="bi bi-geo-alt text-primary me-2" aria-hidden="true"></i>
          <strong>Lieu :</strong> <%= truncate(event.location_text, length: 50) %>
        </p>
      </div>
      <% if is_initiation %>
        <div class="col-12 col-sm-6">
          <p class="mb-1">
            <i class="bi bi-clock text-primary me-2" aria-hidden="true"></i>
            <strong>Horaires :</strong> <%= l(event.start_at, format: :time) %> - <%= l(event.start_at + event.duration_min.minutes, format: :time) %> (<%= event.duration_min %> min)
          </p>
        </div>
        <div class="col-12 col-sm-6">
          <p class="mb-0">
            <i class="bi bi-people text-primary me-2" aria-hidden="true"></i>
            <strong>Places :</strong> 
            <% if event.allow_non_member_discovery? %>
              <%= event.available_member_places %> adhérents / <%= event.available_non_member_places %> découverte
              (<%= event.participants_count %> / <%= event.max_participants %>)
            <% else %>
              <%= event.available_places %> / <%= event.max_participants %>
            <% end %>
          </p>
        </div>
      <% else %>
        <div class="col-12 col-sm-6">
          <p class="mb-1">
            <i class="bi bi-clock text-primary me-2" aria-hidden="true"></i>
            <strong>Durée :</strong> <%= event.duration_min %> minutes
          </p>
        </div>
        <% if event.distance_km.present? && event.distance_km > 0 %>
          <div class="col-12 col-sm-6">
            <p class="mb-0">
              <i class="bi bi-signpost-2 text-primary me-2" aria-hidden="true"></i>
              <strong>Distance :</strong>
              <% if event.loops_count && event.loops_count > 1 %>
                <%= number_with_precision(event.total_distance_km, precision: 1, strip_insignificant_zeros: true) %> km
                <span class="badge bg-info ms-2"><%= event.loops_count %> boucles</span>
              <% else %>
                <%= number_with_precision(event.distance_km, precision: 1, strip_insignificant_zeros: true) %> km
              <% end %>
            </p>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Sélection enfant si applicable -->
<% if show_child_dropdown %>
  <div class="mb-3">
    <%= form.label :child_membership_id, "S'inscrire pour un enfant (optionnel)", class: "form-label" %>
    <%= form.collection_select :child_membership_id, 
        child_memberships, 
        :id, 
        ->(m) { "#{m.child_first_name} #{m.child_last_name}" }, 
        { prompt: dropdown_prompt }, 
        { class: "form-select", id: "child_membership_id#{prefix_id}", onchange: (is_modal && is_initiation) ? "toggleVolunteerVisibility#{prefix_id}(); #{show_free_trial_children ? "updateFreeTrialDisplay#{prefix_id}();" : ''}" : (show_free_trial_children ? "updateFreeTrialDisplay#{prefix_id}();" : nil) } %>
    <% if is_initiation %>
      <small class="text-muted">
        <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
        <% if user_already_registered %>
          Seuls les enfants avec une adhésion active, un essai gratuit ou une adhésion en attente, et non déjà inscrits sont affichés.
        <% else %>
          Seuls les enfants avec une adhésion active, un essai gratuit ou une adhésion en attente sont affichés. Laissez vide pour vous inscrire vous-même.
        <% end %>
      </small>
    <% end %>
  </div>
<% end %>

<!-- Demande matériel (uniquement pour initiations) -->
<% if is_initiation %>
  <div class="mb-3">
    <div class="form-check mb-2">
      <%= check_box_tag :needs_equipment, "1", false, { 
          class: "form-check-input", 
          id: "needs_equipment#{prefix_id}", 
          onchange: "toggleRollerSize#{prefix_id}()" 
      } %>
      <%= label_tag "needs_equipment#{prefix_id}", class: "form-check-label" do %>
        <i class="bi bi-roller-skate me-1" aria-hidden="true"></i>
        <strong>Besoin de matériel</strong>
      <% end %>
    </div>
      <div id="roller_size_container<%= prefix_id %>" style="display: none;" class="ms-4">
      <%= label_tag "roller_size_select#{prefix_id}", "Taille de rollers", class: "form-label" %>
      <%= select_tag :roller_size, 
          options_from_collection_for_select(RollerStock.available.ordered_by_size, :size, :size_with_stock),
          { include_blank: "Choisir une taille", class: "form-select form-select-liquid", id: "roller_size_select#{prefix_id}", aria: { describedby: "roller_size_help#{prefix_id}", required: true } } %>
      <small id="roller_size_help<%= prefix_id %>" class="text-muted">
        <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
        Sous réserve de disponibilité du matériel.
      </small>
    </div>
  </div>
  
  <script>
    function toggleRollerSize<%= prefix_id %>() {
      const checkbox = document.getElementById('needs_equipment<%= prefix_id %>');
      const container = document.getElementById('roller_size_container<%= prefix_id %>');
      const select = document.getElementById('roller_size_select<%= prefix_id %>');
      
      if (checkbox && container && select) {
        if (checkbox.checked) {
          container.style.display = 'block';
          select.required = true;
        } else {
          container.style.display = 'none';
          select.required = false;
          select.value = '';
        }
      }
    }
  </script>
<% end %>

<!-- Option bénévole si éligible (uniquement pour initiations et pour le parent, pas pour la liste d'attente) -->
<% if is_initiation && current_user.can_be_volunteer == true && !is_waitlist %>
  <div class="mb-3 form-check form-switch" id="volunteer_toggle<%= prefix_id %>" <%= 'style="display: none;"' if child_memberships.any? %>>
    <%= check_box_tag :is_volunteer, "1", false, { class: "form-check-input", id: "is_volunteer#{prefix_id}" } %>
    <%= label_tag "is_volunteer#{prefix_id}", class: "form-check-label" do %>
      <i class="bi bi-heart-fill text-danger me-1" aria-hidden="true"></i>
      <strong>S'inscrire en tant que bénévole encadrant</strong>
    <% end %>
    <small class="text-muted d-block mt-1">
      <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
      En tant que bénévole, vous encadrerez les participants. Votre présence sera enregistrée séparément.
    </small>
  </div>
  
  <%# Définir la fonction JavaScript si c'est une initiation dans un modal ET que le select enfant existe %>
  <% if is_modal && show_child_dropdown %>
    <script>
      function toggleVolunteerVisibility<%= prefix_id %>() {
        const childSelect = document.getElementById('child_membership_id<%= prefix_id %>');
        const volunteerToggle = document.getElementById('volunteer_toggle<%= prefix_id %>');
        const volunteerCheckbox = document.getElementById('is_volunteer<%= prefix_id %>');
        
        if (childSelect && volunteerToggle) {
          if (childSelect.value === '' || childSelect.value === null) {
            volunteerToggle.style.display = 'block';
          } else {
            volunteerToggle.style.display = 'none';
            if (volunteerCheckbox) volunteerCheckbox.checked = false;
          }
        }
      }
      
      // Initialiser au chargement
      document.addEventListener('DOMContentLoaded', function() {
        toggleVolunteerVisibility<%= prefix_id %>();
      });
    </script>
  <% end %>
<% end %>

<!-- Essai gratuit si disponible (pour initiations, parent ou enfant avec statut trial) -->
<% 
  # Conditions pour afficher l'essai gratuit :
  # 1. C'est une initiation
  # 2. L'utilisateur n'est pas déjà inscrit (pour lui-même)
  # 3. Soit :
  #    a. Pour le parent : pas d'adhésion active ET pas déjà utilisé son essai gratuit
  #    b. Pour un enfant : l'enfant a un statut trial ET n'a pas déjà utilisé son essai gratuit
  # 4. Si allow_non_member_discovery est activé, on affiche quand même l'option (l'utilisateur peut choisir)
  
  # Vérifier si on a des enfants avec statut trial (obligatoire) OU pending (optionnel) disponibles
  trial_children = child_memberships.select { |m| m.trial? }
  pending_children = child_memberships.select { |m| m.pending? }
  has_trial_children = trial_children.any?
  has_pending_children = pending_children.any?
  
  # Pour le parent (sans enfant sélectionné)
  # Le parent peut utiliser son essai gratuit s'il n'a pas d'adhésion active ET n'a pas déjà utilisé son essai
  # IMPORTANT : Utiliser .active pour exclure les attendances annulées (si annulation, l'essai gratuit redevient disponible)
  parent_can_use_trial = !current_user.memberships.active_now.exists? && 
                         !current_user.attendances.active.where(free_trial_used: true, child_membership_id: nil).exists?
  
  # NOUVELLE LOGIQUE : Si le parent n'a plus d'essai gratuit mais qu'un enfant en a un, on permet quand même
  # Et inversement : si aucun enfant n'a d'essai gratuit mais que le parent en a un, on permet aussi
  parent_has_trial = parent_can_use_trial
  any_child_has_trial = (trial_children.any? { |child| 
    !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
  } || pending_children.any? { |child| 
    !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
  })
  
  # L'option sera affichée dynamiquement via JavaScript selon l'enfant sélectionné
  # On prépare les données pour JavaScript
  # IMPORTANT : Utiliser .active pour exclure les attendances annulées
  # Inclure les enfants trial (obligatoire) ET pending (optionnel)
  trial_children_data = (trial_children + pending_children).map do |child|
    {
      id: child.id,
      name: "#{child.child_first_name} #{child.child_last_name}",
      status: child.status, # 'trial' ou 'pending' pour distinguer obligatoire vs optionnel
      has_used_trial: current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?,
      can_use_trial: !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?,
      is_trial: child.trial?, # Essai gratuit OBLIGATOIRE
      is_pending: child.pending? # Essai gratuit OPTIONNEL
    }
  end.to_json
  
  # Afficher l'essai gratuit si :
  # - Le parent peut l'utiliser, OU
  # - Un enfant peut l'utiliser, OU
  # - Le parent n'a plus d'essai mais un enfant en a un (et inversement)
  show_free_trial_parent = is_initiation && !user_already_registered && parent_has_trial
  # show_free_trial_children est déjà défini plus haut (avant le dropdown)
  # Variable combinée : afficher si parent OU enfant peut utiliser (même si l'autre ne peut plus)
  show_free_trial = is_initiation && !user_already_registered && (parent_has_trial || any_child_has_trial)
%>
<% if show_free_trial_parent || show_free_trial_children %>
  <%# Champ caché pour garantir l'envoi de la valeur même si la checkbox est masquée %>
  <%= hidden_field_tag "use_free_trial_hidden#{prefix_id}", "0", id: "use_free_trial_hidden#{prefix_id}" %>
  <div class="mb-3 form-check" id="free_trial_container<%= prefix_id %>" style="<%= show_free_trial_parent || (show_free_trial_children && (child_memberships.any? { |m| m.trial? } || child_memberships.any? { |m| m.pending? })) ? '' : 'display: none;' %>">
    <%= check_box_tag :use_free_trial, "1", false, { 
        class: "form-check-input", 
        id: "use_free_trial#{prefix_id}",
        aria: { describedby: "free_trial_help#{prefix_id}" },
        onchange: "window.toggleSubmitButton#{prefix_id} && window.toggleSubmitButton#{prefix_id}(); if (this.checked) { document.getElementById('use_free_trial_hidden#{prefix_id}').value = '1'; } else { document.getElementById('use_free_trial_hidden#{prefix_id}').value = '0'; }"
    } %>
    <%= label_tag "use_free_trial#{prefix_id}", class: "form-check-label", id: "use_free_trial_label#{prefix_id}" do %>
      <i class="bi bi-gift me-1" aria-hidden="true"></i>
      <span id="free_trial_text<%= prefix_id %>">Utiliser mon essai gratuit</span>
    <% end %>
    <small id="free_trial_help<%= prefix_id %>" class="text-muted d-block mt-1">
      <span id="free_trial_help_text<%= prefix_id %>">
        <% if is_initiation && event.allow_non_member_discovery? %>
          Vous pouvez utiliser votre essai gratuit maintenant ou vous inscrire dans les places découverte disponibles. Après cet essai, une adhésion sera requise pour continuer.
        <% else %>
          Vous n'avez pas encore utilisé votre essai gratuit. <strong>Cette case doit être cochée pour confirmer votre inscription.</strong> Après cet essai, une adhésion sera requise pour continuer.
        <% end %>
      </span>
    </small>
  </div>
  
  <% if show_free_trial_children %>
    <script>
      // Données des enfants avec statut trial
      const trialChildrenData<%= prefix_id %> = <%= raw trial_children_data %>;
      
      // Fonction pour mettre à jour l'affichage de l'essai gratuit selon l'enfant sélectionné
      function updateFreeTrialDisplay<%= prefix_id %>() {
        const form = document.querySelector('form[id*="attendForm"]') || document.querySelector('form[action*="attend"]');
        if (!form) return;
        
        const childSelect = form.querySelector('select[name="child_membership_id"]');
        const freeTrialContainer = document.getElementById('free_trial_container<%= prefix_id %>');
        const freeTrialCheckbox = document.getElementById('use_free_trial<%= prefix_id %>');
        const freeTrialText = document.getElementById('free_trial_text<%= prefix_id %>');
        const freeTrialHelpText = document.getElementById('free_trial_help_text<%= prefix_id %>');
        
        if (!freeTrialContainer) return;
        
        const selectedChildId = childSelect ? parseInt(childSelect.value) : null;
        const selectedChild = trialChildrenData<%= prefix_id %>.find(c => c.id === selectedChildId);
        
        if (selectedChild) {
          // Un enfant avec statut trial (obligatoire) OU pending (optionnel) est sélectionné
          const parentCanUseTrial = <%= parent_has_trial ? 'true' : 'false' %>;
          const isTrial = selectedChild.is_trial || selectedChild.status === 'trial'; // Essai gratuit OBLIGATOIRE
          const isPending = selectedChild.is_pending || selectedChild.status === 'pending'; // Essai gratuit OPTIONNEL
          
          if (selectedChild.has_used_trial && !parentCanUseTrial) {
            // L'enfant a déjà utilisé son essai ET le parent n'en a plus non plus
            freeTrialContainer.style.display = 'none';
            if (freeTrialCheckbox) {
              freeTrialCheckbox.checked = false;
              freeTrialCheckbox.required = false;
            }
          } else if (selectedChild.has_used_trial && parentCanUseTrial) {
            // L'enfant a déjà utilisé son essai MAIS le parent peut encore utiliser le sien
            freeTrialContainer.style.display = 'block';
            freeTrialText.textContent = 'Utiliser mon essai gratuit (parent)';
            const childNameEscaped1 = String(selectedChild.name || '').replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            freeTrialHelpText.innerHTML = '<strong>Essai gratuit parent :</strong> ' + childNameEscaped1 + ' a déjà utilisé son essai gratuit, mais vous pouvez utiliser le vôtre pour cette initiation. <strong>Cette case doit être cochée pour confirmer l\'inscription.</strong>';
            if (freeTrialCheckbox) {
              freeTrialCheckbox.checked = true;
              freeTrialCheckbox.required = true; // Obligatoire pour le parent
              document.getElementById('use_free_trial_hidden<%= prefix_id %>').value = '1';
            }
          } else if (!selectedChild.has_used_trial) {
            // L'enfant peut utiliser son essai gratuit
            freeTrialContainer.style.display = 'block';
            const childNameEscaped2 = String(selectedChild.name || '').replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            if (isTrial) {
              // Enfant trial : essai gratuit OBLIGATOIRE
              freeTrialText.textContent = 'Utiliser l\'essai gratuit de ' + childNameEscaped2;
              freeTrialHelpText.innerHTML = '<strong>Essai gratuit pour ' + childNameEscaped2 + ' :</strong> Cet enfant peut utiliser son essai gratuit pour cette initiation. <strong>Cette case doit être cochée pour confirmer l\'inscription.</strong> Après cet essai, une adhésion sera requise pour continuer.';
              if (freeTrialCheckbox) {
                freeTrialCheckbox.checked = true; // Cocher par défaut pour les enfants trial
                freeTrialCheckbox.required = true; // Rendre obligatoire
                const hiddenField = document.getElementById('use_free_trial_hidden<%= prefix_id %>');
                if (hiddenField) hiddenField.value = '1';
              }
            } else if (isPending) {
              // Enfant pending : essai gratuit OPTIONNEL (selon 02-statut-pending.md)
              freeTrialText.textContent = 'Utiliser l\'essai gratuit de ' + childNameEscaped2 + ' (optionnel)';
              freeTrialHelpText.innerHTML = '<strong>Essai gratuit pour ' + childNameEscaped2 + ' (optionnel) :</strong> Cet enfant peut utiliser son essai gratuit pour cette initiation, mais ce n\'est pas obligatoire car son adhésion est en attente de paiement. Vous pouvez vous inscrire sans utiliser l\'essai gratuit.';
              if (freeTrialCheckbox) {
                freeTrialCheckbox.checked = false; // Pas cochée par défaut pour les enfants pending
                freeTrialCheckbox.required = false; // Pas obligatoire
                const hiddenField = document.getElementById('use_free_trial_hidden<%= prefix_id %>');
                if (hiddenField) hiddenField.value = '0';
              }
            }
          }
        } else {
          // Pas d'enfant sélectionné ou enfant avec adhésion active
          const parentCanUseTrial = <%= parent_has_trial ? 'true' : 'false' %>;
          const anyChildCanUseTrial = trialChildrenData<%= prefix_id %>.some(c => c.can_use_trial);
          
          // Afficher si le parent peut utiliser son essai OU si un enfant peut utiliser le sien
          if (parentCanUseTrial || anyChildCanUseTrial) {
            freeTrialContainer.style.display = 'block';
            if (parentCanUseTrial) {
              // Le parent peut utiliser son essai gratuit
              freeTrialText.textContent = 'Utiliser mon essai gratuit';
              <% if is_initiation && event.allow_non_member_discovery? %>
                freeTrialHelpText.innerHTML = 'Vous pouvez utiliser votre essai gratuit maintenant ou vous inscrire dans les places découverte disponibles. Après cet essai, une adhésion sera requise pour continuer.';
              <% else %>
                freeTrialHelpText.innerHTML = 'Vous n\'avez pas encore utilisé votre essai gratuit. <strong>Cette case doit être cochée pour confirmer votre inscription.</strong> Après cet essai, une adhésion sera requise pour continuer.';
              <% end %>
            } else if (anyChildCanUseTrial) {
              // Le parent n'a plus d'essai mais un enfant peut utiliser le sien
              const availableChild = trialChildrenData<%= prefix_id %>.find(c => c.can_use_trial);
              const childNameEscaped3 = String(availableChild.name || '').replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
              freeTrialText.textContent = 'Utiliser l\'essai gratuit de ' + childNameEscaped3;
              freeTrialHelpText.innerHTML = '<strong>Essai gratuit enfant :</strong> Vous avez déjà utilisé votre essai gratuit, mais ' + childNameEscaped3 + ' peut utiliser le sien pour cette initiation. <strong>Cette case doit être cochée pour confirmer l\'inscription.</strong>';
            }
            if (freeTrialCheckbox) freeTrialCheckbox.checked = false;
          } else {
            // Ni le parent ni les enfants ne peuvent utiliser d'essai gratuit
            freeTrialContainer.style.display = 'none';
            if (freeTrialCheckbox) freeTrialCheckbox.checked = false;
          }
        }
        
        // Appeler toggleSubmitButton pour mettre à jour l'état du bouton
        if (window.toggleSubmitButton<%= prefix_id %>) {
          window.toggleSubmitButton<%= prefix_id %>();
        }
      }
      
      // Fonction d'initialisation réutilisable
      function setupFreeTrialDisplay<%= prefix_id %>() {
        const form = document.querySelector('form[id*="attendForm"]') || document.querySelector('form[action*="attend"]');
        if (form) {
          const childSelect = form.querySelector('select[name="child_membership_id"]');
          if (childSelect) {
            // Retirer l'ancien listener s'il existe
            childSelect.removeEventListener('change', updateFreeTrialDisplay<%= prefix_id %>);
            childSelect.addEventListener('change', updateFreeTrialDisplay<%= prefix_id %>);
            // Appeler une première fois pour initialiser l'affichage
            updateFreeTrialDisplay<%= prefix_id %>();
          } else {
            // Pas de select enfant, vérifier si on doit afficher pour le parent
            updateFreeTrialDisplay<%= prefix_id %>();
          }
        }
      }
      
      // Écouter les changements sur le select enfant : support à la fois du chargement normal et Turbo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupFreeTrialDisplay<%= prefix_id %>);
      } else {
        // Le DOM est déjà chargé, initialiser immédiatement
        setupFreeTrialDisplay<%= prefix_id %>();
      }

      // Support Turbo : réinitialiser lors des navigations Turbo
      document.addEventListener('turbo:load', setupFreeTrialDisplay<%= prefix_id %>);
      document.addEventListener('turbo:frame-load', function(e) {
        // Vérifier si le formulaire est dans le frame chargé
        if (e.target.querySelector('form[id*="attendForm"]') || e.target.querySelector('form[action*="attend"]')) {
          setupFreeTrialDisplay<%= prefix_id %>();
        }
      });
    </script>
  <% end %>
<% end %>

<!-- Rappel email -->
<div class="mb-4 form-check">
  <%= form.check_box :wants_reminder, { checked: true, class: "form-check-input", id: "wants_reminder#{prefix_id}" }, "1", "0" %>
  <%= form.label "wants_reminder#{prefix_id}", class: "form-check-label" do %>
    <i class="bi bi-bell me-1" aria-hidden="true"></i>
    Recevoir un rappel la veille à 19h
  <% end %>
</div>

<script>
  // Fonction pour activer/désactiver le bouton de soumission selon l'essai gratuit (accessible globalement)
  <% if show_free_trial && !(is_initiation && event.allow_non_member_discovery?) %>
    // Définir la fonction globalement pour qu'elle soit accessible depuis l'attribut onchange
    window.toggleSubmitButton<%= prefix_id %> = function() {
      // Si l'essai gratuit est requis (pas de places découverte), désactiver le bouton si non coché
      // MAIS seulement pour les enfants trial (obligatoire), pas pour les enfants pending (optionnel)
      const form = document.querySelector('form[id*="attendForm"]');
      if (!form) return;
      const btn = form.querySelector('input[type="submit"], button[type="submit"]');
      if (!btn) return;
      const freeTrialCheckbox = document.getElementById('use_free_trial<%= prefix_id %>');
      const childSelect = document.getElementById('child_membership_id<%= prefix_id %>');
      
      if (freeTrialCheckbox && childSelect) {
        const selectedChildId = childSelect.value ? parseInt(childSelect.value) : null;
        <% if show_free_trial_children %>
          const trialChildrenData = <%= raw trial_children_data %>;
          const selectedChild = trialChildrenData.find(c => c.id === selectedChildId);
          
          if (selectedChild) {
            const isTrial = selectedChild.is_trial || selectedChild.status === 'trial';
            const isPending = selectedChild.is_pending || selectedChild.status === 'pending';
            
            // Pour les enfants trial : essai gratuit OBLIGATOIRE, désactiver le bouton si non coché
            if (isTrial && !freeTrialCheckbox.checked) {
              btn.disabled = true;
              btn.classList.add('disabled', 'opacity-50');
              btn.style.opacity = '0.6';
              btn.style.cursor = 'not-allowed';
              return;
            }
            // Pour les enfants pending : essai gratuit OPTIONNEL, le bouton reste actif même si non coché
            if (isPending) {
              btn.disabled = false;
              btn.classList.remove('disabled', 'opacity-50');
              btn.style.opacity = '1';
              btn.style.cursor = 'pointer';
              return;
            }
          }
        <% end %>
        
        // Pour le parent ou si aucun enfant sélectionné : désactiver si non coché
        if (freeTrialCheckbox.checked) {
          btn.disabled = false;
          btn.classList.remove('disabled', 'opacity-50');
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        } else {
          btn.disabled = true;
          btn.classList.add('disabled', 'opacity-50');
          btn.style.opacity = '0.6';
          btn.style.cursor = 'not-allowed';
        }
      }
    };
  <% else %>
    // Fonction vide si l'essai gratuit n'est pas requis (pour éviter les erreurs)
    window.toggleSubmitButton<%= prefix_id %> = function() {
      // Ne rien faire si l'essai gratuit n'est pas requis
    };
  <% end %>
  
  // Validation JavaScript avant soumission (spécifique à ce formulaire)
  (function() {
    // Trouver le formulaire parent qui contient ce partial
    const form = document.querySelector('form[id*="attendForm"]');
    if (!form) return;
    
    const submitButton = form.querySelector('input[type="submit"], button[type="submit"]');
    if (!submitButton) return;
    
    // Utiliser un flag pour éviter les doubles soumissions
    let isSubmitting = false;
    
    form.addEventListener('submit', function(e) {
      // Empêcher la soumission si déjà en cours
      if (isSubmitting) {
        e.preventDefault();
        return false;
      }
      
      // Vérifier si l'utilisateur est déjà inscrit (via data attributes)
      <% if user_attendance.present? %>
        const childSelect = document.getElementById('child_membership_id<%= prefix_id %>');
        if (!childSelect || !childSelect.value || childSelect.value === '') {
          e.preventDefault();
          alert('Vous êtes déjà inscrit(e) à cette séance. Veuillez sélectionner un enfant si vous souhaitez en inscrire un.');
          return false;
        }
      <% end %>
      
      // Vérifier que roller_size est sélectionné si needs_equipment est coché
      <% if is_initiation %>
        const needsEquipment = document.getElementById('needs_equipment<%= prefix_id %>');
        const rollerSize = document.getElementById('roller_size_select<%= prefix_id %>');
        
        if (needsEquipment && needsEquipment.checked && rollerSize && (!rollerSize.value || rollerSize.value === '')) {
          e.preventDefault();
          alert('Veuillez sélectionner une taille de rollers si vous avez besoin de matériel.');
          rollerSize.focus();
          return false;
        }
      <% end %>
      
      // Vérifier que l'essai gratuit est coché si requis (pas de places découverte)
      <% if show_free_trial && !(is_initiation && event.allow_non_member_discovery?) %>
        const freeTrialContainer = document.getElementById('free_trial_container<%= prefix_id %>');
        const freeTrialCheckbox = document.getElementById('use_free_trial<%= prefix_id %>');
        const childSelect = document.getElementById('child_membership_id<%= prefix_id %>');
        
        // Vérifier si un enfant trial (obligatoire) OU pending (optionnel) est sélectionné
        <% if show_free_trial_children %>
          const trialChildrenData = <%= raw trial_children_data %>;
          const selectedChildId = childSelect ? parseInt(childSelect.value) : null;
          const selectedChild = trialChildrenData.find(c => c.id === selectedChildId);
          
          if (selectedChild && !selectedChild.has_used_trial) {
            const isTrial = selectedChild.is_trial || selectedChild.status === 'trial';
            const isPending = selectedChild.is_pending || selectedChild.status === 'pending';
            
            // Si un enfant trial est sélectionné, la checkbox est OBLIGATOIRE
            if (isTrial && (!freeTrialCheckbox || !freeTrialCheckbox.checked)) {
              e.preventDefault();
              const childNameEscapedAlert = String(selectedChild.name || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
              alert('L\'essai gratuit est obligatoire pour ' + childNameEscapedAlert + '. Veuillez cocher la case "Utiliser l\'essai gratuit" pour confirmer l\'inscription.');
              if (freeTrialCheckbox) {
                freeTrialCheckbox.focus();
                freeTrialCheckbox.checked = true; // Cocher automatiquement
                const hiddenField = document.getElementById('use_free_trial_hidden<%= prefix_id %>');
                if (hiddenField) hiddenField.value = '1';
              }
              return false;
            }
            // Si un enfant pending est sélectionné, la checkbox est OPTIONNELLE (pas de validation)
            // L'enfant peut s'inscrire même sans cocher la case (car pending = is_member = true)
          }
        <% end %>
        
        // Ne valider que si le conteneur est visible (le checkbox peut être masqué selon l'enfant sélectionné)
        if (freeTrialContainer && freeTrialCheckbox) {
          const isContainerVisible = freeTrialContainer.style.display !== 'none' && 
                                     window.getComputedStyle(freeTrialContainer).display !== 'none';
          if (isContainerVisible && !freeTrialCheckbox.checked) {
            e.preventDefault();
            alert('Veuillez cocher la case "Utiliser mon essai gratuit" pour confirmer votre inscription.');
            freeTrialCheckbox.focus();
            return false;
          }
        }
      <% end %>
      
      // Marquer comme en cours de soumission
      isSubmitting = true;
      
      // Désactiver le bouton pour éviter les doubles soumissions
      submitButton.disabled = true;
      if (submitButton.tagName === 'INPUT') {
        submitButton.value = submitButton.value || 'Inscription en cours...';
      } else {
        submitButton.textContent = 'Inscription en cours...';
      }
    });
    
    // Initialiser l'état du bouton au chargement si l'essai gratuit est requis
    <% if show_free_trial && !(is_initiation && event.allow_non_member_discovery?) %>
      // Désactiver le bouton par défaut
      submitButton.disabled = true;
      submitButton.classList.add('disabled', 'opacity-50');
      submitButton.style.opacity = '0.6';
      submitButton.style.cursor = 'not-allowed';
      
      // Initialiser l'état au chargement
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', window.toggleSubmitButton<%= prefix_id %>);
      } else {
        window.toggleSubmitButton<%= prefix_id %>();
      }
    <% end %>
  })();
</script>

