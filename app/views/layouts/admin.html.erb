<!DOCTYPE html>
<html lang="fr" data-bs-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin - <%= content_for(:title) || "Grenoble Roller" %></title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <!-- Favicons -->
    <%= favicon_link_tag asset_path('favicon-512.png'), type: 'image/png', sizes: '512x512' %>
    <link rel="apple-touch-icon" href="<%= asset_path('favicon-512.png') %>" sizes="512x512">
    <link rel="shortcut icon" href="<%= asset_path('favicon-512.png') %>" type="image/png">
    <%= stylesheet_link_tag "application.bootstrap", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <script type="module">
      import "admin_panel_navbar";
    </script>
  </head>

  <body class="d-flex flex-column min-vh-100 admin-panel">
    <!-- NAVBAR PRINCIPALE (héritée) -->
    <%= render 'layouts/navbar' %>

    <!-- CONTENEUR ADMIN: Sidebar + Contenu -->
    <div class="d-flex flex-grow-1 position-relative admin-container">
      <!-- SIDEBAR ADMIN (fixed pour coller en haut après navbar) -->
      <%= render 'admin/shared/sidebar' %>

      <!-- CONTENU PRINCIPAL (avec marge pour la sidebar desktop) -->
      <main class="flex-grow-1 d-flex flex-column admin-main-content">
        <div class="container-fluid px-2 px-md-3 px-lg-4 py-3 py-lg-4">
          <!-- Flash messages -->
          <% if notice %>
            <div class="alert alert-liquid-success alert-dismissible fade show" role="alert">
              <%= notice %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% end %>
          <% if alert %>
            <div class="alert alert-liquid-danger alert-dismissible fade show" role="alert">
              <%= alert %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% end %>

          <!-- Contenu -->
          <%= yield %>
        </div>
      </main>
    </div>

    <!-- Footer de l'application normale -->
    <%= render 'layouts/footer-simple' %>

    <!-- Theme toggle script -->
    <script>
      // Encapsuler TOUT le JavaScript dans une IIFE pour éviter les conflits Turbo
      (function() {
        // Exposer toggleTheme sur window pour qu'elle soit accessible depuis onclick
        window.toggleTheme = function() {
          const html = document.documentElement;
          const currentTheme = html.getAttribute('data-bs-theme');
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          
          html.setAttribute('data-bs-theme', newTheme);
          
          // Mettre à jour les icônes
          const sunIcon = document.getElementById('theme-icon-sun');
          const moonIcon = document.getElementById('theme-icon-moon');
          const toggle = document.getElementById('theme-toggle');
          
          if (sunIcon && moonIcon) {
            const isDark = newTheme === 'dark';
            sunIcon.classList.toggle('d-none', !isDark);
            moonIcon.classList.toggle('d-none', isDark);
          }
          
          // Mettre à jour ARIA
          if (toggle) {
            const isDark = newTheme === 'dark';
            toggle.setAttribute('aria-pressed', isDark);
            toggle.setAttribute('aria-label', 
              isDark 
                ? 'Basculer vers le thème clair' 
                : 'Basculer vers le thème sombre'
            );
          }
          
          localStorage.setItem('theme', newTheme);
        };
        
        // Initialize theme when DOM is ready
        function initTheme() {
          const savedTheme = localStorage.getItem('theme') || 'light';
          const html = document.documentElement;
          
          html.setAttribute('data-bs-theme', savedTheme);
          
          // Initialiser les icônes
          const sunIcon = document.getElementById('theme-icon-sun');
          const moonIcon = document.getElementById('theme-icon-moon');
          const toggle = document.getElementById('theme-toggle');
          
          if (sunIcon && moonIcon) {
            const isDark = savedTheme === 'dark';
            sunIcon.classList.toggle('d-none', !isDark);
            moonIcon.classList.toggle('d-none', isDark);
          }
          
          if (toggle) {
            const isDark = savedTheme === 'dark';
            toggle.setAttribute('aria-pressed', isDark);
            toggle.setAttribute('aria-label', 
              isDark 
                ? 'Basculer vers le thème clair' 
                : 'Basculer vers le thème sombre'
            );
          }
        }

        // Gestion offcanvas mobile - Premium 2025 (compatible Turbo)
        // Utiliser un objet pour stocker les handlers (évite les conflits de redéclaration avec Turbo)
        const handlers = {
          clickHandler: null,
          collapseShownHandler: null,
          collapseHiddenHandler: null,
          keydownHandler: null,
          showOffcanvasHandler: null,
          hiddenOffcanvasHandler: null
        };

        function initOffcanvasHandlers() {
          const offcanvas = document.getElementById('offcanvasSidebar');
          if (!offcanvas) return;

          // Supprimer les anciens listeners s'ils existent
          if (handlers.clickHandler) {
            offcanvas.removeEventListener('click', handlers.clickHandler, true);
            handlers.clickHandler = null;
          }
          if (handlers.collapseShownHandler) {
            offcanvas.removeEventListener('shown.bs.collapse', handlers.collapseShownHandler);
            handlers.collapseShownHandler = null;
          }
          if (handlers.collapseHiddenHandler) {
            offcanvas.removeEventListener('hidden.bs.collapse', handlers.collapseHiddenHandler);
            handlers.collapseHiddenHandler = null;
          }
          if (handlers.keydownHandler) {
            offcanvas.removeEventListener('keydown', handlers.keydownHandler);
            handlers.keydownHandler = null;
          }
          if (handlers.showOffcanvasHandler) {
            offcanvas.removeEventListener('show.bs.offcanvas', handlers.showOffcanvasHandler);
            handlers.showOffcanvasHandler = null;
          }
          if (handlers.hiddenOffcanvasHandler) {
            offcanvas.removeEventListener('hidden.bs.offcanvas', handlers.hiddenOffcanvasHandler);
            handlers.hiddenOffcanvasHandler = null;
          }

          // Fermer offcanvas quand on clique sur un lien avec data-bs-dismiss
          // Bootstrap ne gère pas automatiquement data-bs-dismiss sur les liens <a>
          // Utiliser capture phase pour intercepter AVANT Turbo
          handlers.clickHandler = function(e) {
            // Chercher le lien le plus proche (admin-menu-link, admin-menu-sublink, ou nav-link)
            const link = e.target.closest('a.admin-menu-link, a.admin-menu-sublink, a.nav-link');
            
            if (!link) return; // Pas un lien du menu, laisser passer
            
            // Ignorer si c'est un toggle collapse (on veut qu'il fonctionne normalement)
            if (link.hasAttribute('data-bs-toggle') && link.getAttribute('data-bs-toggle') === 'collapse') {
              return; // Laisser Bootstrap gérer le collapse
            }
            
            // Vérifier si le lien a data-bs-dismiss="offcanvas"
            // En Rails, data-bs-dismiss devient data-bs-dismiss dans le HTML
            const shouldDismiss = link.hasAttribute('data-bs-dismiss') && link.getAttribute('data-bs-dismiss') === 'offcanvas';
            
            if (shouldDismiss) {
              // Empêcher la navigation immédiate pour fermer d'abord l'offcanvas
              e.preventDefault();
              e.stopPropagation();
              
              // Fermer l'offcanvas
              if (typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) {
                const offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvas);
                if (offcanvasInstance) {
                  const href = link.href;
                  offcanvasInstance.hide();
                  
                  // Naviguer après fermeture de l'offcanvas (une seule fois)
                  const navigateAfterClose = function() {
                    // Utiliser Turbo pour la navigation si disponible, sinon window.location
                    if (typeof Turbo !== 'undefined' && Turbo.visit) {
                      Turbo.visit(href);
                    } else {
                      window.location.href = href;
                    }
                    offcanvas.removeEventListener('hidden.bs.offcanvas', navigateAfterClose);
                  };
                  offcanvas.addEventListener('hidden.bs.offcanvas', navigateAfterClose, { once: true });
                } else {
                  // Si l'instance n'existe pas, naviguer directement
                  if (typeof Turbo !== 'undefined' && Turbo.visit) {
                    Turbo.visit(link.href);
                  } else {
                    window.location.href = link.href;
                  }
                }
              } else {
                // Si Bootstrap n'est pas disponible, naviguer directement
                if (typeof Turbo !== 'undefined' && Turbo.visit) {
                  Turbo.visit(link.href);
                } else {
                  window.location.href = link.href;
                }
              }
            }
            // Si le lien n'a pas data-bs-dismiss, ne rien faire - laisser le comportement par défaut (navigation normale)
            // Le return implicite permet au clic de continuer normalement
          };
          // Utiliser la phase de capture pour intercepter AVANT Turbo, mais seulement pour les liens avec data-bs-dismiss
          offcanvas.addEventListener('click', handlers.clickHandler, true);

          // Mettre à jour les chevrons quand collapse change (animation premium)
          handlers.collapseShownHandler = function(e) {
            const toggle = offcanvas.querySelector(`a[aria-controls="${e.target.id}"]`);
            if (toggle) {
              toggle.setAttribute('aria-expanded', 'true');
              const chevron = toggle.querySelector('.bi-chevron-right');
              if (chevron) {
                chevron.style.transform = 'rotate(90deg)';
              }
            }
          };
          offcanvas.addEventListener('shown.bs.collapse', handlers.collapseShownHandler);

          handlers.collapseHiddenHandler = function(e) {
            const toggle = offcanvas.querySelector(`a[aria-controls="${e.target.id}"]`);
            if (toggle) {
              toggle.setAttribute('aria-expanded', 'false');
              const chevron = toggle.querySelector('.bi-chevron-right');
              if (chevron) {
                chevron.style.transform = 'rotate(0deg)';
              }
            }
          };
          offcanvas.addEventListener('hidden.bs.collapse', handlers.collapseHiddenHandler);

          // Keyboard navigation - Escape pour fermer
          handlers.keydownHandler = function(e) {
            if (e.key === 'Escape') {
              if (typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) {
                const offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvas);
                if (offcanvasInstance) {
                  offcanvasInstance.hide();
                }
              }
            }
          };
          offcanvas.addEventListener('keydown', handlers.keydownHandler);

          // Empêcher scroll body quand offcanvas ouvert
          handlers.showOffcanvasHandler = function() {
            document.body.style.overflow = 'hidden';
          };
          offcanvas.addEventListener('show.bs.offcanvas', handlers.showOffcanvasHandler);

          handlers.hiddenOffcanvasHandler = function() {
            document.body.style.overflow = '';
          };
          offcanvas.addEventListener('hidden.bs.offcanvas', handlers.hiddenOffcanvasHandler);
        }

        // Attendre que Bootstrap soit chargé
        function waitForBootstrap(callback) {
          if (typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) {
            callback();
          } else {
            setTimeout(function() { waitForBootstrap(callback); }, 50);
          }
        }

        // Initialiser au chargement initial ET après chaque navigation Turbo
        function runInit() {
          waitForBootstrap(function() {
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', initOffcanvasHandlers);
            } else {
              initOffcanvasHandlers();
            }
          });
        }

        runInit();
        document.addEventListener('turbo:load', function() {
          waitForBootstrap(initOffcanvasHandlers);
        });
        document.addEventListener('turbo:frame-load', function() {
          waitForBootstrap(initOffcanvasHandlers);
        });
        // Générer automatiquement les data-label pour les tableaux responsive mobile
        function initResponsiveTables() {
          document.querySelectorAll('.admin-panel .table').forEach(function(table) {
            const headers = Array.from(table.querySelectorAll('thead th'));
            if (headers.length === 0) return;

            table.querySelectorAll('tbody tr').forEach(function(row) {
              const cells = Array.from(row.querySelectorAll('td'));
              cells.forEach(function(cell, index) {
                if (!cell.hasAttribute('data-label') && headers[index]) {
                  cell.setAttribute('data-label', headers[index].textContent.trim());
                }
              });
            });
          });
        }

        // Initialiser au chargement et après Turbo
        function runAllInit() {
          initTheme();
          initResponsiveTables();
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', runAllInit);
        } else {
          runAllInit();
        }
        
        document.addEventListener('turbo:load', runAllInit);
        document.addEventListener('turbo:frame-load', runAllInit);
      })(); // Fin de l'IIFE - Tout le JavaScript est maintenant encapsulé
    </script>
  </body>
</html>
