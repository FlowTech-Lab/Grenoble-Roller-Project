<% 
  breadcrumb_items = [
    { label: "Participations", url: nil }
  ]
%>

<%= render 'admin_panel/shared/breadcrumb', breadcrumb_items: breadcrumb_items %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Participations</h1>
  <%= link_to "Nouvelle participation", new_admin_panel_attendance_path, class: "btn btn-liquid-primary" %>
</div>

<!-- Filtres et recherche -->
<div class="card card-liquid rounded-liquid shadow-liquid mb-4">
  <div class="card-body">
    <%= search_form_for @q, url: admin_panel_attendances_path, method: :get, class: "row g-3" do |f| %>
      <div class="col-md-3">
        <%= f.label :user_id_eq, "Utilisateur", class: "form-label" %>
        <%= f.select :user_id_eq, 
            options_from_collection_for_select(User.order(:last_name, :first_name), :id, :to_s, params.dig(:q, :user_id_eq)),
            { prompt: "Tous les utilisateurs" },
            { class: "form-select form-control-liquid" } %>
      </div>
      <div class="col-md-3">
        <%= f.label :event_id_eq, "Événement", class: "form-label" %>
        <%= f.select :event_id_eq, 
            options_from_collection_for_select(Event.order(start_at: :desc).limit(50), :id, :title, params.dig(:q, :event_id_eq)),
            { prompt: "Tous les événements" },
            { class: "form-select form-control-liquid" } %>
      </div>
      <div class="col-md-2">
        <%= f.label :status_eq, "Statut", class: "form-label" %>
        <%= f.select :status_eq, 
            options_for_select([
              ["Tous", ""],
              ["En attente", "pending"],
              ["Inscrit", "registered"],
              ["Payé", "paid"],
              ["Annulé", "canceled"],
              ["Présent", "present"],
              ["Absent", "no_show"]
            ], params.dig(:q, :status_eq)),
            {},
            { class: "form-select form-control-liquid" } %>
      </div>
      <div class="col-md-2">
        <%= f.label :needs_equipment_eq, "Matériel", class: "form-label" %>
        <%= f.select :needs_equipment_eq, 
            options_for_select([
              ["Tous", ""],
              ["Oui", "true"],
              ["Non", "false"]
            ], params.dig(:q, :needs_equipment_eq)),
            {},
            { class: "form-select form-control-liquid" } %>
      </div>
      <div class="col-md-2 d-flex align-items-end gap-2">
        <%= f.submit "Filtrer", class: "btn btn-outline-liquid-primary" %>
        <%= link_to "Réinitialiser", admin_panel_attendances_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Onglets de filtres -->
<div class="mb-3">
  <%= link_to "Toutes", admin_panel_attendances_path, 
      class: "btn btn-sm #{params[:scope].blank? ? 'btn-liquid-primary' : 'btn-outline-liquid-primary'}" %>
  <%= link_to "Actives", admin_panel_attendances_path(scope: "active"), 
      class: "btn btn-sm #{params[:scope] == 'active' ? 'btn-liquid-primary' : 'btn-outline-liquid-primary'}" %>
  <%= link_to "Annulées", admin_panel_attendances_path(scope: "canceled"), 
      class: "btn btn-sm #{params[:scope] == 'canceled' ? 'btn-liquid-primary' : 'btn-outline-liquid-primary'}" %>
</div>

<!-- Tableau des participations -->
<div class="card card-liquid rounded-liquid shadow-liquid">
  <div class="card-body">
    <% if @attendances.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Utilisateur</th>
              <th>Événement</th>
              <th>Statut</th>
              <th>Bénévole</th>
              <th>Matériel</th>
              <th>Taille rollers</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @attendances.each do |attendance| %>
              <tr>
                <td>#<%= attendance.id %></td>
                <td>
                  <%= link_to attendance.user.to_s, admin_panel_user_path(attendance.user), class: "text-decoration-none" %>
                </td>
                <td>
                  <%= link_to attendance.event.title, admin_panel_event_path(attendance.event), class: "text-decoration-none" %>
                </td>
                <td>
                  <% badge_class = case attendance.status
                       when "paid" then "bg-success"
                       when "registered" then "bg-primary"
                       when "pending" then "bg-warning"
                       when "canceled" then "bg-secondary"
                       when "present" then "bg-info"
                       when "no_show" then "bg-danger"
                       else "bg-secondary"
                     end %>
                  <span class="badge <%= badge_class %>"><%= attendance.status %></span>
                </td>
                <td>
                  <% if attendance.is_volunteer? %>
                    <span class="badge bg-success">Oui</span>
                  <% else %>
                    <span class="text-muted">Non</span>
                  <% end %>
                </td>
                <td>
                  <% if attendance.needs_equipment? %>
                    <span class="badge bg-info">Oui</span>
                  <% else %>
                    <span class="text-muted">Non</span>
                  <% end %>
                </td>
                <td>
                  <% if attendance.needs_equipment? && attendance.roller_size.present? %>
                    <%= attendance.roller_size %> (EU)
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <%= attendance.created_at.strftime("%d/%m/%Y") %>
                </td>
                <td>
                  <div class="d-flex gap-2">
                    <%= link_to "Voir", admin_panel_attendance_path(attendance), class: "btn btn-sm btn-outline-primary" %>
                    <%= link_to "Modifier", edit_admin_panel_attendance_path(attendance), class: "btn btn-sm btn-outline-secondary" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="mt-3">
        <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>
      </div>
    <% else %>
      <p class="text-muted text-center py-4">Aucune participation trouvée</p>
    <% end %>
  </div>
</div>
