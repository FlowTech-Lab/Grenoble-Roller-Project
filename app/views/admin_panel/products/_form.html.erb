<%= form_with model: [:admin_panel, @product], 
    local: true, 
    multipart: true, 
    class: "product-form",
    data: { 
      controller: "product-form",
      product_form_auto_save_url_value: @product.persisted? ? admin_panel_product_path(@product) : "",
      product_form_preview_variants_url_value: preview_variants_admin_panel_products_path
    } do |f| %>
  
  <% if @product.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h5 class="alert-heading">
        <i class="bi bi-exclamation-triangle me-2"></i>Erreurs à corriger
      </h5>
      <ul class="mb-0">
        <% @product.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <!-- Header avec actions -->
  <div class="product-form-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h3 mb-1">
          <%= @product.persisted? ? "Modifier le produit" : "Nouveau produit" %>
        </h1>
        <p class="text-muted mb-0">
          <% if @product.persisted? %>
            <i class="bi bi-clock-history me-1"></i>
            Dernière modification : <%= time_ago_in_words(@product.updated_at) %>
          <% else %>
            Remplissez les informations ci-dessous
          <% end %>
        </p>
      </div>
      <div class="btn-group">
        <% if @product.persisted? %>
          <%= link_to admin_panel_product_path(@product), 
              class: "btn btn-outline-secondary",
              target: "_blank" do %>
            <i class="bi bi-eye me-1"></i>Aperçu
          <% end %>
        <% end %>
        <%= f.submit "Enregistrer", 
            class: "btn btn-liquid-primary", 
            name: "save_draft",
            data: { product_form_target: "saveButton" } %>
        <%= f.submit "Publier", 
            class: "btn btn-success", 
            name: "publish",
            data: { product_form_target: "publishButton" } %>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation (Desktop) -->
  <ul class="nav nav-tabs d-none d-md-flex mb-4" role="tablist" data-product-form-target="tabs">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" 
              id="product-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#product" 
              type="button" 
              role="tab"
              aria-controls="product"
              aria-selected="true">
        <i class="bi bi-box me-2"></i>Produit
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" 
              id="pricing-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#pricing" 
              type="button" 
              role="tab"
              aria-controls="pricing"
              aria-selected="false">
        <i class="bi bi-currency-euro me-2"></i>Prix
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" 
              id="inventory-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#inventory" 
              type="button" 
              role="tab"
              aria-controls="inventory"
              aria-selected="false">
        <i class="bi bi-box-seam me-2"></i>Inventaire
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" 
              id="variants-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#variants" 
              type="button" 
              role="tab"
              aria-controls="variants"
              aria-selected="false">
        <i class="bi bi-layers me-2"></i>Variantes
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" 
              id="seo-tab" 
              data-bs-toggle="tab" 
              data-bs-target="#seo" 
              type="button" 
              role="tab"
              aria-controls="seo"
              aria-selected="false">
        <i class="bi bi-search me-2"></i>SEO
      </button>
    </li>
  </ul>

  <!-- Accordion Navigation (Mobile) -->
  <div class="accordion d-md-none mb-4" id="productFormAccordion" data-product-form-target="accordion">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#productCollapse" aria-expanded="true">
          <i class="bi bi-box me-2"></i>Produit
        </button>
      </h2>
      <div id="productCollapse" class="accordion-collapse collapse show" data-bs-parent="#productFormAccordion">
        <div class="accordion-body">
          <!-- Le contenu sera dupliqué depuis le tab-pane #product via JavaScript si nécessaire -->
          <p class="text-muted">Voir la section "Produit" ci-dessous</p>
        </div>
      </div>
    </div>
    <!-- Autres sections accordion... -->
  </div>

  <!-- Tab Content -->
  <div class="tab-content" id="productFormTabs">
    
    <!-- Tab 1: Produit -->
    <div class="tab-pane fade show active" id="product" role="tabpanel" aria-labelledby="product-tab">
      <div class="container-fluid px-0">
        <!-- Section: Informations de base -->
      <div class="card card-liquid mb-4">
        <div class="card-header card-liquid-primary">
          <h5 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>Informations de base
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <%= f.label :name, "Nom du produit", class: "form-label fw-semibold" do %>
              Nom du produit <span class="text-danger">*</span>
            <% end %>
            <%= f.text_field :name, 
                class: "form-control form-control-liquid",
                placeholder: "Ex: Casque LED rechargeable",
                maxlength: 140,
                required: true,
                data: { 
                  product_form_target: "nameField",
                  action: "input->product-form#validateField blur->product-form#validateField"
                } %>
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              Maximum 140 caractères. 
              <span class="char-count" data-product-form-target="nameCharCount">0/140</span>
            </div>
            <div class="invalid-feedback" data-product-form-target="nameFeedback"></div>
          </div>

          <div class="mb-4">
            <%= f.label :slug, "Référence URL", class: "form-label fw-semibold" do %>
              Référence URL <span class="text-danger">*</span>
            <% end %>
            <%= f.text_field :slug, 
                class: "form-control form-control-liquid",
                placeholder: "Ex: casque-led-rouge",
                maxlength: 160,
                required: true,
                data: { 
                  product_form_target: "slugField",
                  action: "input->product-form#validateField blur->product-form#validateSlug"
                } %>
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              Identifiant pour l'URL (ex: casque-led-rouge). Généré automatiquement si vide.
            </div>
            <div class="invalid-feedback" data-product-form-target="slugFeedback"></div>
          </div>

          <div class="mb-4">
            <%= f.label :category_id, "Catégorie", class: "form-label fw-semibold" do %>
              Catégorie <span class="text-danger">*</span>
            <% end %>
            <%= f.select :category_id,
                options_from_collection_for_select(@categories, :id, :name, @product.category_id),
                { include_blank: "Sélectionner une catégorie" },
                { 
                  class: "form-select form-control-liquid",
                  required: true,
                  data: { 
                    product_form_target: "categoryField",
                    action: "change->product-form#validateField"
                  }
                } %>
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              La catégorie aide les clients à trouver votre produit.
            </div>
            <div class="invalid-feedback" data-product-form-target="categoryFeedback"></div>
          </div>

          <div class="mb-4">
            <%= f.label :description, "Description", class: "form-label fw-semibold" %>
            <%= f.text_area :description,
                class: "form-control form-control-liquid",
                rows: 6,
                placeholder: "Décrivez votre produit en détail...",
                data: { 
                  product_form_target: "descriptionField",
                  action: "input->product-form#autoSave"
                } %>
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              Utilisez un langage clair et descriptif pour aider les clients à comprendre votre produit.
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Images -->
      <div class="card card-liquid mb-4">
        <div class="card-header card-liquid-primary">
          <h5 class="mb-0">
            <i class="bi bi-images me-2"></i>Images du produit
          </h5>
        </div>
        <div class="card-body">
          <%= render 'admin_panel/products/image_upload', form: f, product: @product %>
        </div>
      </div>
      </div>
    </div>

    <!-- Tab 2: Prix -->
    <div class="tab-pane fade" id="pricing" role="tabpanel" aria-labelledby="pricing-tab">
      <div class="container-fluid px-0">
        <div class="card card-liquid">
        <div class="card-header card-liquid-primary">
          <h5 class="mb-0">
            <i class="bi bi-currency-euro me-2"></i>Prix et devise
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <%= f.label :price_cents, "Prix de base", class: "form-label fw-semibold" do %>
                Prix de base <span class="text-danger">*</span>
              <% end %>
              <div class="input-group">
                <%= f.number_field :price_cents, 
                    class: "form-control form-control-liquid",
                    required: true,
                    min: 0,
                    step: 1,
                    placeholder: "4000",
                    data: { 
                      product_form_target: "priceField",
                      action: "input->product-form#validateField blur->product-form#formatPrice"
                    } %>
                <span class="input-group-text">centimes</span>
              </div>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Ex: 4000 = 40,00 €. Les variantes peuvent avoir un prix différent.
              </div>
              <div class="invalid-feedback" data-product-form-target="priceFeedback"></div>
            </div>

            <div class="col-md-6 mb-4">
              <%= f.label :currency, "Devise", class: "form-label fw-semibold" do %>
                Devise <span class="text-danger">*</span>
              <% end %>
              <%= f.select :currency, 
                  [["EUR", "EUR"], ["USD", "USD"]], 
                  {}, 
                  { 
                    class: "form-select form-control-liquid",
                    required: true,
                    data: { 
                      product_form_target: "currencyField",
                      action: "change->product-form#validateField"
                    }
                  } %>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Devise principale du produit.
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <!-- Tab 3: Inventaire -->
    <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
      <div class="container-fluid px-0">
        <div class="card card-liquid">
        <div class="card-header card-liquid-primary">
          <h5 class="mb-0">
            <i class="bi bi-box-seam me-2"></i>Stock initial
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <%= f.label :stock_qty, "Stock initial", class: "form-label fw-semibold" %>
            <%= f.number_field :stock_qty, 
                class: "form-control form-control-liquid",
                min: 0,
                step: 1,
                value: @product.stock_qty || 0,
                data: { 
                  product_form_target: "stockField",
                  action: "input->product-form#autoSave"
                } %>
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              Le stock est géré au niveau des variantes. Ce champ sert de valeur par défaut pour les nouvelles variantes.
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <!-- Tab 4: Variantes -->
    <div class="tab-pane fade" id="variants" role="tabpanel" aria-labelledby="variants-tab">
      <div class="container-fluid px-0">
        <div class="card card-liquid">
        <div class="card-header card-liquid-primary">
          <h5 class="mb-0">
            <i class="bi bi-layers me-2"></i>Gestion des variantes
          </h5>
        </div>
        <div class="card-body">
          <%= render 'admin_panel/products/variants_section', form: f, product: @product, option_types: @option_types %>
        </div>
      </div>
      </div>
    </div>

    <!-- Tab 5: SEO -->
    <div class="tab-pane fade" id="seo" role="tabpanel" aria-labelledby="seo-tab">
      <div class="container-fluid px-0">
        <div class="card card-liquid">
        <div class="card-header card-liquid-primary">
          <h5 class="mb-0">
            <i class="bi bi-search me-2"></i>Optimisation SEO
          </h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Note :</strong> Les champs SEO sont optionnels mais recommandés pour améliorer la visibilité de votre produit dans les moteurs de recherche.
          </div>
          
          <div class="mb-4">
            <%= f.label :meta_title, "Meta Title", class: "form-label fw-semibold" %>
            <%= f.text_field :meta_title, 
                class: "form-control form-control-liquid",
                maxlength: 60,
                placeholder: "Titre pour les moteurs de recherche (max 60 caractères)",
                data: { 
                  product_form_target: "metaTitleField",
                  action: "input->product-form#updateCharCount"
                } %>
            <div class="form-text">
              <span class="char-count" data-product-form-target="metaTitleCharCount">0/60</span>
              Si vide, le nom du produit sera utilisé.
            </div>
          </div>

          <div class="mb-4">
            <%= f.label :meta_description, "Meta Description", class: "form-label fw-semibold" %>
            <%= f.text_area :meta_description,
                class: "form-control form-control-liquid",
                rows: 3,
                maxlength: 160,
                placeholder: "Description pour les moteurs de recherche (max 160 caractères)",
                data: { 
                  product_form_target: "metaDescriptionField",
                  action: "input->product-form#updateCharCount"
                } %>
            <div class="form-text">
              <span class="char-count" data-product-form-target="metaDescriptionCharCount">0/160</span>
              Si vide, la description du produit sera utilisée.
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- Barre de statut (Auto-save) -->
  <div class="form-status-bar position-fixed bottom-0 start-0 w-100 bg-white border-top p-3 shadow-lg"
       data-product-form-target="statusBar"
       style="z-index: 1000; display: none;">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <i class="bi bi-clock-history me-2"></i>
          <span data-product-form-target="statusMessage">Enregistrement automatique...</span>
        </div>
        <div>
          <span class="badge bg-success" data-product-form-target="lastSave" style="display: none;">
            Dernière sauvegarde : <span data-product-form-target="lastSaveTime"></span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions Footer -->
  <div class="d-flex justify-content-between mt-4 pt-4 border-top">
    <%= link_to "Annuler", 
        @product.persisted? ? admin_panel_product_path(@product) : admin_panel_products_path, 
        class: "btn btn-outline-secondary" %>
    <div class="btn-group">
      <%= f.submit "Enregistrer comme brouillon", 
          class: "btn btn-outline-primary", 
          name: "save_draft",
          data: { product_form_target: "draftButton" } %>
      <%= f.submit @product.persisted? ? "Mettre à jour" : "Créer le produit", 
          class: "btn btn-liquid-primary",
          name: "publish" %>
    </div>
  </div>
<% end %>

<!-- Script pour initialiser les tabs Bootstrap avec Turbo -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les tabs Bootstrap
    const triggerTabList = document.querySelectorAll('#productFormTabs button[data-bs-toggle="tab"]')
    triggerTabList.forEach(triggerEl => {
      const tabTrigger = new bootstrap.Tab(triggerEl)
      
      triggerEl.addEventListener('click', event => {
        event.preventDefault()
        tabTrigger.show()
      })
    })
  })

  // Réinitialiser après navigation Turbo
  document.addEventListener('turbo:load', function() {
    const triggerTabList = document.querySelectorAll('#productFormTabs button[data-bs-toggle="tab"]')
    triggerTabList.forEach(triggerEl => {
      const tabTrigger = new bootstrap.Tab(triggerEl)
      
      triggerEl.addEventListener('click', event => {
        event.preventDefault()
        tabTrigger.show()
      })
    })
  })
</script>
