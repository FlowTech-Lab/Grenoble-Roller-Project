<% 
  breadcrumb_items = [
    { label: "Candidatures Organisateur", url: nil }
  ]
%>

<%= render 'admin_panel/shared/breadcrumb', breadcrumb_items: breadcrumb_items %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Candidatures Organisateur</h1>
</div>

<!-- Filtres et recherche -->
<div class="card card-liquid rounded-liquid shadow-liquid mb-4">
  <div class="card-body">
    <%= search_form_for @q, url: admin_panel_organizer_applications_path, method: :get, class: "row g-3" do |f| %>
      <div class="col-md-4">
        <%= f.label :user_id_eq, "Utilisateur", class: "form-label" %>
        <%= f.select :user_id_eq, 
            options_from_collection_for_select(User.order(:last_name, :first_name), :id, :to_s, params.dig(:q, :user_id_eq)),
            { prompt: "Tous les utilisateurs" },
            { class: "form-select form-control-liquid" } %>
      </div>
      <div class="col-md-3">
        <%= f.label :status_eq, "Statut", class: "form-label" %>
        <%= f.select :status_eq, 
            options_for_select([
              ["Tous", ""],
              ["En attente", "pending"],
              ["Approuvée", "approved"],
              ["Refusée", "rejected"]
            ], params.dig(:q, :status_eq)),
            {},
            { class: "form-select form-control-liquid" } %>
      </div>
      <div class="col-md-3">
        <%= f.label :reviewed_by_id_eq, "Révisé par", class: "form-label" %>
        <%= f.select :reviewed_by_id_eq, 
            options_from_collection_for_select(User.order(:last_name, :first_name), :id, :to_s, params.dig(:q, :reviewed_by_id_eq)),
            { prompt: "Tous" },
            { class: "form-select form-control-liquid" } %>
      </div>
      <div class="col-md-2 d-flex align-items-end gap-2">
        <%= f.submit "Filtrer", class: "btn btn-outline-liquid-primary" %>
        <%= link_to "Réinitialiser", admin_panel_organizer_applications_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Onglets de filtres -->
<div class="mb-3">
  <%= link_to "Toutes", admin_panel_organizer_applications_path, 
      class: "btn btn-sm #{params[:scope].blank? ? 'btn-liquid-primary' : 'btn-outline-liquid-primary'}" %>
  <%= link_to "En attente", admin_panel_organizer_applications_path(scope: "pending"), 
      class: "btn btn-sm #{params[:scope] == 'pending' ? 'btn-liquid-primary' : 'btn-outline-liquid-primary'}" %>
  <%= link_to "Approuvées", admin_panel_organizer_applications_path(scope: "approved"), 
      class: "btn btn-sm #{params[:scope] == 'approved' ? 'btn-liquid-primary' : 'btn-outline-liquid-primary'}" %>
  <%= link_to "Refusées", admin_panel_organizer_applications_path(scope: "rejected"), 
      class: "btn btn-sm #{params[:scope] == 'rejected' ? 'btn-liquid-primary' : 'btn-outline-liquid-primary'}" %>
</div>

<!-- Tableau des candidatures -->
<div class="card card-liquid rounded-liquid shadow-liquid">
  <div class="card-body">
    <% if @organizer_applications.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Utilisateur</th>
              <th>Statut</th>
              <th>Révisé par</th>
              <th>Date de révision</th>
              <th>Date de création</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @organizer_applications.each do |application| %>
              <tr>
                <td>#<%= application.id %></td>
                <td>
                  <%= link_to application.user.to_s, admin_panel_user_path(application.user), class: "text-decoration-none" %>
                </td>
                <td>
                  <% badge_class = case application.status
                       when "approved" then "bg-success"
                       when "pending" then "bg-warning"
                       when "rejected" then "bg-danger"
                       else "bg-secondary"
                     end %>
                  <span class="badge <%= badge_class %>">
                    <%= application.status == "pending" ? "En attente" : application.status == "approved" ? "Approuvée" : "Refusée" %>
                  </span>
                </td>
                <td>
                  <% if application.reviewed_by.present? %>
                    <%= application.reviewed_by.to_s %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if application.reviewed_at.present? %>
                    <%= application.reviewed_at.strftime("%d/%m/%Y à %H:%M") %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <%= application.created_at.strftime("%d/%m/%Y à %H:%M") %>
                </td>
                <td>
                  <div class="d-flex gap-2">
                    <%= link_to "Voir", admin_panel_organizer_application_path(application), class: "btn btn-sm btn-outline-primary" %>
                    <% if application.pending? %>
                      <%= button_to "Approuver", approve_admin_panel_organizer_application_path(application), 
                          method: :patch, 
                          class: "btn btn-sm btn-success",
                          data: { confirm: "Êtes-vous sûr de vouloir approuver cette candidature ?" } %>
                      <%= button_to "Refuser", reject_admin_panel_organizer_application_path(application), 
                          method: :patch, 
                          class: "btn btn-sm btn-danger",
                          data: { confirm: "Êtes-vous sûr de vouloir refuser cette candidature ?" } %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="mt-3">
        <%== pagy_bootstrap_nav(@pagy) if @pagy.pages > 1 %>
      </div>
    <% else %>
      <p class="text-muted text-center py-4">Aucune candidature trouvée</p>
    <% end %>
  </div>
</div>
