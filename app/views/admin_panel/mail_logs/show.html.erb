<div class="admin-mail-logs">
  <!-- HEADER -->
  <div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
      <h1>üìß D√©tails de l'Email</h1>
      <p class="text-muted">Job ID: <%= @job.id %></p>
    </div>
    <div>
      <%= link_to admin_panel_mail_logs_path, class: "btn btn-outline-secondary" do %>
        <i class="bi bi-arrow-left me-2"></i>Retour √† la liste
      <% end %>
    </div>
  </div>

  <!-- INFORMATIONS G√âN√âRALES -->
  <div class="card card-liquid rounded-liquid shadow-liquid mb-4">
    <div class="card-header">
      <h5 class="mb-0">Informations G√©n√©rales</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <dl class="row">
            <dt class="col-sm-4">ID Job:</dt>
            <dd class="col-sm-8"><code><%= @job.id %></code></dd>

            <dt class="col-sm-4">Mailer:</dt>
            <dd class="col-sm-8">
              <% if @mailer_info[:mailer] %>
                <code><%= @mailer_info[:mailer] %></code>
              <% else %>
                <span class="text-muted">N/A</span>
                <small class="d-block text-danger">‚ö†Ô∏è Format arguments non reconnu</small>
              <% end %>
            </dd>

            <dt class="col-sm-4">M√©thode:</dt>
            <dd class="col-sm-8">
              <% if @mailer_info[:method] %>
                <span class="badge badge-liquid-secondary"><%= @mailer_info[:method] %></span>
              <% else %>
                <span class="text-muted">N/A</span>
              <% end %>
            </dd>

            <dt class="col-sm-4">Queue:</dt>
            <dd class="col-sm-8"><%= @job.queue_name %></dd>
          </dl>
        </div>
        <div class="col-md-6">
          <dl class="row">
            <dt class="col-sm-4">Statut:</dt>
            <dd class="col-sm-8">
              <% if @failed_execution %>
                <span class="badge badge-liquid-danger">√âchec</span>
              <% elsif @job.finished_at.nil? %>
                <span class="badge badge-liquid-warning">En attente</span>
                <% if @job.created_at < 5.minutes.ago %>
                  <small class="d-block text-warning mt-1">‚ö†Ô∏è En attente depuis <%= time_ago_in_words(@job.created_at) %></small>
                <% end %>
              <% else %>
                <span class="badge badge-liquid-success">Termin√©</span>
              <% end %>
            </dd>

            <dt class="col-sm-4">Cr√©√© le:</dt>
            <dd class="col-sm-8"><%= l(@job.created_at, format: :long) %></dd>

            <dt class="col-sm-4">Termin√© le:</dt>
            <dd class="col-sm-8">
              <% if @job.finished_at %>
                <%= l(@job.finished_at, format: :long) %>
              <% else %>
                <span class="text-muted">En cours...</span>
              <% end %>
            </dd>

            <dt class="col-sm-4">Priorit√©:</dt>
            <dd class="col-sm-8"><%= @job.priority %></dd>
          </dl>
        </div>
      </div>
      
      <% if @job.finished_at.nil? && @job.created_at < 5.minutes.ago %>
        <div class="alert alert-warning mt-3 mb-0">
          <strong>‚ö†Ô∏è Job en attente</strong>
          <p class="mb-0 small">
            Ce job est en attente depuis <%= time_ago_in_words(@job.created_at) %>. 
            V√©rifiez que Solid Queue est d√©marr√© et qu'il traite les jobs de la queue "<%= @job.queue_name %>".
            <br>
            <strong>V√©rifications possibles :</strong>
            <ul class="mb-0 mt-2">
              <li>Solid Queue est-il d√©marr√© ? (<code>SOLID_QUEUE_IN_PUMA: true</code> ou processus s√©par√©)</li>
              <li>Y a-t-il des erreurs dans les logs Rails ?</li>
              <li>La queue "<%= @job.queue_name %>" est-elle en pause ?</li>
            </ul>
          </p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ERREUR (si √©chec) -->
  <% if @failed_execution %>
    <div class="card card-liquid rounded-liquid shadow-liquid mb-4 border-danger">
      <div class="card-header" style="background: var(--gradient-liquid-danger); color: white;">
        <h5 class="mb-0">‚ùå Erreur</h5>
      </div>
      <div class="card-body">
        <pre class="p-3 rounded border"><%= @failed_execution.error %></pre>
      </div>
    </div>
  <% end %>

  <!-- ARGUMENTS -->
  <div class="card card-liquid rounded-liquid shadow-liquid mb-4">
    <div class="card-header">
      <h5 class="mb-0">Arguments</h5>
    </div>
    <div class="card-body">
      <pre class="p-3 rounded border"><% 
        # SolidQueue peut stocker les arguments comme String JSON ou d√©j√† d√©s√©rialis√©s
        # Format ActiveJob: Hash avec cl√© "arguments"
        args_display = if @job.arguments.is_a?(String)
          begin
            parsed = JSON.parse(@job.arguments)
            JSON.pretty_generate(parsed)
          rescue JSON::ParserError
            @job.arguments
          end
        elsif @job.arguments.is_a?(Hash)
          # Si c'est un Hash (format ActiveJob), afficher le hash complet
          JSON.pretty_generate(@job.arguments)
        else
          # Si c'est un Array ou autre chose
          JSON.pretty_generate(@job.arguments)
        end
      %><%= args_display %></pre>
      
      <% if @job.arguments.is_a?(Hash) && @job.arguments["arguments"].is_a?(Array) %>
        <div class="mt-3">
          <small class="text-muted">
            <strong>Arguments extraits:</strong>
            <% args = @job.arguments["arguments"] %>
            <% if args.length >= 2 %>
              Mailer: <code><%= args[0] %></code>, 
              M√©thode: <code><%= args[1] %></code>
              <% if args.length > 2 %>
                , Mode: <code><%= args[2] %></code>
              <% end %>
            <% end %>
          </small>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="card card-liquid rounded-liquid shadow-liquid">
    <div class="card-body">
      <div class="d-flex gap-2">
        <%= link_to "/admin-panel/jobs", class: "btn btn-outline-primary" do %>
          <i class="bi bi-speedometer2 me-2"></i>Voir dans Mission Control
        <% end %>
        <%= link_to admin_panel_mail_logs_path, class: "btn btn-outline-secondary" do %>
          <i class="bi bi-arrow-left me-2"></i>Retour √† la liste
        <% end %>
      </div>
    </div>
  </div>
</div>

