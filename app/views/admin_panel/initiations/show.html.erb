<% 
  breadcrumb_items = [
    { label: "Initiations", url: admin_panel_initiations_path },
    { label: @initiation.title, url: nil }
  ]
%>

<%= render 'admin_panel/shared/breadcrumb', breadcrumb_items: breadcrumb_items %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><%= @initiation.title %></h1>
  <div class="btn-group">
    <%= link_to "Présences", presences_admin_panel_initiation_path(@initiation), class: "btn btn-primary" %>
    <% if current_user&.role&.level.to_i >= 60 %>
      <%= link_to "Éditer", edit_initiation_path(@initiation), class: "btn btn-outline-warning", target: "_blank" %>
    <% end %>
    <%= link_to "Retour", admin_panel_initiations_path, class: "btn btn-outline-secondary" %>
  </div>
</div>

<!-- Détails Initiation -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Détails</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <p><strong>Date :</strong> <%= l(@initiation.start_at, format: :long) if @initiation.start_at %></p>
        <p><strong>Heure :</strong> 10h15-12h00</p>
        <p><strong>Lieu :</strong> <%= @initiation.location_text %></p>
      </div>
      <div class="col-md-6">
        <p><strong>Statut :</strong>
          <% case @initiation.status %>
          <% when 'published' %>
            <span class="badge bg-success">Publié</span>
          <% when 'draft' %>
            <span class="badge bg-secondary">Brouillon</span>
          <% when 'canceled' %>
            <span class="badge bg-danger">Annulé</span>
          <% end %>
        </p>
        <p><strong>Places :</strong>
          <% if @initiation.full? %>
            <span class="badge bg-danger">COMPLET</span>
          <% else %>
            <span class="badge bg-success">
              <%= @initiation.participants_count %>/<%= @initiation.max_participants %>
            </span>
          <% end %>
        </p>
        <p><strong>Bénévoles :</strong> <%= @initiation.volunteers_count %></p>
      </div>
    </div>
    <% if @initiation.description.present? %>
      <hr>
      <p><strong>Description :</strong></p>
      <p><%= simple_format(@initiation.description) %></p>
    <% end %>
  </div>
</div>

<!-- Panel Bénévoles -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Bénévoles (<%= @volunteers.count %>)</h5>
  </div>
  <div class="card-body">
    <% if @volunteers.any? %>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Email</th>
              <th>Statut</th>
              <th>Matériel</th>
              <th>Essai gratuit</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @volunteers.each do |attendance| %>
              <tr>
                <td><%= attendance.participant_name %></td>
                <td><%= attendance.user.email %></td>
                <td>
                  <span class="badge bg-<%= attendance.status == 'present' ? 'success' : 'secondary' %>">
                    <%= attendance_status_fr(attendance.status) %>
                  </span>
                </td>
                <td>
                  <% if attendance.needs_equipment? %>
                    <% if attendance.roller_size.present? %>
                      <span class="badge bg-info">Taille: <%= attendance.roller_size %></span>
                    <% end %>
                    <% if attendance.equipment_note.present? %>
                      <br><small class="text-muted"><%= attendance.equipment_note %></small>
                    <% end %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if attendance.free_trial_used? %>
                    <span class="badge bg-danger">Oui</span>
                  <% else %>
                    <span class="text-muted">Non</span>
                  <% end %>
                </td>
                <td>
                  <%= button_to "Retirer bénévole", toggle_volunteer_admin_panel_initiation_path(@initiation, attendance_id: attendance.id),
                      method: :patch, class: "btn btn-sm btn-outline-warning" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">Aucun bénévole inscrit.</p>
    <% end %>
  </div>
</div>

<!-- Panel Participants -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Participants (<%= @participants.count %>)</h5>
  </div>
  <div class="card-body">
    <% if @participants.any? %>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Email</th>
              <th>Type</th>
              <th>Statut</th>
              <th>Matériel</th>
              <th>Essai gratuit</th>
              <th>Adhésion</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @participants.each do |attendance| %>
              <tr>
                <td><%= attendance.participant_name %></td>
                <td><%= attendance.user.email %></td>
                <td>
                  <% if attendance.for_child? %>
                    <span class="badge bg-info">Enfant</span>
                  <% else %>
                    <span class="badge bg-primary">Parent</span>
                  <% end %>
                </td>
                <td>
                  <span class="badge bg-<%= attendance.status == 'present' ? 'success' : 'secondary' %>">
                    <%= attendance_status_fr(attendance.status) %>
                  </span>
                </td>
                <td>
                  <% if attendance.needs_equipment? %>
                    <% if attendance.roller_size.present? %>
                      <span class="badge bg-info">Taille: <%= attendance.roller_size %></span>
                    <% end %>
                    <% if attendance.equipment_note.present? %>
                      <br><small class="text-muted"><%= attendance.equipment_note %></small>
                    <% end %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if attendance.free_trial_used? %>
                    <span class="badge bg-danger">Oui</span>
                  <% else %>
                    <span class="text-muted">Non</span>
                  <% end %>
                </td>
                <td>
                  <% is_member = attendance.for_child? ? 
                      attendance.child_membership&.active? : 
                      attendance.user.memberships.active_now.exists? %>
                  <% if is_member %>
                    <span class="badge bg-success">Adhérent</span>
                  <% else %>
                    <span class="badge bg-warning">Non adhérent</span>
                  <% end %>
                </td>
                <td>
                  <%= button_to "Ajouter bénévole", toggle_volunteer_admin_panel_initiation_path(@initiation, attendance_id: attendance.id),
                      method: :patch, class: "btn btn-sm btn-outline-success" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">Aucun participant inscrit.</p>
    <% end %>
  </div>
</div>

<!-- Panel Matériel demandé -->
<% if @equipment_requests.any? %>
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Matériel demandé</h5>
      <%= link_to "Gérer le stock", admin_panel_roller_stocks_path, class: "btn btn-sm btn-outline-primary" %>
    </div>
    <div class="card-body">
      <div class="row">
        <% @equipment_requests.each do |size, count| %>
          <div class="col-md-3 mb-2">
            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
              <span><strong>Taille <%= size %></strong></span>
              <span class="badge bg-primary"><%= count %> demande<%= 's' if count > 1 %></span>
            </div>
          </div>
        <% end %>
      </div>
      <div class="mt-3">
        <small class="text-muted">
          <i class="bi bi-info-circle"></i> 
          Total : <%= @equipment_requests.values.sum %> demande<%= 's' if @equipment_requests.values.sum > 1 %> de matériel
        </small>
      </div>
    </div>
  </div>
<% end %>

<!-- Panel Liste d'attente -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Liste d'attente (<%= @waitlist_entries.count %>)</h5>
  </div>
  <div class="card-body">
    <% if @waitlist_entries.any? %>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Position</th>
              <th>Nom</th>
              <th>Email</th>
              <th>Matériel</th>
              <th>Statut</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @waitlist_entries.each do |entry| %>
              <tr>
                <td><strong>#<%= entry.position %></strong></td>
                <td><%= entry.participant_name %></td>
                <td><%= entry.user.email %></td>
                <td>
                  <% if entry.needs_equipment? %>
                    <% if entry.roller_size.present? %>
                      <span class="badge bg-info">Taille: <%= entry.roller_size %></span>
                    <% end %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% case entry.status %>
                  <% when 'pending' %>
                    <span class="badge bg-secondary"><%= waitlist_status_fr(entry.status) %></span>
                  <% when 'notified' %>
                    <span class="badge bg-warning"><%= waitlist_status_fr(entry.status) %></span>
                  <% when 'converted' %>
                    <span class="badge bg-success"><%= waitlist_status_fr(entry.status) %></span>
                  <% when 'cancelled' %>
                    <span class="badge bg-danger"><%= waitlist_status_fr(entry.status) %></span>
                  <% else %>
                    <span class="badge bg-secondary"><%= waitlist_status_fr(entry.status) %></span>
                  <% end %>
                </td>
                <td><%= l(entry.created_at, format: :short) %></td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <% if entry.pending? %>
                      <%= button_to "Notifier", notify_waitlist_admin_panel_initiation_path(@initiation, waitlist_entry_id: entry.hashid),
                          method: :post, class: "btn btn-outline-warning" %>
                    <% elsif entry.notified? %>
                      <%= button_to "Convertir", convert_waitlist_admin_panel_initiation_path(@initiation, waitlist_entry_id: entry.hashid),
                          method: :post, class: "btn btn-outline-success" %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">Aucune personne en liste d'attente.</p>
    <% end %>
  </div>
</div>
