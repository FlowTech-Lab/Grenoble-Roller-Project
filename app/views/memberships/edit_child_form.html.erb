<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card card-liquid rounded-liquid shadow-liquid">
        <div class="card-body p-4">
          <!-- Header -->
          <div class="text-center mb-4 pb-3 border-bottom">
            <h1 class="h4 mb-2">
              <i class="bi bi-pencil text-liquid-warning me-2"></i>MODIFIER L'ADHÉSION DE <%= @membership.child_full_name.upcase %>
            </h1>
            <p class="text-muted small mb-0">
              Saison <%= @season %> - Valable du <%= l(@start_date, format: :long) %> au <%= l(@end_date, format: :long) %>
            </p>
          </div>

          <%= form_with model: @membership, url: update_child_membership_path(@membership), method: :patch, local: true, data: { turbo: false } do |f| %>
            <!-- Étape 1 : Choix de la catégorie -->
            <div class="mb-4">
              <h3 class="h5 mb-3">1. Choisissez l'adhésion</h3>
              <div class="row g-3">
                <% @categories.each do |key, cat| %>
                  <div class="col-md-6">
                    <div class="card card-liquid h-100" style="background: var(--liquid-glass-bg); border: 2px solid var(--card-border-color);">
                      <div class="card-body">
                        <div class="form-check">
                          <%= f.radio_button :category, key, 
                              { class: "form-check-input", id: "category_#{key}", required: true, checked: @membership.category == key.to_s } %>
                          <label class="form-check-label w-100" for="category_<%= key %>">
                            <strong><%= cat[:name] %></strong>
                            <p class="text-muted small mb-2"><%= cat[:description] %></p>
                            <p class="mb-0">
                              <strong class="text-liquid-primary">
                                <%= number_to_currency(cat[:price_cents] / 100.0, unit: "€", separator: ",", delimiter: " ", format: "%n %u") %>
                              </strong>
                            </p>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Étape 2 : Informations enfant -->
            <div class="mb-4">
              <h3 class="h5 mb-3">2. Informations de l'enfant</h3>
              <div class="row g-3">
                <div class="col-md-6">
                  <%= f.label :child_first_name, "Prénom de l'enfant *", class: "form-label" %>
                  <%= f.text_field :child_first_name, 
                      class: "form-control", 
                      required: true,
                      placeholder: "Prénom",
                      value: @membership.child_first_name %>
                </div>
                <div class="col-md-6">
                  <%= f.label :child_last_name, "Nom de l'enfant *", class: "form-label" %>
                  <%= f.text_field :child_last_name, 
                      class: "form-control", 
                      required: true,
                      placeholder: "Nom",
                      value: @membership.child_last_name %>
                </div>
                <div class="col-md-12">
                  <label class="form-label">
                    <i class="bi bi-calendar3 me-1"></i>Date de naissance de l'enfant *
                  </label>
                  <div class="row g-2">
                    <% 
                      birth_date = @membership.child_date_of_birth || Date.today
                      selected_day = birth_date.day
                      selected_month = birth_date.month
                      selected_year = birth_date.year
                    %>
                    <div class="col-4">
                      <%= f.select :child_date_of_birth_day, 
                          options_for_select((1..31).map { |d| [d, d] }, selected_day), 
                          { prompt: "Jour", include_blank: true },
                          { 
                            class: "form-select", 
                            id: "child_date_of_birth_day",
                            required: true,
                            onchange: "updateChildDateOfBirth()"
                          } %>
                    </div>
                    <div class="col-4">
                      <%= f.select :child_date_of_birth_month, 
                          options_for_select([
                            ["Janvier", 1], ["Février", 2], ["Mars", 3], ["Avril", 4],
                            ["Mai", 5], ["Juin", 6], ["Juillet", 7], ["Août", 8],
                            ["Septembre", 9], ["Octobre", 10], ["Novembre", 11], ["Décembre", 12]
                          ], selected_month), 
                          { prompt: "Mois", include_blank: true },
                          { 
                            class: "form-select", 
                            id: "child_date_of_birth_month",
                            required: true,
                            onchange: "updateChildDateOfBirth()"
                          } %>
                    </div>
                    <div class="col-4">
                      <%= f.select :child_date_of_birth_year, 
                          options_for_select(Date.today.year.downto(Date.today.year - 18).map { |y| [y, y] }, selected_year), 
                          { prompt: "Année", include_blank: true },
                          { 
                            class: "form-select", 
                            id: "child_date_of_birth_year",
                            required: true,
                            onchange: "updateChildDateOfBirth()"
                          } %>
                    </div>
                  </div>
                  <%= f.hidden_field :child_date_of_birth, id: "child_date_of_birth", value: @membership.child_date_of_birth %>
                  <div class="form-text small">
                    <i class="bi bi-info-circle me-1"></i>L'âge sera calculé automatiquement à partir de la date sélectionnée.
                  </div>
                </div>
              </div>
            </div>

            <!-- Étape 3 : Autorisation parentale (si < 16 ans) -->
            <div class="mb-4" id="parent_authorization_section" style="display: none;">
              <h3 class="h5 mb-3">3. Autorisation parentale</h3>
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Obligatoire pour les enfants de moins de 16 ans</strong>
              </div>
              <div class="form-check">
                <%= f.check_box :parent_authorization, 
                    { class: "form-check-input", id: "parent_authorization", checked: @membership.parent_authorization }, 
                    "1", "0" %>
                <label class="form-check-label" for="parent_authorization">
                  <strong>Je, soussigné(e) <%= "#{@user.first_name} #{@user.last_name}" %>, représentant légal de l'enfant,</strong>
                  <ul class="mt-2 mb-0 small">
                    <li>Accepte que mon enfant adhère à Grenoble Roller</li>
                    <li>Accepte que mon enfant pratique le roller</li>
                    <li>Accepte le paiement de la cotisation</li>
                    <li>Accepte les conditions d'adhésion et la politique de confidentialité</li>
                    <li>Accepte les risques inhérents au roller</li>
                  </ul>
                </label>
              </div>
            </div>

            <!-- Étape 4 : Santé -->
            <div class="mb-4">
              <h3 class="h5 mb-3">4. Questionnaire de santé</h3>
              <div class="form-check mb-3">
                <%= f.radio_button :has_health_issues, "0", 
                    { class: "form-check-input", id: "health_ok", checked: @membership.health_questionnaire_status == "ok" } %>
                <label class="form-check-label" for="health_ok">
                  <strong>L'enfant n'a pas de problèmes de santé</strong>
                  <p class="text-muted small mb-0">Une attestation parentale de santé suffit (valable 3 ans)</p>
                </label>
              </div>
              <div class="form-check">
                <%= f.radio_button :has_health_issues, "1", 
                    { class: "form-check-input", id: "health_issues", checked: @membership.health_questionnaire_status == "medical_required" } %>
                <label class="form-check-label" for="health_issues">
                  <strong>L'enfant a des problèmes de santé</strong>
                  <p class="text-muted small mb-0">Un certificat médical sera requis (valable 6 mois)</p>
                </label>
              </div>
            </div>

            <!-- Étape 5 : Options -->
            <div class="mb-4">
              <h3 class="h5 mb-3">5. Options</h3>
              <div class="form-check mb-3">
                <%= f.check_box :wants_whatsapp, 
                    { class: "form-check-input", id: "wants_whatsapp", checked: @membership.wants_whatsapp }, 
                    "1", "0" %>
                <label class="form-check-label" for="wants_whatsapp">
                  Je souhaite que l'enfant rejoigne la communauté WhatsApp
                </label>
              </div>
              <div class="form-check">
                <%= f.check_box :wants_email_info, 
                    { class: "form-check-input", id: "wants_email_info", checked: @membership.wants_email_info }, 
                    "1", "0" %>
                <label class="form-check-label" for="wants_email_info">
                  Réception de mail d'information (rando/initiation) ou d'évènement Grenoble Roller
                </label>
              </div>
            </div>

            <!-- Étape 6 : Consentements -->
            <div class="mb-4">
              <h3 class="h5 mb-3">6. Consentements</h3>
              <div class="form-check mb-3">
                <%= f.check_box :rgpd_consent, 
                    { class: "form-check-input", id: "rgpd_consent", required: true, checked: @membership.rgpd_consent }, 
                    "1", "0" %>
                <label class="form-check-label" for="rgpd_consent">
                  J'accepte que Grenoble Roller collecte les données de l'enfant pour l'adhésion *
                </label>
              </div>
              <div class="form-check mb-3">
                <%= f.check_box :legal_notices_accepted, 
                    { class: "form-check-input", id: "legal_notices_accepted", required: true, checked: @membership.legal_notices_accepted }, 
                    "1", "0" %>
                <label class="form-check-label" for="legal_notices_accepted">
                  J'accepte les conditions générales et la politique de confidentialité *
                </label>
              </div>
              <div class="form-check">
                <%= f.check_box :ffrs_data_sharing_consent, 
                    { class: "form-check-input", id: "ffrs_data_sharing_consent", checked: @membership.ffrs_data_sharing_consent }, 
                    "1", "0" %>
                <label class="form-check-label" for="ffrs_data_sharing_consent">
                  J'autorise le partage des données avec la FFRS (si licence FFRS)
                </label>
              </div>
            </div>

            <!-- Boutons -->
            <div class="d-flex justify-content-between mt-4">
              <%= link_to memberships_path, class: "btn btn-outline-secondary" do %>
                <i class="bi bi-arrow-left me-1"></i>Retour
              <% end %>
              <%= f.submit "Enregistrer les modifications", 
                  class: "btn btn-liquid-warning btn-lg" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Mettre à jour le champ caché date_of_birth à partir des 3 sélecteurs
  function updateChildDateOfBirth() {
    const day = document.getElementById('child_date_of_birth_day').value;
    const month = document.getElementById('child_date_of_birth_month').value;
    const year = document.getElementById('child_date_of_birth_year').value;
    const hiddenField = document.getElementById('child_date_of_birth');
    
    if (day && month && year) {
      // Format: YYYY-MM-DD pour le champ caché
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      hiddenField.value = dateStr;
      checkChildAge();
    } else {
      hiddenField.value = '';
      checkChildAge();
    }
  }
  
  // Afficher/masquer la section autorisation parentale selon l'âge
  function checkChildAge() {
    const day = document.getElementById('child_date_of_birth_day').value;
    const month = document.getElementById('child_date_of_birth_month').value;
    const year = document.getElementById('child_date_of_birth_year').value;
    const authorizationSection = document.getElementById('parent_authorization_section');
    const authorizationCheckbox = document.getElementById('parent_authorization');
    
    if (!day || !month || !year) {
      if (authorizationSection) authorizationSection.style.display = 'none';
      return;
    }
    
    const birthDate = new Date(year, month - 1, day); // month est 0-indexed en JS
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    if (age < 16) {
      if (authorizationSection) {
        authorizationSection.style.display = 'block';
        if (authorizationCheckbox) authorizationCheckbox.required = true;
      }
    } else {
      if (authorizationSection) {
        authorizationSection.style.display = 'none';
        if (authorizationCheckbox) {
          authorizationCheckbox.required = false;
          authorizationCheckbox.checked = false;
        }
      }
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    checkChildAge(); // Vérifier au chargement si une date est déjà présente
  });
</script>

