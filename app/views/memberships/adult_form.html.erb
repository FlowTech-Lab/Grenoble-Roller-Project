  <% 
  # Définir l'étape courante (pour le stepper)
  # Catégorie en premier (étape 1)
  current_step = 1 # Commence toujours par la catégorie
  total_steps = 5
%>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <!-- HERO SECTION -->
      <div class="hero-form">
        <div class="text-center">
          <h1 class="hero-title">MON ADHÉSION</h1>
          <p class="hero-subtitle">Rejoignez Grenoble Roller et profitez de tous les avantages</p>
          
          <div class="hero-badges">
            <span class="badge">
              <i class="bi bi-calendar-event me-1"></i>
              Saison <%= @season %>
            </span>
            <span class="badge">
              <i class="bi bi-calendar-range me-1"></i>
              <%= l(@start_date, format: :short) %> → <%= l(@end_date, format: :short) %>
            </span>
          </div>
          
          <div class="hero-progress">
            <div class="progress-text">
              <span>Étape <%= current_step %>/<%= total_steps %> — Catégorie</span>
              <span><%= (current_step.to_f / total_steps * 100).round %>% complété</span>
            </div>
            <div class="progress-bar-custom">
              <div class="progress-fill green" style="width: <%= (current_step.to_f / total_steps * 100) %>%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEPPER -->
      <%= render partial: 'form_stepper', locals: { form_type: 'adult', current_step: current_step, with_tshirt: false } %>

      <!-- MAIN FORM -->
      <div class="card card-liquid rounded-liquid shadow-liquid">
        <div class="card-body p-4">
          <%= form_with model: Membership.new, url: memberships_path, method: :post, local: true, data: { turbo: false }, id: "adult_membership_form", multipart: true do |f| %>
            <%= f.hidden_field :type, value: "adult" %>
            <%= f.hidden_field :with_tshirt, value: 'false', id: "with_tshirt_hidden" %>
            <%= hidden_field_tag :payment_method, "helloasso", id: "payment_method_field" %>
            
            <!-- ÉTAPE 1 : CATÉGORIE -->
            <div class="form-section" id="step-category">
              <h3 class="section-title">
                <span class="section-number">1</span>
                Choisissez votre adhésion
              </h3>
              <p class="section-intro">Sélectionnez la formule qui vous correspond</p>
              
              <div class="row g-3">
                <% @categories.each do |key, cat| %>
                  <div class="col-md-6">
                    <label for="category_<%= key %>" class="category-card <%= 'selected' if key == :standard %>" onclick="selectCategory('<%= key %>')">
                      <div class="category-title"><%= cat[:name] %></div>
                      <div class="category-description"><%= cat[:description] %></div>
                      <div class="category-footer d-flex justify-content-between align-items-center mt-auto">
                        <div class="category-select">
                          <%= f.radio_button :category, key, 
                              { class: "form-check-input", id: "category_#{key}", required: true, onchange: "updateCategorySelection()" } %>
                          <span id="category_label_<%= key %>">Sélectionner</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <div class="category-price">
                            <%= number_to_currency(cat[:price_cents] / 100.0, unit: "€", separator: ",", delimiter: " ", format: "%n %u") %>
                          </div>
                          <% if key == :standard %>
                            <span class="category-badge">
                              <i class="bi bi-star-fill me-1"></i>Best-seller
                            </span>
                          <% end %>
                        </div>
                      </div>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
            
            <!-- ÉTAPE 2 : INFORMATIONS -->
            <div class="form-section" id="step-info">
              <h3 class="section-title">
                <span class="section-number">2</span>
                Vos informations
              </h3>
              <p class="section-intro">Vos données aident l'association à mieux vous connaître</p>
              
              <div class="row g-3">
                <div class="col-md-6">
                  <%= f.label :first_name, "Prénom *", class: "form-label fw-bold" %>
                  <%= f.text_field :first_name, 
                      class: "form-control form-control-lg", 
                      value: @user.first_name.presence,
                      required: true,
                      onblur: "validateField(this)" %>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6">
                  <%= f.label :last_name, "Nom *", class: "form-label fw-bold" %>
                  <%= f.text_field :last_name, 
                      class: "form-control form-control-lg", 
                      value: @user.last_name.presence,
                      required: true,
                      onblur: "validateField(this)" %>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6">
                  <%= f.label :email, "Email *", class: "form-label fw-bold" %>
                  <%= f.email_field :email, 
                      class: "form-control form-control-lg", 
                      value: @user.email,
                      required: true,
                      readonly: true,
                      tabindex: -1 %>
                  <div class="form-text small mt-1">
                    <i class="bi bi-check-circle text-success me-1"></i>
                    Confirmé : <%= @user.email %>
                  </div>
                </div>
                <div class="col-md-6">
                  <%= f.label :phone, "Téléphone *", class: "form-label fw-bold" %>
                  <div data-controller="phone-mask">
                    <%= f.telephone_field :phone, 
                        class: "form-control form-control-lg", 
                        value: @user.phone.presence,
                        required: true,
                        placeholder: "Téléphone",
                        maxlength: 14,
                        pattern: "[0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}",
                        data: { 
                          phone_mask_target: "input",
                          action: "input->phone-mask#format"
                        },
                        onblur: "validateField(this)" %>
                  </div>
                  <div class="form-text small mt-1">
                    Format : 10 chiffres avec espaces (ex: 06 12 34 56 78)
                  </div>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-12">
                  <%= f.label :date_of_birth, "Date de naissance *", class: "form-label fw-bold" do %>
                    <i class="bi bi-calendar3 me-1"></i>Date de naissance
                  <% end %>
                  <div class="row g-2">
                    <div class="col-4">
                      <%= f.select :date_of_birth_day, 
                          options_for_select((1..31).map { |d| [d, d] }, @user.date_of_birth&.day), 
                          { prompt: "Jour", include_blank: true },
                          { 
                            class: "form-select form-select-lg", 
                            id: "date_of_birth_day",
                            required: true,
                            onchange: "updateAdultDateOfBirth()"
                          } %>
                    </div>
                    <div class="col-4">
                      <%= f.select :date_of_birth_month, 
                          options_for_select([
                            ["Janvier", 1], ["Février", 2], ["Mars", 3], ["Avril", 4],
                            ["Mai", 5], ["Juin", 6], ["Juillet", 7], ["Août", 8],
                            ["Septembre", 9], ["Octobre", 10], ["Novembre", 11], ["Décembre", 12]
                          ], @user.date_of_birth&.month), 
                          { prompt: "Mois", include_blank: true },
                          { 
                            class: "form-select form-select-lg", 
                            id: "date_of_birth_month",
                            required: true,
                            onchange: "updateAdultDateOfBirth()"
                          } %>
                    </div>
                    <div class="col-4">
                      <%= f.select :date_of_birth_year, 
                          options_for_select(Date.today.year.downto(Date.today.year - 120).map { |y| [y, y] }, @user.date_of_birth&.year), 
                          { prompt: "Année", include_blank: true },
                          { 
                            class: "form-select form-select-lg", 
                            id: "date_of_birth_year",
                            required: true,
                            onchange: "updateAdultDateOfBirth()"
                          } %>
                    </div>
                  </div>
                  <%= f.hidden_field :date_of_birth, id: "date_of_birth" %>
                  <div class="age-display mt-2" id="adult_age_display" style="display: none;">
                    <i class="bi bi-info-circle me-1"></i>Âge : <strong id="adult_age_value"></strong> ans
                  </div>
                  <div class="invalid-feedback d-block mt-2" id="date_of_birth_error" style="display: none;"></div>
                  <div class="alert alert-warning mt-2" id="date_of_birth_warning" style="display: none;"></div>
                </div>
              </div>
            </div>

            <!-- ÉTAPE <%= @with_tshirt ? 4 : 3 %> : COORDONNÉES -->
            <div class="form-section" id="step-address">
              <h3 class="section-title">
                <span class="section-number"><%= @with_tshirt ? 4 : 3 %></span>
                Vos coordonnées
              </h3>
              
              <div class="row g-3">
                <div class="col-12">
                  <%= f.label :address, "Adresse *", class: "form-label fw-bold" %>
                <%= f.text_field :address, 
                    class: "form-control form-control-lg", 
                    value: @user.address.presence,
                    required: true,
                    placeholder: "Adresse",
                      onblur: "validateField(this)" %>
                  <div class="form-text small mt-1">
                    <i class="bi bi-info-circle me-1"></i>
                    Suggestions d'adresses disponibles
                  </div>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6">
                  <%= f.label :city, "Ville *", class: "form-label fw-bold" %>
                <%= f.text_field :city, 
                    class: "form-control form-control-lg", 
                    value: @user.city.presence,
                    required: true,
                      onblur: "validateField(this)" %>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6">
                  <%= f.label :postal_code, "Code postal *", class: "form-label fw-bold" %>
                <%= f.text_field :postal_code, 
                    class: "form-control form-control-lg", 
                    value: @user.postal_code.presence,
                    required: true,
                      pattern: "[0-9]{5}",
                      placeholder: "Code postal",
                      onblur: "validateField(this)" %>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-12">
                  <%= f.label :country, "Pays", class: "form-label fw-bold" %>
                  <%= f.select :country, 
                      options_for_select([["France", "FR"]], "FR"),
                      {},
                      { class: "form-select form-select-lg" } %>
                </div>
              </div>
            </div>

            <!-- ÉTAPE <%= @with_tshirt ? 5 : 4 %> : QUESTIONNAIRE SANTÉ -->
            <div class="form-section" id="step-health">
              <h3 class="section-title">
                <span class="section-number"><%= @with_tshirt ? 5 : 4 %></span>
                Questionnaire de santé
              </h3>
              <p class="section-intro" id="health_intro_standard" style="display: none;">
                Répondez honnêtement aux questions suivantes concernant votre santé. Vos réponses nous aident à mieux vous accompagner.
              </p>
              <p class="section-intro" id="health_intro_ffrs" style="display: none;">
                <strong>Questionnaire obligatoire pour la licence FFRS.</strong> Répondez aux questions suivantes concernant votre santé.
              </p>
              
              <div class="card card-liquid mt-3">
                <div class="card-body">
                  <div class="health-questions">
                    <% health_questions = [
                      { id: 'health_q1', text: "Un membre de votre famille a-t-il eu une mort subite ou inexpliquée ?" },
                      { id: 'health_q2', text: "Avez-vous ressenti une douleur dans la poitrine, des palpitations ou un essoufflement lors d'un effort ?" },
                      { id: 'health_q3', text: "Avez-vous eu un épisode de respiration sifflante (asthme) ?" },
                      { id: 'health_q4', text: "Avez-vous eu une perte de connaissance ou une chute suite à un malaise ?" },
                      { id: 'health_q5', text: "Si vous avez arrêté le sport 30 jours+, avez-vous repris sans l'avis d'un médecin ?" },
                      { id: 'health_q6', text: "Avez-vous débuté un traitement médical de longue durée ?" },
                      { id: 'health_q7', text: "Avez-vous des problèmes de santé survenus ces 12 derniers mois ?" },
                      { id: 'health_q8', text: "Votre pratique sportive est-elle interrompue pour des raisons de santé ?" },
                      { id: 'health_q9', text: "Pensez-vous avoir besoin d'un avis médical pour continuer le sport ?" }
                    ] %>
                    
                    <% health_questions.each_with_index do |question, index| %>
                      <div class="health-question-item py-3 <%= 'border-top' unless index == 0 %>" style="<%= 'border-color: var(--card-border-color) !important;' unless index == 0 %>">
                        <label class="form-label fw-bold mb-2">
                          Q<%= index + 1 %> : <%= question[:text] %>
                        </label>
                        <div class="d-flex gap-4">
                          <div class="form-check">
                            <%= f.radio_button "health_question_#{index + 1}", "no", 
                                { class: "form-check-input", id: "#{question[:id]}_no", onchange: "checkHealthQuestions()" } %>
                            <label class="form-check-label" for="<%= question[:id] %>_no">
                              Non
                            </label>
                          </div>
                          <div class="form-check">
                            <%= f.radio_button "health_question_#{index + 1}", "yes", 
                                { class: "form-check-input", id: "#{question[:id]}_yes", onchange: "checkHealthQuestions()" } %>
                            <label class="form-check-label" for="<%= question[:id] %>_yes">
                              Oui
                            </label>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
              
              <!-- Message pour Standard avec réponse OUI -->
              <div id="health_standard_yes_info" class="alert alert-info mt-3" style="display: none;">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Consultez votre médecin avant de pratiquer</strong>
                <p class="mb-0 mt-2">Vous avez indiqué avoir des problèmes de santé. Nous vous recommandons fortement de consulter votre médecin avant de pratiquer le roller.</p>
              </div>
              
              <!-- Upload certificat médical (affiché si FFRS avec au moins une réponse = OUI) -->
              <div id="health_certificate_upload" class="mt-4" style="display: none;">
                <div class="alert alert-warning mb-3">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>Certificat médical requis</strong>
                  <p class="mb-0 mt-2">Pour la licence FFRS, un certificat médical est obligatoire si vous avez répondu "Oui" à au moins une question.</p>
                </div>
                
                <div class="card card-liquid" style="background: var(--liquid-glass-bg); border: 2px solid var(--card-border-color);">
                  <div class="card-body">
                    <label class="form-label fw-bold mb-3">
                      <i class="bi bi-file-earmark-medical me-2"></i>
                      Certificat médical *
                    </label>
                    
                    <div class="file-upload-area" id="certificate_upload_area">
                      <div class="file-upload-content">
                        <i class="bi bi-cloud-upload fs-1 text-muted mb-3"></i>
                        <p class="mb-2">
                          <strong>Glissez-déposez votre certificat</strong> ou cliquez pour sélectionner
                        </p>
                        <p class="text-muted small mb-0">
                          Formats acceptés : PDF, JPG, PNG (max 10 Mo)
                        </p>
                      </div>
                      <%= f.file_field :medical_certificate, 
                          class: "form-control d-none", 
                          id: "medical_certificate_input",
                          accept: ".pdf,.jpg,.jpeg,.png",
                          onchange: "handleFileSelect(this)" %>
                      <button type="button" class="btn btn-outline-primary mt-3" onclick="document.getElementById('medical_certificate_input').click()">
                        <i class="bi bi-folder2-open me-2"></i>Sélectionner un fichier
                      </button>
                    </div>
                    
                    <div id="certificate_preview" class="mt-3" style="display: none;">
                      <div class="d-flex align-items-center justify-content-between p-3 rounded" style="background: var(--liquid-glass-bg); border: 1px solid var(--card-border-color);">
                        <div class="d-flex align-items-center">
                          <i class="bi bi-file-earmark-pdf fs-3 text-danger me-3"></i>
                          <div>
                            <strong id="certificate_filename"></strong>
                            <small class="text-muted d-block" id="certificate_filesize"></small>
                          </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCertificate()">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                    
                    <div class="form-text small mt-2">
                      <i class="bi bi-info-circle me-1"></i>
                      Le certificat médical doit être valide et daté de moins de 6 mois
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Message pour Standard avec toutes réponses NON -->
              <div id="health_standard_no_info" class="alert alert-success mt-3" style="display: none;">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Parfait !</strong> Aucun problème de santé détecté. Vous pouvez continuer.
              </div>
              
              <!-- Message pour FFRS avec toutes réponses NON (attestation auto) -->
              <div id="health_ffrs_no_info" class="alert alert-success mt-3" style="display: none;">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Parfait !</strong> Aucun problème de santé détecté. Une attestation de santé sera générée automatiquement.
              </div>
            </div>

            <!-- ÉTAPE <%= @with_tshirt ? 6 : 5 %> : CONSENTEMENTS -->
            <div class="form-section" id="step-consents">
              <h3 class="section-title">
                <span class="section-number"><%= @with_tshirt ? 6 : 5 %></span>
                Consentements & Confidentialité
              </h3>
              <p class="section-intro">Pour finaliser votre adhésion, veuillez accepter :</p>
              
              <div class="consent-group">
                <div class="consent-group-title">
                  <i class="bi bi-file-text consent-icon text-liquid-primary"></i>
                  Conditions d'adhésion
                </div>
                <div class="consent-item">
                  <div class="form-check">
                    <%= f.check_box :legal_notices_accepted, 
                        { class: "form-check-input", id: "legal_notices_accepted", required: true }, 
                        "1", "0" %>
                    <label class="form-check-label" for="legal_notices_accepted">
                      Je m'engage à respecter le règlement intérieur et les CGU de Grenoble Roller
                      <%= link_to cgu_path, target: "_blank", class: "ms-2" do %>
                        Lire les CGU <i class="bi bi-box-arrow-up-right"></i>
                      <% end %>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="consent-group">
                <div class="consent-group-title">
                  <i class="bi bi-shield-lock consent-icon text-liquid-primary"></i>
                  Données personnelles (RGPD)
                </div>
                <div class="consent-item">
                  <div class="form-check">
                    <%= f.check_box :rgpd_consent, 
                        { class: "form-check-input", id: "rgpd_consent", required: true }, 
                        "1", "0" %>
                        <label class="form-check-label" for="rgpd_consent">
                          J'autorise Grenoble Roller à collecter mes données pour l'adhésion (conservation 3 ans)
                          <%= link_to politique_confidentialite_path, target: "_blank", class: "ms-2" do %>
                            Politique confidentialité <i class="bi bi-box-arrow-up-right"></i>
                          <% end %>
                        </label>
                  </div>
                </div>
              </div>
              
              <div class="consent-group">
                <div class="consent-group-title">
                  <i class="bi bi-bell consent-icon text-liquid-primary"></i>
                  Communication
                </div>
                <div class="consent-item">
                  <div class="form-check">
                    <%= check_box_tag "user[wants_initiation_mail]", "1", @user.wants_initiation_mail, 
                        { class: "form-check-input", id: "wants_initiation_mail" } %>
                    <label class="form-check-label" for="wants_initiation_mail">
                      Je souhaite recevoir les informations sur les initiations
                    </label>
                  </div>
                </div>
                <div class="consent-item">
                  <div class="form-check">
                    <%= check_box_tag "user[wants_events_mail]", "1", @user.wants_events_mail, 
                        { class: "form-check-input", id: "wants_events_mail" } %>
                    <label class="form-check-label" for="wants_events_mail">
                      Je souhaite recevoir les informations sur les événements/randonnées
                    </label>
                  </div>
                </div>
                <div class="form-text small mt-2">
                  <i class="bi bi-info-circle me-1"></i>
                  Vous pourrez modifier ces préférences à tout moment dans votre profil
                </div>
              </div>
              
              <div class="consent-group" id="ffrs_consent_group" style="display: none;">
                <div class="consent-group-title">
                  <i class="bi bi-people consent-icon text-liquid-primary"></i>
                  Partage FFRS (Si licence)
                </div>
                <div class="consent-item">
                  <div class="form-check">
                    <%= f.check_box :ffrs_data_sharing_consent, 
                        { class: "form-check-input", id: "ffrs_data_sharing_consent" }, 
                        "1", "0" %>
                        <label class="form-check-label" for="ffrs_data_sharing_consent">
                          J'autorise le partage de mes données avec la FFRS pour la licence
                          <%= link_to "#", class: "ms-2" do %>
                            En savoir plus <i class="bi bi-box-arrow-up-right"></i>
                          <% end %>
                        </label>
                  </div>
                </div>
              </div>
              
              <div class="alert alert-success mt-3" id="all_consents_accepted" style="display: none;">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Tous les consentements acceptés</strong>
              </div>
            </div>

            <!-- NAVIGATION -->
            <div class="form-navigation">
              <%= link_to memberships_path, class: "btn btn-outline-secondary btn-nav btn-back" do %>
                <i class="bi bi-arrow-left me-1"></i>Retour
              <% end %>
              <div class="d-flex gap-2">
                <%= f.submit "Valider et payer", 
                    class: "btn btn-liquid-primary btn-lg btn-nav",
                    id: "submit_btn",
                    onclick: "const form = document.getElementById('adult_membership_form'); if (!validateForm()) { alert('Veuillez compléter tous les champs obligatoires, notamment le questionnaire de santé.'); const firstInvalid = form?.querySelector('.is-invalid'); if (firstInvalid) { firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' }); } return false; } document.getElementById('payment_method_field').value = 'helloasso'; return true;" %>
                <%= f.submit "Déjà adhérent / Espèces / Chèques", 
                    class: "btn btn-outline-primary btn-lg btn-nav",
                    id: "submit_without_payment_btn",
                    onclick: "const form = document.getElementById('adult_membership_form'); if (!validateForm()) { alert('Veuillez compléter tous les champs obligatoires, notamment le questionnaire de santé.'); const firstInvalid = form?.querySelector('.is-invalid'); if (firstInvalid) { firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' }); } return false; } if(confirm('Vous allez créer une adhésion avec le statut \\'En attente\\'. Un bénévole validera votre paiement en espèces/chèque prochainement. Continuer ?')) { document.getElementById('payment_method_field').value = 'cash_check'; return true; } else { return false; }" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Sélection catégorie
  function selectCategory(key) {
    document.getElementById('category_' + key).checked = true;
    updateCategorySelection();
  }
  
  function updateCategorySelection() {
    document.querySelectorAll('.category-card').forEach(card => {
      card.classList.remove('selected');
    });
    
    document.querySelectorAll('input[name="membership[category]"]:checked').forEach(radio => {
      const card = radio.closest('.category-card');
      if (card) {
        card.classList.add('selected');
        const label = card.querySelector('#category_label_' + radio.value);
        if (label) label.textContent = 'Sélectionné';
      }
    });
    
    // Afficher/masquer consentement FFRS
    const ffrsGroup = document.getElementById('ffrs_consent_group');
    const selectedCategory = document.querySelector('input[name="membership[category]"]:checked')?.value;
    if (ffrsGroup) {
      ffrsGroup.style.display = selectedCategory === 'with_ffrs' ? 'block' : 'none';
    }
    
    // Mettre à jour le total T-shirt si présent
    <% if @with_tshirt %>
    if (typeof updateTshirtTotal === 'function') {
      updateTshirtTotal();
    }
    <% end %>
  }
  
  // Mettre à jour le champ caché date_of_birth à partir des 3 sélecteurs
  function updateAdultDateOfBirth() {
    const day = document.getElementById('date_of_birth_day').value;
    const month = document.getElementById('date_of_birth_month').value;
    const year = document.getElementById('date_of_birth_year').value;
    const hiddenField = document.getElementById('date_of_birth');
    
    if (day && month && year) {
      // Format: YYYY-MM-DD pour le champ caché
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      hiddenField.value = dateStr;
      updateAdultAge();
    } else {
      hiddenField.value = '';
      updateAdultAge();
    }
  }
  
  // Calcul âge adulte avec validation stricte < 16 ans
  function updateAdultAge() {
    const day = document.getElementById('date_of_birth_day').value;
    const month = document.getElementById('date_of_birth_month').value;
    const year = document.getElementById('date_of_birth_year').value;
    const ageDisplay = document.getElementById('adult_age_display');
    const ageValue = document.getElementById('adult_age_value');
    const dateOfBirthField = document.getElementById('date_of_birth');
    const daySelect = document.getElementById('date_of_birth_day');
    const monthSelect = document.getElementById('date_of_birth_month');
    const yearSelect = document.getElementById('date_of_birth_year');
    
    if (!day || !month || !year) {
      if (ageDisplay) ageDisplay.style.display = 'none';
      if (dateOfBirthField) dateOfBirthField.value = '';
      // Réinitialiser les erreurs
      [daySelect, monthSelect, yearSelect].forEach(select => {
        if (select) {
          select.classList.remove('is-invalid', 'is-valid');
        }
      });
      // Masquer tous les messages d'erreur/avertissement
      const errorDiv = document.getElementById('date_of_birth_error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
      }
      const warningDiv = document.getElementById('date_of_birth_warning');
      if (warningDiv) {
        warningDiv.style.display = 'none';
        warningDiv.innerHTML = '';
      }
      // Réactiver le bouton si le formulaire est valide
      const submitBtn = document.getElementById('submit_btn');
      if (submitBtn) {
        validateForm();
      }
      return;
    }
    
    const birthDate = new Date(year, month - 1, day); // month est 0-indexed en JS
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    // Validation stricte : bloquer les moins de 16 ans
    if (age < 16) {
      // Masquer le message d'avertissement 16-17 ans s'il existe
      const warningDiv = document.getElementById('date_of_birth_warning');
      if (warningDiv) {
        warningDiv.style.display = 'none';
        warningDiv.innerHTML = '';
      }
      
      // Afficher erreur sur tous les champs de date
      [daySelect, monthSelect, yearSelect].forEach(select => {
        if (select) {
          select.classList.add('is-invalid');
          select.classList.remove('is-valid');
        }
      });
      
      // Afficher message d'erreur
      const errorMessage = "L'adhésion adulte n'est pas possible pour les personnes de moins de 16 ans. Veuillez contacter un membre du bureau de l'association.";
      let errorDiv = document.getElementById('date_of_birth_error');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'date_of_birth_error';
        errorDiv.className = 'invalid-feedback d-block mt-2';
        const dateContainer = daySelect?.closest('.col-md-12');
        if (dateContainer) {
          dateContainer.appendChild(errorDiv);
        }
      }
      errorDiv.textContent = errorMessage;
      errorDiv.style.display = 'block';
      
      // Vider le champ caché pour empêcher la soumission
      if (dateOfBirthField) dateOfBirthField.value = '';
      
      // Afficher l'âge en rouge
      if (ageValue) {
        ageValue.textContent = age;
        ageValue.style.color = 'var(--bs-danger)';
      }
      if (ageDisplay) {
        ageDisplay.style.display = 'block';
        ageDisplay.style.color = 'var(--bs-danger)';
      }
      
      // Désactiver le bouton de soumission
      const submitBtn = document.getElementById('submit_btn');
      if (submitBtn) submitBtn.disabled = true;
      
      return;
    }
    
    // Si >= 16 ans : valide (vert)
    if (age >= 16) {
      // Masquer le message d'erreur < 16 ans s'il existe
      const errorDiv = document.getElementById('date_of_birth_error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
      }
      
      // Afficher en vert (valide)
      [daySelect, monthSelect, yearSelect].forEach(select => {
        if (select) {
          select.classList.add('is-valid');
          select.classList.remove('is-invalid');
        }
      });
      
      if (ageValue) {
        ageValue.textContent = age;
        ageValue.style.color = 'var(--bs-success)';
      }
      if (ageDisplay) {
        ageDisplay.style.display = 'block';
        ageDisplay.style.color = 'inherit';
      }
      
      // Masquer les messages d'avertissement
      const warningDiv = document.getElementById('date_of_birth_warning');
      if (warningDiv) {
        warningDiv.style.display = 'none';
        warningDiv.innerHTML = '';
      }
      
      // Si >= 16 ans mais < 18 ans, afficher un message informatif
      if (age < 18) {
        let infoDiv = document.getElementById('date_of_birth_warning');
        if (!infoDiv) {
          infoDiv = document.createElement('div');
          infoDiv.id = 'date_of_birth_warning';
          infoDiv.className = 'alert alert-info mt-2';
          const dateContainer = daySelect?.closest('.col-md-12');
          if (dateContainer) {
            dateContainer.appendChild(infoDiv);
          }
        }
      infoDiv.innerHTML = '<i class="bi bi-info-circle me-2"></i><strong>Information :</strong> Vos parents peuvent être prévenus de votre adhésion.';
      infoDiv.style.display = 'block';
      
      // Format: YYYY-MM-DD pour le champ caché (valide, on peut soumettre)
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      if (dateOfBirthField) dateOfBirthField.value = dateStr;
      
      // Marquer les champs comme valides
      [daySelect, monthSelect, yearSelect].forEach(select => {
        if (select) {
          select.classList.add('is-valid');
          select.classList.remove('is-invalid');
        }
      });
      
      // Réactiver le bouton de soumission
      const submitBtn = document.getElementById('submit_btn');
      if (submitBtn) {
        validateForm();
      }
      
      return;
    }
    
    // Si >= 18 ans, tout est valide
    [daySelect, monthSelect, yearSelect].forEach(select => {
      if (select) {
        select.classList.add('is-valid');
        select.classList.remove('is-invalid');
      }
    });
    
    // Masquer TOUS les messages d'erreur/avertissement
    const errorDiv = document.getElementById('date_of_birth_error');
    if (errorDiv) {
      errorDiv.style.display = 'none';
      errorDiv.textContent = ''; // Vider le contenu
    }
    const warningDiv = document.getElementById('date_of_birth_warning');
    if (warningDiv) {
      warningDiv.style.display = 'none';
      warningDiv.innerHTML = ''; // Vider le contenu
    }
    
    // Format: YYYY-MM-DD pour le champ caché
    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    if (dateOfBirthField) dateOfBirthField.value = dateStr;
    
    if (ageValue) {
      ageValue.textContent = age;
      ageValue.style.color = 'var(--bs-success)';
    }
    if (ageDisplay) {
      ageDisplay.style.display = 'block';
      ageDisplay.style.color = 'inherit';
    }
    
    // Réactiver le bouton de soumission
    const submitBtn = document.getElementById('submit_btn');
    if (submitBtn) {
      // Réactiver le bouton et vérifier la validation complète
      validateForm();
    }
  }
  
  // Validation champ
  function validateField(field) {
    const value = field.value.trim();
    const feedback = field.nextElementSibling;
    
    // Réinitialiser
    field.classList.remove('is-invalid', 'is-valid');
    if (feedback && feedback.classList.contains('invalid-feedback')) {
      feedback.textContent = '';
    }
    
    // Validation selon le type
    if (field.hasAttribute('required') && !value) {
      field.classList.add('is-invalid');
      if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = 'Champ obligatoire';
      }
      return false;
    }
    
    // Validation email
    if (field.type === 'email' && value) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        field.classList.add('is-invalid');
        if (feedback && feedback.classList.contains('invalid-feedback')) {
          feedback.textContent = 'Email invalide';
        }
        return false;
      }
    }
    
    // Validation téléphone : uniquement 10 chiffres
    if (field.type === 'tel' && value) {
      // Enlever tous les caractères non numériques (espaces inclus)
      const phoneDigits = value.replace(/[^0-9]/g, '');
      if (phoneDigits.length !== 10) {
        field.classList.add('is-invalid');
        field.style.borderColor = '#dc3545';
        if (feedback && feedback.classList.contains('invalid-feedback')) {
          feedback.textContent = 'Le numéro de téléphone doit contenir exactement 10 chiffres (ex: 06 12 34 56 78)';
        }
        return false;
      }
      // Vérifier que le numéro commence par 0
      if (phoneDigits[0] !== '0') {
        field.classList.add('is-invalid');
        field.style.borderColor = '#dc3545';
        if (feedback && feedback.classList.contains('invalid-feedback')) {
          feedback.textContent = 'Le numéro de téléphone doit commencer par 0 (ex: 06 12 34 56 78)';
        }
        return false;
      }
    }
    
    // Validation code postal
    if (field.name && field.name.includes('postal_code') && value) {
      const postalRegex = /^[0-9]{5}$/;
      if (!postalRegex.test(value)) {
        field.classList.add('is-invalid');
        if (feedback && feedback.classList.contains('invalid-feedback')) {
          feedback.textContent = 'Code postal invalide (5 chiffres)';
        }
        return false;
      }
    }
    
    // Si valide
    if (value) {
      field.classList.add('is-valid');
    }
    
    return true;
  }
  
  // Validation complète du formulaire
  function validateForm() {
    const form = document.getElementById('adult_membership_form');
    if (!form) return false;
    
    let isValid = true;
    const requiredFields = form.querySelectorAll('[required]');
    
    requiredFields.forEach(field => {
      if (!validateField(field)) {
        isValid = false;
      }
    });
    
    // Vérifier que le questionnaire de santé est complété
    let allHealthAnswered = true;
    const unansweredQuestions = [];
    for (let i = 1; i <= 9; i++) {
      const yesRadio = document.getElementById(`health_q${i}_yes`);
      const noRadio = document.getElementById(`health_q${i}_no`);
      const questionItem = yesRadio?.closest('.health-question-item');
      
      if (!yesRadio?.checked && !noRadio?.checked) {
        allHealthAnswered = false;
        unansweredQuestions.push(i);
        // Marquer visuellement la question non répondue
        if (questionItem) {
          questionItem.classList.add('is-invalid');
          questionItem.style.borderColor = 'var(--bs-danger)';
          questionItem.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
        }
      } else {
        // Retirer le marquage d'erreur si la question est répondue
        if (questionItem) {
          questionItem.classList.remove('is-invalid');
          questionItem.style.borderColor = '';
          questionItem.style.backgroundColor = '';
        }
      }
    }
    
    if (!allHealthAnswered) {
      isValid = false;
      // Afficher un message d'erreur si ce n'est pas déjà fait
      const healthSection = document.querySelector('[id*="health"]')?.closest('.step-content');
      if (healthSection && !document.getElementById('health_questionnaire_error')) {
        const errorDiv = document.createElement('div');
        errorDiv.id = 'health_questionnaire_error';
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.innerHTML = '<strong>Questionnaire incomplet :</strong> Veuillez répondre à toutes les questions de santé avant de continuer.';
        healthSection.appendChild(errorDiv);
      }
    } else {
      // Retirer le message d'erreur si le questionnaire est complet
      const errorDiv = document.getElementById('health_questionnaire_error');
      if (errorDiv) {
        errorDiv.remove();
      }
    }
    
    // Activer/désactiver boutons submit
    const submitBtn = document.getElementById('submit_btn');
    const submitWithoutPaymentBtn = document.getElementById('submit_without_payment_btn');
    if (submitBtn) {
      submitBtn.disabled = !isValid;
    }
    if (submitWithoutPaymentBtn) {
      submitWithoutPaymentBtn.disabled = !isValid;
    }
    
    return isValid;
  }
  
  // Vérifier tous les consentements
  function checkAllConsents() {
    const required = ['legal_notices_accepted', 'rgpd_consent'];
    const allChecked = required.every(id => document.getElementById(id)?.checked);
    const allConsentsDiv = document.getElementById('all_consents_accepted');
    if (allConsentsDiv) {
      allConsentsDiv.style.display = allChecked ? 'block' : 'none';
    }
  }
  
  // Vérifier les réponses au questionnaire de santé
  function checkHealthQuestions() {
    let hasYesAnswer = false;
    let allAnswered = true;
    
    // Vérifier les 9 questions
    for (let i = 1; i <= 9; i++) {
      const yesRadio = document.getElementById(`health_q${i}_yes`);
      const noRadio = document.getElementById(`health_q${i}_no`);
      
      if (yesRadio && yesRadio.checked) {
        hasYesAnswer = true;
      }
      
      // Vérifier si toutes les questions sont répondues
      if (!yesRadio?.checked && !noRadio?.checked) {
        allAnswered = false;
      }
    }
    
    // Récupérer la catégorie sélectionnée
    const selectedCategory = document.querySelector('input[name="membership[category]"]:checked')?.value;
    const isFFRS = selectedCategory === 'with_ffrs';
    const isStandard = selectedCategory === 'standard';
    
    // Afficher/masquer les intros selon la catégorie
    const introStandard = document.getElementById('health_intro_standard');
    const introFFRS = document.getElementById('health_intro_ffrs');
    if (introStandard) introStandard.style.display = isStandard ? 'block' : 'none';
    if (introFFRS) introFFRS.style.display = isFFRS ? 'block' : 'none';
    
    const uploadDiv = document.getElementById('health_certificate_upload');
    const standardYesInfo = document.getElementById('health_standard_yes_info');
    const standardNoInfo = document.getElementById('health_standard_no_info');
    const ffrsNoInfo = document.getElementById('health_ffrs_no_info');
    const certificateInput = document.getElementById('medical_certificate_input');
    
    if (isStandard) {
      // ADHÉSION STANDARD : Pas d'upload obligatoire
      if (uploadDiv) uploadDiv.style.display = 'none';
      if (ffrsNoInfo) ffrsNoInfo.style.display = 'none';
      
      if (hasYesAnswer) {
        // Afficher message de recommandation
        if (standardYesInfo) standardYesInfo.style.display = 'block';
        if (standardNoInfo) standardNoInfo.style.display = 'none';
        if (certificateInput) {
          certificateInput.removeAttribute('required');
          certificateInput.value = '';
          removeCertificate();
        }
      } else if (allAnswered) {
        // Toutes réponses NON
        if (standardYesInfo) standardYesInfo.style.display = 'none';
        if (standardNoInfo) standardNoInfo.style.display = 'block';
        if (certificateInput) {
          certificateInput.removeAttribute('required');
          certificateInput.value = '';
          removeCertificate();
        }
      } else {
        // Pas encore toutes répondues
        if (standardYesInfo) standardYesInfo.style.display = 'none';
        if (standardNoInfo) standardNoInfo.style.display = 'none';
      }
    } else if (isFFRS) {
      // LICENCE FFRS : Upload obligatoire si OUI, attestation auto si NON
      if (standardYesInfo) standardYesInfo.style.display = 'none';
      if (standardNoInfo) standardNoInfo.style.display = 'none';
      
      if (hasYesAnswer) {
        // Afficher l'upload et rendre le champ requis
        if (uploadDiv) uploadDiv.style.display = 'block';
        if (ffrsNoInfo) ffrsNoInfo.style.display = 'none';
        if (certificateInput) certificateInput.setAttribute('required', 'required');
      } else if (allAnswered) {
        // Toutes réponses NON : attestation auto
        if (uploadDiv) uploadDiv.style.display = 'none';
        if (ffrsNoInfo) ffrsNoInfo.style.display = 'block';
        if (certificateInput) {
          certificateInput.removeAttribute('required');
          certificateInput.value = '';
          removeCertificate();
        }
      } else {
        // Pas encore toutes répondues
        if (uploadDiv) uploadDiv.style.display = 'none';
        if (ffrsNoInfo) ffrsNoInfo.style.display = 'none';
      }
    }
    
    validateForm();
  }
  
  
  // Gérer la sélection de fichier
  function handleFileSelect(input) {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      const maxSize = 10 * 1024 * 1024; // 10 Mo
      
      if (file.size > maxSize) {
        alert('Le fichier est trop volumineux. Taille maximale : 10 Mo');
        input.value = '';
        return;
      }
      
      // Afficher la preview
      const preview = document.getElementById('certificate_preview');
      const filename = document.getElementById('certificate_filename');
      const filesize = document.getElementById('certificate_filesize');
      const uploadArea = document.getElementById('certificate_upload_area');
      const fileIcon = preview?.querySelector('i');
      
      if (preview && filename && filesize) {
        filename.textContent = file.name;
        filesize.textContent = formatFileSize(file.size);
        
        // Changer l'icône selon le type de fichier
        if (fileIcon) {
          if (file.type === 'application/pdf') {
            fileIcon.className = 'bi bi-file-earmark-pdf fs-3 text-danger me-3';
          } else if (file.type.startsWith('image/')) {
            fileIcon.className = 'bi bi-file-earmark-image fs-3 text-primary me-3';
          } else {
            fileIcon.className = 'bi bi-file-earmark fs-3 text-secondary me-3';
          }
        }
        
        preview.style.display = 'block';
        if (uploadArea) uploadArea.style.display = 'none';
      }
    }
  }
  
  // Supprimer le certificat
  function removeCertificate() {
    const input = document.getElementById('medical_certificate_input');
    const preview = document.getElementById('certificate_preview');
    const uploadArea = document.getElementById('certificate_upload_area');
    
    if (input) input.value = '';
    if (preview) preview.style.display = 'none';
    if (uploadArea) uploadArea.style.display = 'block';
  }
  
  // Formater la taille du fichier
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Gestion T-shirt (si avec_tshirt)
  <% if @with_tshirt %>
    function updateTshirtTotal() {
      const totalDisplay = document.getElementById('tshirt_total_display');
      if (!totalDisplay) return;
      
      // Récupérer la catégorie sélectionnée
      const categoryRadio = document.querySelector('input[name="membership[category]"]:checked');
      let adhesionPrice = 10; // Par défaut : 10€ pour standard
      
      if (categoryRadio) {
        const category = categoryRadio.value;
        // Prix selon la catégorie : standard = 10€, with_ffrs = 56.55€
        adhesionPrice = category === 'with_ffrs' ? 56.55 : 10;
      }
      
      // Quantité fixée à 1
      const qty = 1;
      const tshirtPrice = 14; // 14€ par T-shirt
      const total = adhesionPrice + (qty * tshirtPrice);
      
      // Formater avec virgule comme séparateur décimal et espace comme séparateur de milliers (format français)
      const parts = total.toFixed(2).split('.');
      const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      const formatted = integerPart + ',' + parts[1] + ' €';
      totalDisplay.textContent = formatted;
    }
  <% end %>

  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    <% if @with_tshirt %>
      updateTshirtTotal(); // Initialiser le total T-shirt
    <% end %>
    updateCategorySelection();
    updateAdultAge(); // Vérifier au chargement si une date est déjà présente
    checkHealthQuestions(); // Vérifier les questions de santé
    checkAllConsents();
    validateForm();
    
    // Drag & drop pour l'upload
    const uploadArea = document.getElementById('certificate_upload_area');
    const certificateInput = document.getElementById('medical_certificate_input');
    
    if (uploadArea && certificateInput) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
      });
      
      uploadArea.addEventListener('drop', handleDrop, false);
    }
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        certificateInput.files = files;
        handleFileSelect(certificateInput);
      }
    }
    
    // Écouter changements consentements
    ['legal_notices_accepted', 'rgpd_consent'].forEach(id => {
      const checkbox = document.getElementById(id);
      if (checkbox) {
        checkbox.addEventListener('change', function() {
          checkAllConsents();
          validateForm();
        });
      }
    });
    
    // Écouter changements champs
    const form = document.getElementById('adult_membership_form');
    if (form) {
      form.addEventListener('input', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
          validateField(e.target);
          validateForm();
        }
      });
      
      form.addEventListener('change', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
          validateField(e.target);
          validateForm();
        }
      });
    }
    
    // Validation avant soumission
    form?.addEventListener('submit', function(e) {
      // Vérifier l'âge avant soumission
      const day = document.getElementById('date_of_birth_day')?.value;
      const month = document.getElementById('date_of_birth_month')?.value;
      const year = document.getElementById('date_of_birth_year')?.value;
      
      if (day && month && year) {
        const birthDate = new Date(year, month - 1, day);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        
        // Bloquer strictement les < 16 ans
        if (age < 16) {
          e.preventDefault();
          updateAdultAge(); // Afficher les messages d'erreur
          const firstInvalid = form.querySelector('.is-invalid');
          if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalid.focus();
          }
          alert("L'adhésion adulte n'est pas possible pour les personnes de moins de 16 ans. Veuillez contacter un membre du bureau de l'association.");
          return false;
        }
        
        // À partir de 16 ans, l'adhésion est possible (les parents peuvent être prévenus pour les 16-17 ans)
      }
      
      if (!validateForm()) {
        e.preventDefault();
        const firstInvalid = form.querySelector('.is-invalid');
        if (firstInvalid) {
          firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstInvalid.focus();
        }
        return false;
      }
    });
  });
</script>
