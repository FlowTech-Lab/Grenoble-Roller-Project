<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card card-liquid rounded-liquid shadow-liquid">
        <div class="card-body p-4">
          <!-- Header -->
          <div class="text-center mb-4 pb-3 border-bottom">
            <h1 class="h4 mb-2">
              <i class="bi bi-person-heart text-liquid-success me-2"></i>ADHÉSION ADO (16-17 ans)
            </h1>
            <p class="text-muted small mb-0">
              Saison <%= @season %> - Valable du <%= l(@start_date, format: :long) %> au <%= l(@end_date, format: :long) %>
            </p>
            <div class="alert alert-info mt-3 mb-0">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Information importante :</strong> Vos parents seront informés de votre adhésion par email.
            </div>
          </div>

          <%= form_with model: Membership.new, url: memberships_path, method: :post, local: true, data: { turbo: false }, id: "teen_membership_form" do |f| %>
            <%= f.hidden_field :type, value: "teen" %>
            <%= hidden_field_tag :payment_method, "helloasso", id: "payment_method_field" %>
            <!-- Étape 1 : Choix de la catégorie -->
            <div class="mb-4">
              <h3 class="h5 mb-3">1. Choisissez votre adhésion</h3>
              <div class="row g-3">
                <% @categories.each do |key, cat| %>
                  <div class="col-md-6">
                    <div class="card card-liquid h-100" style="background: var(--liquid-glass-bg); border: 2px solid var(--card-border-color);">
                      <div class="card-body">
                        <div class="form-check">
                          <%= f.radio_button :category, key, 
                              { class: "form-check-input", id: "category_#{key}", required: true } %>
                          <label class="form-check-label w-100" for="category_<%= key %>">
                            <strong><%= cat[:name] %></strong>
                            <p class="text-muted small mb-2"><%= cat[:description] %></p>
                            <p class="mb-0">
                              <strong class="text-liquid-primary">
                                <%= number_to_currency(cat[:price_cents] / 100.0, unit: "€", separator: ",", delimiter: " ", format: "%n %u") %>
                              </strong>
                            </p>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Étape 2 : Informations personnelles -->
            <div class="mb-4">
              <h3 class="h5 mb-3">2. Vos informations</h3>
              <div class="row g-3">
                <div class="col-md-6">
                  <%= f.label :first_name, "Prénom *", class: "form-label" %>
                  <%= f.text_field :first_name, 
                      class: "form-control", 
                      value: @user.first_name.presence,
                      required: true %>
                </div>
                <div class="col-md-6">
                  <%= f.label :last_name, "Nom *", class: "form-label" %>
                  <%= f.text_field :last_name, 
                      class: "form-control", 
                      value: @user.last_name.presence,
                      required: true %>
                </div>
                <div class="col-md-6">
                  <%= f.label :date_of_birth, "Date de naissance *", class: "form-label" do %>
                    <i class="bi bi-calendar3 me-1"></i>Date de naissance
                  <% end %>
                  <div class="row g-2">
                    <div class="col-4">
                      <%= f.select :date_of_birth_day, 
                          options_for_select((1..31).map { |d| [d, d] }, @user.date_of_birth&.day), 
                          { prompt: "Jour", include_blank: true },
                          { 
                            class: "form-select", 
                            id: "date_of_birth_day",
                            required: true,
                            onchange: "updateTeenDateOfBirth()"
                          } %>
                    </div>
                    <div class="col-4">
                      <%= f.select :date_of_birth_month, 
                          options_for_select([
                            ["Janvier", 1], ["Février", 2], ["Mars", 3], ["Avril", 4],
                            ["Mai", 5], ["Juin", 6], ["Juillet", 7], ["Août", 8],
                            ["Septembre", 9], ["Octobre", 10], ["Novembre", 11], ["Décembre", 12]
                          ], @user.date_of_birth&.month), 
                          { prompt: "Mois", include_blank: true },
                          { 
                            class: "form-select", 
                            id: "date_of_birth_month",
                            required: true,
                            onchange: "updateTeenDateOfBirth()"
                          } %>
                    </div>
                    <div class="col-4">
                      <%= f.select :date_of_birth_year, 
                          options_for_select(Date.today.year.downto(Date.today.year - 120).map { |y| [y, y] }, @user.date_of_birth&.year), 
                          { prompt: "Année", include_blank: true },
                          { 
                            class: "form-select", 
                            id: "date_of_birth_year",
                            required: true,
                            onchange: "updateTeenDateOfBirth()"
                          } %>
                    </div>
                  </div>
                  <%= f.hidden_field :date_of_birth, id: "date_of_birth" %>
                  <div class="form-text small mt-2">
                    <i class="bi bi-info-circle me-1"></i>Nécessaire pour vérifier l'âge
                  </div>
                  <div class="invalid-feedback d-block mt-2" id="date_of_birth_error" style="display: none;"></div>
                </div>
                <div class="col-md-6">
                  <%= f.label :phone, "Téléphone *", class: "form-label" %>
                  <div data-controller="phone-mask">
                    <%= f.telephone_field :phone, 
                        class: "form-control", 
                        value: @user.phone.presence,
                        required: true,
                        placeholder: "Téléphone",
                        maxlength: 14,
                        pattern: "[0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}",
                        data: { 
                          phone_mask_target: "input",
                          action: "input->phone-mask#format"
                        },
                        onblur: "validatePhoneField(this)" %>
                  </div>
                  <div class="form-text small mt-1">
                    Format : 10 chiffres (ex: 06 12 34 56 78)
                  </div>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-12">
                  <%= f.label :email, "Email *", class: "form-label" %>
                  <%= f.email_field :email, 
                      class: "form-control", 
                      value: @user.email,
                      required: true %>
                </div>
              </div>
            </div>

            <!-- Étape 4 : Coordonnées -->
            <div class="mb-4">
              <h3 class="h5 mb-3">3. Vos coordonnées</h3>
              <div class="row g-3">
                <div class="col-12">
                  <%= f.label :address, "Adresse *", class: "form-label" %>
                  <%= f.text_field :address, 
                      class: "form-control", 
                      value: @user.address.presence,
                      required: true %>
                </div>
                <div class="col-md-6">
                  <%= f.label :city, "Ville *", class: "form-label" %>
                  <%= f.text_field :city, 
                      class: "form-control", 
                      value: @user.city.presence,
                      required: true %>
                </div>
                <div class="col-md-6">
                  <%= f.label :postal_code, "Code postal *", class: "form-label" %>
                  <%= f.text_field :postal_code, 
                      class: "form-control", 
                      value: @user.postal_code.presence,
                      required: true %>
                </div>
              </div>
            </div>

            <!-- Étape 5 : Informations parentales (obligatoire pour 16-17 ans) -->
            <div class="mb-4">
              <h3 class="h5 mb-3">4. Informations parentales</h3>
              <p class="text-muted small mb-3">
                Vos parents seront informés de votre adhésion par email. Ces informations sont obligatoires.
              </p>
              <div class="row g-3">
                <div class="col-md-6">
                  <%= f.label :parent_name, "Nom du parent/tuteur *", class: "form-label" %>
                  <%= f.text_field :parent_name, 
                      class: "form-control", 
                      value: (@user.first_name.presence && @user.last_name.presence) ? "#{@user.first_name} #{@user.last_name}" : nil,
                      required: true %>
                </div>
                <div class="col-md-6">
                  <%= f.label :parent_email, "Email du parent/tuteur *", class: "form-label" %>
                  <%= f.email_field :parent_email, 
                      class: "form-control", 
                      required: true,
                      placeholder: "parent@example.com" %>
                </div>
                <div class="col-md-6">
                  <%= f.label :parent_phone, "Téléphone du parent/tuteur", class: "form-label" %>
                  <div data-controller="phone-mask">
                    <%= f.telephone_field :parent_phone, 
                        class: "form-control", 
                        value: @user.phone.presence,
                        placeholder: "Téléphone",
                        maxlength: 14,
                        pattern: "[0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}",
                        data: { 
                          phone_mask_target: "input",
                          action: "input->phone-mask#format"
                        },
                        onblur: "validatePhoneField(this)" %>
                  </div>
                  <div class="form-text small mt-1">
                    Format : 10 chiffres uniquement (ex: 0612345678)
                  </div>
                  <div class="invalid-feedback"></div>
                </div>
              </div>
            </div>

            <!-- Étape 6 : Options -->
            <div class="mb-4">
              <h3 class="h5 mb-3">5. Options</h3>
              <div class="form-check mb-3">
                <%= f.check_box :wants_whatsapp, 
                    { class: "form-check-input", id: "wants_whatsapp" }, 
                    "1", "0" %>
                <label class="form-check-label" for="wants_whatsapp">
                  Je souhaite rejoindre la communauté WhatsApp
                </label>
              </div>
              <div class="form-check">
                <%= f.check_box :wants_email_info, 
                    { class: "form-check-input", id: "wants_email_info", checked: true }, 
                    "1", "0" %>
                <label class="form-check-label" for="wants_email_info">
                  Réception de mail d'information (rando/initiation) ou d'évènement Grenoble Roller
                </label>
              </div>
            </div>

            <!-- Boutons -->
            <div class="d-flex justify-content-between mt-4">
              <%= link_to memberships_path, class: "btn btn-outline-secondary" do %>
                <i class="bi bi-arrow-left me-1"></i>Retour
              <% end %>
              <div class="d-flex gap-2">
                <%= f.submit "Valider et payer", 
                    class: "btn btn-liquid-success btn-lg",
                    onclick: "document.getElementById('payment_method_field').value = 'helloasso';" %>
                <%= f.submit "Déjà adhérent / Espèces / Chèques", 
                    class: "btn btn-outline-primary btn-lg",
                    onclick: "if(confirm('Vous allez créer une adhésion avec le statut \\'En attente\\'. Un bénévole validera votre paiement en espèces/chèque prochainement. Continuer ?')) { document.getElementById('payment_method_field').value = 'cash_check'; return true; } else { return false; }" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Mettre à jour le champ caché date_of_birth à partir des 3 sélecteurs
  function updateTeenDateOfBirth() {
    const day = document.getElementById('date_of_birth_day').value;
    const month = document.getElementById('date_of_birth_month').value;
    const year = document.getElementById('date_of_birth_year').value;
    const hiddenField = document.getElementById('date_of_birth');
    
    if (day && month && year) {
      // Vérifier que la date est valide (ex: pas de 31 février)
      const date = new Date(year, month - 1, day);
      if (date.getDate() != day || date.getMonth() != month - 1 || date.getFullYear() != year) {
        const errorDiv = document.getElementById('date_of_birth_error');
        if (errorDiv) {
          errorDiv.textContent = 'Date invalide';
          errorDiv.style.display = 'block';
        }
        hiddenField.value = '';
        return;
      }
      
      // Format: YYYY-MM-DD pour le champ caché
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      hiddenField.value = dateStr;
      
      // Masquer l'erreur si elle existe
      const errorDiv = document.getElementById('date_of_birth_error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    } else {
      hiddenField.value = '';
    }
  }

  function validatePhoneField(field) {
    // Enlever tous les caractères non numériques (espaces inclus)
    const value = field.value.replace(/[^0-9]/g, '');
    const feedback = field.parentElement.querySelector('.invalid-feedback');
    
    // Validation téléphone : uniquement 10 chiffres
    if (value.length !== 10) {
      field.classList.add('is-invalid');
      field.classList.remove('is-valid');
      field.style.borderColor = '#dc3545';
      if (feedback) {
        feedback.textContent = 'Le numéro de téléphone doit contenir exactement 10 chiffres (ex: 06 12 34 56 78)';
        feedback.style.display = 'block';
      }
      return false;
    }
    
    // Vérifier que le numéro commence par 0
    if (value[0] !== '0') {
      field.classList.add('is-invalid');
      field.classList.remove('is-valid');
      field.style.borderColor = '#dc3545';
      if (feedback) {
        feedback.textContent = 'Le numéro de téléphone doit commencer par 0 (ex: 06 12 34 56 78)';
        feedback.style.display = 'block';
      }
      return false;
    }
    
    // Si valide
    field.classList.remove('is-invalid');
    field.classList.add('is-valid');
    field.style.borderColor = '';
    if (feedback) {
      feedback.style.display = 'none';
    }
    return true;
  }
</script>

