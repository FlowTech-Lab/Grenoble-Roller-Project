  <%
  # Définir l'étape courante (pour le stepper)
  # Catégorie en premier (étape 1)
  current_step = 1 # Commence toujours par la catégorie
  total_steps = 5
%>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
          <!-- HERO SECTION -->
          <div class="hero-form">
            <div class="text-center">
              <h1 class="hero-title">
                <% if @old_membership %>
                  RÉADHÉSION DE <%= @old_membership.child_full_name.upcase %>
                <% else %>
                  INSCRIPTION DE VOTRE ENFANT
                <% end %>
              </h1>
              <p class="hero-subtitle">
                <% if @old_membership %>
                  Renouvellement de l'adhésion pour la saison <%= @season %>
                <% else %>
                  Rejoignez Grenoble Roller en toute simplicité
                <% end %>
              </p>

          <div class="hero-badges d-flex justify-content-center gap-2">
            <span class="badge">
              <i class="bi bi-calendar-event me-1"></i>
              Saison <%= @season %>
            </span>
            <span class="badge">
              <i class="bi bi-calendar-range me-1"></i>
              <%= l(@start_date, format: :short) %> → <%= l(@end_date, format: :short) %>
            </span>
          </div>
        </div>
      </div>

      <!-- MAIN FORM -->
      <div class="card card-liquid rounded-liquid shadow-liquid">
        <div class="card-body p-4">
              <%= form_with model: @membership || Membership.new, url: memberships_path, method: :post, local: true, data: { turbo: false }, id: "child_membership_form", multipart: true do |f| %>
                <%= hidden_field_tag :payment_method, "helloasso", id: "payment_method_field" %>
                <%= hidden_field_tag :renew_from, @old_membership&.id if @old_membership %>
            <%= f.hidden_field :is_child_membership, value: true %>

            <!-- ÉTAPE 1 : CATÉGORIE -->
            <div class="form-section" id="step-category">
              <h3 class="section-title">
                <span class="section-number">1</span>
                Choisissez l'adhésion
              </h3>
              <p class="section-intro">Sélectionnez la formule qui correspond à votre enfant</p>

                  <div class="row g-3">
                    <% @categories.each do |key, cat| %>
                      <div class="col-md-6">
                        <label for="category_<%= key %>" class="category-card <%= 'selected' if (@membership&.category&.to_sym == key) || (key == :standard && @membership.nil?) %>" data-category-key="<%= key %>">
                      <div class="category-title"><%= cat[:name] %></div>
                      <div class="category-description">
                        <% if key == :with_ffrs %>
                          Je souhaite être membre bienfaiteur ou actif de l'association. Je souhaite également prendre la licence de la FFRS (Loisir). Plus d'informations sur <%= link_to('le site de la FFRS', 'https://ffroller-skateboard.fr/', target: '_blank', rel: 'noopener noreferrer', class: 'text-decoration-underline') %>.
                        <% else %>
                          <%= cat[:description] %>
                        <% end %>
                      </div>
                      <div class="category-footer d-flex justify-content-between align-items-center mt-auto">
                        <div class="category-select">
                          <%= f.radio_button :category, key,
                              { class: "form-check-input", id: "category_#{key}", required: true } %>
                          <span id="category_label_<%= key %>">Sélectionner</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <div class="category-price">
                            <%= number_to_currency(cat[:price_cents] / 100.0, unit: "€", separator: ",", delimiter: " ", format: "%n %u") %>
                          </div>
                          <% if key == :standard %>
                            <span class="category-badge">
                              <i class="bi bi-star-fill me-1"></i>Best-seller
                            </span>
                          <% end %>
                        </div>
                      </div>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- ÉTAPE 2 : INFORMATIONS ENFANT -->
            <div class="form-section" id="step-info">
              <h3 class="section-title">
                <span class="section-number">2</span>
                Informations de votre enfant
              </h3>
              <p class="section-intro">Ces informations permettront d'adapter le formulaire d'adhésion</p>

                  <% if @old_membership %>
                    <div class="alert alert-info mb-4">
                      <i class="bi bi-info-circle me-2"></i>
                      <strong>Renouvellement d'adhésion</strong> : Les informations de <%= @old_membership.child_full_name %> ont été pré-remplies.
                      Vous pouvez les modifier si nécessaire.
                    </div>
                  <% end %>

                  <div class="row g-3">
                    <div class="col-md-6">
                      <%= f.label :child_first_name, "Prénom de l'enfant *", class: "form-label fw-bold" %>
                          <%= f.text_field :child_first_name,
                              class: "form-control form-control-lg",
                              required: true,
                              placeholder: "Prénom",
                              value: @membership&.child_first_name %>
                      <div class="invalid-feedback"></div>
                    </div>
                    <div class="col-md-6">
                      <%= f.label :child_last_name, "Nom de l'enfant *", class: "form-label fw-bold" %>
                          <%= f.text_field :child_last_name,
                              class: "form-control form-control-lg",
                              required: true,
                              placeholder: "Nom",
                              value: @membership&.child_last_name %>
                      <div class="invalid-feedback"></div>
                    </div>
                    <div class="col-md-12">
                      <%= f.label :child_date_of_birth, "Date de naissance *", class: "form-label fw-bold" do %>
                        <i class="bi bi-calendar3 me-1"></i>Date de naissance de l'enfant
                      <% end %>
                      <div class="row g-2">
                        <div class="col-4">
                          <%= f.select :child_date_of_birth_day,
                              options_for_select((1..31).map { |d| [d, d] }, @membership&.child_date_of_birth&.day),
                              { prompt: "Jour", include_blank: true },
                              {
                                class: "form-select form-select-lg",
                                id: "child_date_of_birth_day",
                                required: true,
                              } %>
                        </div>
                        <div class="col-4">
                          <%= f.select :child_date_of_birth_month,
                              options_for_select([
                                ["Janvier", 1], ["Février", 2], ["Mars", 3], ["Avril", 4],
                                ["Mai", 5], ["Juin", 6], ["Juillet", 7], ["Août", 8],
                                ["Septembre", 9], ["Octobre", 10], ["Novembre", 11], ["Décembre", 12]
                              ], @membership&.child_date_of_birth&.month),
                              { prompt: "Mois", include_blank: true },
                              {
                                class: "form-select form-select-lg",
                                id: "child_date_of_birth_month",
                                required: true,
                              } %>
                        </div>
                        <div class="col-4">
                          <%= f.select :child_date_of_birth_year,
                              options_for_select(Date.today.year.downto(Date.today.year - 18).map { |y| [y, y] }, @membership&.child_date_of_birth&.year),
                              { prompt: "Année", include_blank: true },
                              {
                                class: "form-select form-select-lg",
                                id: "child_date_of_birth_year",
                                required: true,
                              } %>
                        </div>
                      </div>
                      <%= f.hidden_field :child_date_of_birth, id: "child_date_of_birth" %>
                      <div class="age-display mt-2" id="child_age_display" style="display: none;">
                        <i class="bi bi-info-circle me-1"></i>Âge : <strong id="child_age_value"></strong> ans
                      </div>
                      <div class="invalid-feedback d-block mt-2" id="child_date_of_birth_error" style="display: none;"></div>
                      <div class="form-text small mt-2">
                        <i class="bi bi-info-circle me-1"></i>L'âge sera calculé automatiquement à partir de la date sélectionnée.
                      </div>
                      <div id="category_inference" class="mt-2" style="display: none;">
                        <div class="alert alert-info mb-0">
                          <i class="bi bi-check-circle me-2"></i>
                          <span id="category_inference_text"></span>
                        </div>
                      </div>
                    </div>
              </div>
            </div>

            <!-- ÉTAPE 3 : AUTORISATION PARENTALE -->
            <div class="form-section" id="parent_authorization_section" style="display: none;">
              <h3 class="section-title">
                <span class="section-number">3</span>
                Autorisation parentale
              </h3>
              <p class="section-intro">
                <i class="bi bi-shield-check me-2"></i>
                <strong>Obligatoire pour les enfants de moins de 16 ans</strong>
              </p>

              <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                <strong>En tant que parent/tuteur légal</strong>, veuillez accepter les conditions suivantes :
              </div>

              <div class="consent-group">
                <div class="consent-group-title">
                  <i class="bi bi-shield-check consent-icon text-liquid-primary"></i>
                  En tant que parent/tuteur légal, j'accepte les conditions suivantes :
                </div>

                <ul class="list-unstyled mb-3">
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Mon enfant adhère à Grenoble Roller
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Mon enfant pratique le roller (sport avec risques d'accident)
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Je paye la cotisation (<span id="parent_auth_price"></span>)
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    J'accepte les conditions d'adhésion et la politique de confidentialité
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    J'accepte les risques liés à la pratique du roller
                  </li>
                </ul>
              </div>

              <div class="card card-liquid mt-3" style="background: var(--liquid-glass-bg); border: 1px solid var(--card-border-color);">
                <div class="card-body">
                  <h6 class="fw-bold mb-3">Signature digitale</h6>
                  <p class="small mb-2">
                    Je soussigné(e) <strong><%= "#{@user.first_name} #{@user.last_name}" %></strong>
                  </p>
                  <p class="small mb-2">
                    Parent de l'enfant <strong id="parent_child_name"></strong>
                  </p>
                  <p class="small mb-3">
                    Signe ce formulaire le <strong><%= l(Date.today, format: :long) %></strong>
                  </p>

                  <div class="form-check">
                    <%= f.check_box :parent_authorization,
                        { class: "form-check-input", id: "parent_authorization" },
                        "1", "0" %>
                    <label class="form-check-label" for="parent_authorization">
                      <strong>J'ai lu et j'accepte</strong>
                    </label>
                  </div>

                  <div class="alert alert-light mt-3 mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    <small>Cet accord est stocké numériquement et fait office de signature légale</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- ÉTAPE 4 : QUESTIONNAIRE SANTÉ -->
            <div class="form-section" id="step-health">
              <h3 class="section-title">
                <span class="section-number">4</span>
                Questionnaire de santé
              </h3>
              <p class="section-intro" id="health_intro_standard" style="display: none;">
                Répondez honnêtement aux questions suivantes concernant la santé de votre enfant. Vos réponses nous aident à mieux l'accompagner.
              </p>
              <p class="section-intro" id="health_intro_ffrs" style="display: none;">
                <strong>Questionnaire obligatoire pour la licence FFRS.</strong> Répondez aux questions suivantes concernant la santé de votre enfant.
              </p>

                  <%= render 'health_questionnaire', f: f, form_id: '' %>
                </div>

                <!-- ÉTAPE 5 : CONSENTEMENTS -->
                <%= render 'consents_section', f: f, form_id: '', is_child: true, step_number: 5 %>

                <!-- NAVIGATION -->
            <div class="form-navigation">
              <%= link_to memberships_path, class: "btn btn-outline-secondary btn-nav btn-back" do %>
                <i class="bi bi-arrow-left me-1"></i>Retour
              <% end %>
              <div class="d-flex flex-column gap-3">
                <!-- Essai gratuit (uniquement si l'enfant ne l'a pas déjà utilisé) -->
                <% unless @child_has_used_trial %>
                  <div class="d-flex align-items-center gap-2 py-2 px-3 rounded" style="background-color: rgba(13, 110, 253, 0.08); border: 1px solid rgba(13, 110, 253, 0.2);">
                    <i class="bi bi-gift-fill text-primary" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                      <strong class="text-primary d-block" style="font-size: 0.95rem;">Votre enfant a droit à un essai gratuit</strong>
                      <small class="text-muted" style="font-size: 0.85rem;">Il pourra s'inscrire à une initiation sans adhésion payée</small>
                    </div>
                  </div>
                <% end %>
                <div class="d-flex flex-column flex-sm-row gap-2">
                  <%= f.submit "Ajouter l'enfant",
                      class: "btn btn-liquid-primary btn-lg btn-nav",
                      id: "submit_btn",
                      data: { payment_method: "trial" } %>
                  <%= f.submit "Déjà adhérent / Espèces / Chèques",
                      class: "btn btn-outline-primary btn-lg btn-nav",
                      id: "submit_without_payment_btn",
                      data: { payment_method: "cash_check", confirm_message: "true" } %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Sélection catégorie
  function selectCategory(key) {
    document.getElementById('category_' + key).checked = true;
    updateCategorySelection();
  }

  function updateCategorySelection() {
    document.querySelectorAll('.category-card').forEach(card => {
      card.classList.remove('selected');
    });

    document.querySelectorAll('input[name="membership[category]"]:checked').forEach(radio => {
      const card = radio.closest('.category-card');
      if (card) {
        card.classList.add('selected');
        const label = card.querySelector('#category_label_' + radio.value);
        if (label) label.textContent = 'Sélectionné';
      }
    });

    // Afficher/masquer consentement FFRS
    const ffrsGroup = document.getElementById('ffrs_consent_group');
    const selectedCategory = document.querySelector('input[name="membership[category]"]:checked')?.value;
    if (ffrsGroup) {
      ffrsGroup.style.display = selectedCategory === 'with_ffrs' ? 'block' : 'none';
    }

    // Re-vérifier les questions de santé quand la catégorie change
    checkHealthQuestions();

  }

      // Mettre à jour le champ caché date_of_birth à partir des 3 sélecteurs
      function updateChildDateOfBirth() {
        const day = document.getElementById('child_date_of_birth_day').value;
        const month = document.getElementById('child_date_of_birth_month').value;
        const year = document.getElementById('child_date_of_birth_year').value;
        const hiddenField = document.getElementById('child_date_of_birth');

        if (day && month && year) {
          // Format: YYYY-MM-DD pour le champ caché
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          hiddenField.value = dateStr;
          updateChildAge();
        } else {
          hiddenField.value = '';
          updateChildAge();
        }
      }

      // Calcul âge enfant avec validation (sans couleurs, juste sécurité)
      function updateChildAge() {
        const day = document.getElementById('child_date_of_birth_day').value;
        const month = document.getElementById('child_date_of_birth_month').value;
        const year = document.getElementById('child_date_of_birth_year').value;
        const ageDisplay = document.getElementById('child_age_display');
        const ageValue = document.getElementById('child_age_value');
        const categoryInference = document.getElementById('category_inference');
        const categoryText = document.getElementById('category_inference_text');
        const authSection = document.getElementById('parent_authorization_section');
        const parentChildName = document.getElementById('parent_child_name');
        const firstName = document.getElementById('membership_child_first_name')?.value || '';
        const lastName = document.getElementById('membership_child_last_name')?.value || '';
        const hiddenField = document.getElementById('child_date_of_birth');

        if (!day || !month || !year) {
          if (ageDisplay) ageDisplay.style.display = 'none';
          if (categoryInference) categoryInference.style.display = 'none';
          if (authSection) authSection.style.display = 'none';
          const errorDiv = document.getElementById('child_date_of_birth_error');
          if (errorDiv) {
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
          }
          validateForm();
          return;
        }

        const birthDate = new Date(year, month - 1, day);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        // Attention fin d'année : si on n'a pas encore atteint le jour anniversaire cette année, retirer 1 an
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }

        // Afficher l'âge
        if (ageValue) {
          ageValue.textContent = age;
        }
        if (ageDisplay) {
          ageDisplay.style.display = 'block';
        }

        // Validation : bloquer si < 6 ans
        if (age < 6) {
          const errorMessage = "L'adhésion n'est pas possible pour les enfants de moins de 6 ans.";
          let errorDiv = document.getElementById('child_date_of_birth_error');
          if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'child_date_of_birth_error';
            errorDiv.className = 'alert alert-danger mt-2';
            const dateContainer = document.getElementById('child_date_of_birth_day')?.closest('.col-md-12');
            if (dateContainer) {
              dateContainer.appendChild(errorDiv);
            }
          }
          errorDiv.textContent = errorMessage;
          errorDiv.style.display = 'block';

          if (hiddenField) hiddenField.value = '';
          if (categoryInference) categoryInference.style.display = 'none';
          if (authSection) authSection.style.display = 'none';

          const submitBtn = document.getElementById('submit_btn');
          const submitWithoutPaymentBtn = document.getElementById('submit_without_payment_btn');
          if (submitBtn) submitBtn.disabled = true;
          if (submitWithoutPaymentBtn) submitWithoutPaymentBtn.disabled = true;

          return;
        }

        // Validation : bloquer si >= 16 ans (doivent créer leur compte)
        if (age >= 16) {
          const errorMessage = age >= 18 
            ? "L'adhésion enfant n'est pas possible pour les personnes de 18 ans et plus. Veuillez créer un compte adulte."
            : "À partir de 16 ans, les adolescents doivent créer leur propre compte. L'adhésion via le formulaire enfant n'est plus possible.";
          let errorDiv = document.getElementById('child_date_of_birth_error');
          if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'child_date_of_birth_error';
            errorDiv.className = 'alert alert-danger mt-2';
            const dateContainer = document.getElementById('child_date_of_birth_day')?.closest('.col-md-12');
            if (dateContainer) {
              dateContainer.appendChild(errorDiv);
            }
          }
          errorDiv.textContent = errorMessage;
          errorDiv.style.display = 'block';

          if (hiddenField) hiddenField.value = '';
          if (categoryInference) categoryInference.style.display = 'none';
          if (authSection) authSection.style.display = 'none';

          const submitBtn = document.getElementById('submit_btn');
          const submitWithoutPaymentBtn = document.getElementById('submit_without_payment_btn');
          if (submitBtn) submitBtn.disabled = true;
          if (submitWithoutPaymentBtn) submitWithoutPaymentBtn.disabled = true;

          return;
        }

        // Si entre 6 et 15 ans : valide
        const errorDiv = document.getElementById('child_date_of_birth_error');
        if (errorDiv) {
          errorDiv.style.display = 'none';
          errorDiv.textContent = '';
        }

        // Format: YYYY-MM-DD pour le champ caché
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        if (hiddenField) hiddenField.value = dateStr;

        // Inférence catégorie
        if (categoryInference && categoryText) {
          categoryText.textContent = 'Catégorie automatique : ENFANT (< 16 ans) — Accord parent requis';
          categoryInference.style.display = 'block';
        }

            // Afficher section autorisation si < 16 ans
            if (authSection) {
              authSection.style.display = 'block';
              document.getElementById('parent_authorization')?.setAttribute('required', 'required');
              if (parentChildName && firstName && lastName) {
                parentChildName.textContent = firstName + ' ' + lastName;
              }
            }

            // Réactiver la validation du formulaire
            validateForm();
            checkHealthQuestions();
      }

      // Vérifier les réponses au questionnaire de santé
      function checkHealthQuestions() {
        let hasYesAnswer = false;
        let allAnswered = true;

        // Vérifier les 9 questions
        for (let i = 1; i <= 9; i++) {
          const yesRadio = document.getElementById(`health_q${i}_yes`);
          const noRadio = document.getElementById(`health_q${i}_no`);

          if (yesRadio && yesRadio.checked) {
            hasYesAnswer = true;
          }

          // Vérifier si toutes les questions sont répondues
          if (!yesRadio?.checked && !noRadio?.checked) {
            allAnswered = false;
          }
        }

        // Récupérer la catégorie sélectionnée
        const selectedCategory = document.querySelector('input[name="membership[category]"]:checked')?.value;
        const isFFRS = selectedCategory === 'with_ffrs';
        const isStandard = selectedCategory === 'standard';

        // Afficher/masquer les intros selon la catégorie
        const introStandard = document.getElementById('health_intro_standard');
        const introFFRS = document.getElementById('health_intro_ffrs');
        if (introStandard) introStandard.style.display = isStandard ? 'block' : 'none';
        if (introFFRS) introFFRS.style.display = isFFRS ? 'block' : 'none';

        const uploadDiv = document.getElementById('health_certificate_upload');
        const standardYesInfo = document.getElementById('health_standard_yes_info');
        const standardNoInfo = document.getElementById('health_standard_no_info');
        const ffrsNoInfo = document.getElementById('health_ffrs_no_info');
        const certificateInput = document.getElementById('medical_certificate_input');

        if (isStandard) {
          // ADHÉSION STANDARD : Pas d'upload obligatoire
          if (uploadDiv) uploadDiv.style.display = 'none';
          if (ffrsNoInfo) ffrsNoInfo.style.display = 'none';

          if (hasYesAnswer) {
            // Afficher message de recommandation
            if (standardYesInfo) standardYesInfo.style.display = 'block';
            if (standardNoInfo) standardNoInfo.style.display = 'none';
            if (certificateInput) {
              certificateInput.removeAttribute('required');
              certificateInput.value = '';
              removeCertificate();
            }
          } else if (allAnswered) {
            // Toutes réponses NON
            if (standardYesInfo) standardYesInfo.style.display = 'none';
            if (standardNoInfo) standardNoInfo.style.display = 'block';
            if (certificateInput) {
              certificateInput.removeAttribute('required');
              certificateInput.value = '';
              removeCertificate();
            }
          } else {
            // Pas encore toutes répondues
            if (standardYesInfo) standardYesInfo.style.display = 'none';
            if (standardNoInfo) standardNoInfo.style.display = 'none';
          }
        } else if (isFFRS) {
          // LICENCE FFRS : Upload obligatoire si OUI, attestation auto si NON
          if (standardYesInfo) standardYesInfo.style.display = 'none';
          if (standardNoInfo) standardNoInfo.style.display = 'none';

          if (hasYesAnswer) {
            // Afficher l'upload et rendre le champ requis
            if (uploadDiv) uploadDiv.style.display = 'block';
            if (ffrsNoInfo) ffrsNoInfo.style.display = 'none';
            if (certificateInput) certificateInput.setAttribute('required', 'required');
          } else if (allAnswered) {
            // Toutes réponses NON : attestation auto
            if (uploadDiv) uploadDiv.style.display = 'none';
            if (ffrsNoInfo) ffrsNoInfo.style.display = 'block';
            if (certificateInput) {
              certificateInput.removeAttribute('required');
              certificateInput.value = '';
              removeCertificate();
            }
          } else {
            // Pas encore toutes répondues
            if (uploadDiv) uploadDiv.style.display = 'none';
            if (ffrsNoInfo) ffrsNoInfo.style.display = 'none';
          }
        }

        validateForm();
      }

      // Gérer la sélection de fichier
      function handleFileSelect(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const maxSize = 10 * 1024 * 1024; // 10 Mo

          if (file.size > maxSize) {
            alert('Le fichier est trop volumineux. Taille maximale : 10 Mo');
            input.value = '';
            return;
          }

          // Afficher la preview
          const preview = document.getElementById('certificate_preview');
          const filename = document.getElementById('certificate_filename');
          const filesize = document.getElementById('certificate_filesize');
          const uploadArea = document.getElementById('certificate_upload_area');
          const fileIcon = preview?.querySelector('i');

          if (preview && filename && filesize) {
            filename.textContent = file.name;
            filesize.textContent = formatFileSize(file.size);

            // Changer l'icône selon le type de fichier
            if (fileIcon) {
              if (file.type === 'application/pdf') {
                fileIcon.className = 'bi bi-file-earmark-pdf fs-3 text-danger me-3';
              } else if (file.type.startsWith('image/')) {
                fileIcon.className = 'bi bi-file-earmark-image fs-3 text-primary me-3';
              } else {
                fileIcon.className = 'bi bi-file-earmark fs-3 text-secondary me-3';
              }
            }

            preview.style.display = 'block';
            if (uploadArea) uploadArea.style.display = 'none';
          }
        }
      }

  // Supprimer le certificat
  function removeCertificate(formId) {
    formId = formId || '';
    const input = document.getElementById('medical_certificate_input' + formId);
    const preview = document.getElementById('certificate_preview' + formId);
    const uploadArea = document.getElementById('certificate_upload_area' + formId);

    if (input) input.value = '';
    if (preview) preview.style.display = 'none';
    if (uploadArea) uploadArea.style.display = 'block';
  }

      // Formater la taille du fichier
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
      }

  // Vérifier si un champ est valide (sans modifier les styles)
  function isFieldValid(field) {
    const value = field.value ? field.value.toString().trim() : '';
    
    // Champ required vide = invalide
    if (field.hasAttribute('required') && !value) {
      return false;
    }

    // Validation email
    if (field.type === 'email' && value) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        return false;
      }
    }

    // Validation téléphone : uniquement 10 chiffres
    if (field.type === 'tel' && value) {
      const phoneDigits = value.replace(/[^0-9]/g, '');
      if (phoneDigits.length !== 10 || phoneDigits[0] !== '0') {
        return false;
      }
    }

    return true;
  }

  // Validation complète du formulaire (vérifie uniquement si le formulaire est valide pour activer/désactiver les boutons)
  function validateForm() {
    const form = document.getElementById('child_membership_form');
    if (!form) return false;

    let isValid = true;
    
    // Vérifier que tous les champs requis sont remplis et valides
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
      if (!isFieldValid(field)) {
        isValid = false;
      }
    });

    // Vérifier que le questionnaire de santé est complété
    const allHealthAnswered = validateHealthQuestions('');
    if (!allHealthAnswered) {
      isValid = false;
    }

    // Vérifier qu'une catégorie est sélectionnée
    const categorySelected = document.querySelector('.category-card.selected');
    if (!categorySelected) {
      isValid = false;
    }

    // Vérifier que la date de naissance est valide (géré par updateChildAge qui bloque aussi)
    const hiddenDateField = document.getElementById('child_date_of_birth');
    if (!hiddenDateField || !hiddenDateField.value) {
      isValid = false;
    }

    // Activer/désactiver boutons submit
    const submitBtn = document.getElementById('submit_btn');
    const submitWithoutPaymentBtn = document.getElementById('submit_without_payment_btn');
    if (submitBtn) {
      submitBtn.disabled = !isValid;
    }
    if (submitWithoutPaymentBtn) {
      submitWithoutPaymentBtn.disabled = !isValid;
    }

    return isValid;
  }

  // Vérifier tous les consentements
  function checkAllConsents() {
    const required = ['legal_notices_accepted', 'rgpd_consent'];
    const allChecked = required.every(id => document.getElementById(id)?.checked);
    const allConsentsDiv = document.getElementById('all_consents_accepted');
    if (allConsentsDiv) {
      allConsentsDiv.style.display = allChecked ? 'block' : 'none';
    }
  }

      // Fonction d'initialisation réutilisable
      function initializeChildForm() {
        updateCategorySelection();
        updateChildDateOfBirth(); // Vérifier au chargement si une date est déjà présente
        checkHealthQuestions(); // Vérifier les questions de santé
        checkAllConsents();
        validateForm();

        // Gestion des clics sur les cartes de catégorie
        document.querySelectorAll('.category-card[data-category-key]').forEach(card => {
          card.addEventListener('click', function(e) {
            const key = this.getAttribute('data-category-key');
            if (key) {
              selectCategory(key);
            }
          });
        });

        // Gestion des changements de catégorie
        document.querySelectorAll('input[name="membership[category]"]').forEach(radio => {
          radio.addEventListener('change', function() {
            updateCategorySelection();
          });
        });

        // Gestion des changements de date de naissance
        ['child_date_of_birth_day', 'child_date_of_birth_month', 'child_date_of_birth_year'].forEach(id => {
          const field = document.getElementById(id);
          if (field) {
            field.addEventListener('change', updateChildDateOfBirth);
          }
        });


        // Gestion des changements dans les questions de santé
        document.querySelectorAll('input[name^="membership[health_question_"]').forEach(radio => {
          radio.addEventListener('change', checkHealthQuestions);
        });

        // Gestion de l'upload de certificat médical
        const certificateInput = document.getElementById('medical_certificate_input');
        if (certificateInput) {
          certificateInput.addEventListener('change', function() {
            handleFileSelect(this);
          });
        }

        // Bouton pour ouvrir le sélecteur de fichier
        document.querySelectorAll('[data-certificate-button]').forEach(button => {
          button.addEventListener('click', function() {
            const formId = this.getAttribute('data-certificate-button') || '';
            const inputId = 'medical_certificate_input' + formId;
            const input = document.getElementById(inputId);
            if (input) {
              input.click();
            }
          });
        });

        // Bouton pour supprimer le certificat
        document.querySelectorAll('[data-remove-certificate]').forEach(button => {
          button.addEventListener('click', function() {
            const formId = this.getAttribute('data-remove-certificate') || '';
            removeCertificate(formId);
          });
        });

        // Drag & drop pour l'upload
        const uploadArea = document.getElementById('certificate_upload_area');

        if (uploadArea && certificateInput) {
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
          });

          ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
          });

          ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
          });

          uploadArea.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          if (files.length > 0) {
            certificateInput.files = files;
            handleFileSelect(certificateInput);
          }
        }

    // Écouter changements consentements
    ['legal_notices_accepted', 'rgpd_consent'].forEach(id => {
      const checkbox = document.getElementById(id);
      if (checkbox) {
        checkbox.addEventListener('change', function() {
          checkAllConsents();
          validateForm();
        });
      }
    });

    // Écouter changements champs
    const form = document.getElementById('child_membership_form');
    if (form) {
      form.addEventListener('input', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
          validateForm();
        }
      });

      form.addEventListener('change', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
          validateForm();
        }
      });
    }

    // Gestion des boutons de soumission
    const submitBtn = document.getElementById('submit_btn');
    if (submitBtn) {
      submitBtn.addEventListener('click', function(e) {
        const form = document.getElementById('child_membership_form');
        if (!validateForm()) {
          e.preventDefault();
          alert('Veuillez compléter tous les champs obligatoires, notamment le questionnaire de santé.');
          const firstInvalid = form?.querySelector('.is-invalid');
          if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return false;
        }
        document.getElementById('payment_method_field').value = 'helloasso';
        return true;
      });
    }

    const submitWithoutPaymentBtn = document.getElementById('submit_without_payment_btn');
    if (submitWithoutPaymentBtn) {
      submitWithoutPaymentBtn.addEventListener('click', function(e) {
        e.preventDefault(); // Toujours prévenir la soumission par défaut
        const form = document.getElementById('child_membership_form');
        if (!validateForm()) {
          alert('Veuillez compléter tous les champs obligatoires, notamment le questionnaire de santé.');
          const firstInvalid = form?.querySelector('.is-invalid');
          if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return false;
        }
        if (confirm('Vous allez créer une adhésion avec le statut \'En attente\'. Un bénévole validera votre paiement en espèces/chèque prochainement. Continuer ?')) {
          document.getElementById('payment_method_field').value = 'cash_check';
          // Soumettre le formulaire manuellement après confirmation
          form.submit();
        }
        return false;
      });
    }

    // Mettre à jour prix autorisation parentale
    const updateAuthPrice = () => {
      const selectedCategory = document.querySelector('input[name="membership[category]"]:checked');
      if (selectedCategory) {
        const price = selectedCategory.closest('.category-card')?.querySelector('.category-price')?.textContent;
        const priceEl = document.getElementById('parent_auth_price');
        if (priceEl && price) {
          priceEl.textContent = price.trim();
        }
      }
    };

    document.querySelectorAll('input[name="membership[category]"]').forEach(radio => {
      radio.addEventListener('change', function() {
        updateAuthPrice();
        validateForm();
      });
    });
    updateAuthPrice();

    // Initialiser les valeurs si renouvellement depuis une adhésion expirée
    <% if @old_membership %>
      // Pré-remplir le nom de l'enfant dans l'autorisation parentale
      const parentChildName = document.getElementById('parent_child_name');
      if (parentChildName) {
        parentChildName.textContent = '<%= @old_membership.child_full_name %>';
      }

      // Initialiser la date de naissance si elle est pré-remplie
      <% if @membership&.child_date_of_birth %>
        setTimeout(() => {
          updateChildDateOfBirth();
          updateChildAge(); // Calculer l'âge et afficher/masquer la section d'autorisation
        }, 100);
      <% end %>

      // Sélectionner la catégorie si elle était pré-remplie
      <% if @membership&.category %>
        const categoryRadio = document.getElementById('category_<%= @membership.category %>');
        if (categoryRadio) {
          categoryRadio.checked = true;
          selectCategory('<%= @membership.category %>');
        }
      <% end %>
    <% end %>

    // Validation avant soumission
    form?.addEventListener('submit', function(e) {
      // Retirer le required des champs cachés pour éviter l'erreur "not focusable"
      const authSection = document.getElementById('parent_authorization_section');
      const authCheckbox = document.getElementById('parent_authorization');
      if (authSection && authSection.style.display === 'none' && authCheckbox) {
        authCheckbox.removeAttribute('required');
      }

      const certificateUpload = document.getElementById('health_certificate_upload');
      const certificateInput = document.getElementById('medical_certificate_input');
      if (certificateUpload && certificateUpload.style.display === 'none' && certificateInput) {
        certificateInput.removeAttribute('required');
      }

      if (!validateForm()) {
        e.preventDefault();
        const firstInvalid = form.querySelector('.is-invalid');
        if (firstInvalid) {
          firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstInvalid.focus();
        }
        return false;
      }
    });
  }

  // Initialisation : support à la fois du chargement normal et Turbo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeChildForm);
  } else {
    // Le DOM est déjà chargé, initialiser immédiatement
    initializeChildForm();
  }

  // Support Turbo : réinitialiser lors des navigations Turbo
  document.addEventListener('turbo:load', initializeChildForm);
  document.addEventListener('turbo:frame-load', function(e) {
    // Vérifier si le formulaire est dans le frame chargé
    if (e.target.querySelector('#child_membership_form')) {
      initializeChildForm();
    }
  });
</script>
