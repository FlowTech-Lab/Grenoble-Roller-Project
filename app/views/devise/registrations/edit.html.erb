<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="display-5 text-liquid-primary-white mb-2">
        <i class="bi bi-person-circle me-2"></i>Mon profil
      </h1>
      <p class="text-muted">Gérez vos informations personnelles</p>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }, data: { turbo: false }) do |f| %>
        <%= render "devise/shared/error_messages", resource: resource %>

        <!-- Informations personnelles -->
        <div class="card card-liquid rounded-liquid shadow-liquid mb-4">
          <div class="card-body p-4">
            <h3 class="h5 text-liquid-primary mb-4">
              <i class="bi bi-person-circle me-2"></i>Informations personnelles
            </h3>
            
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <%= f.label :first_name, "Prénom", class: "form-label fw-semibold required" %>
                <% has_error = resource.errors[:first_name].any? %>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person"></i></span>
                  <%= f.text_field :first_name, 
                      class: "form-control form-control-liquid #{'is-invalid' if has_error}", 
                      placeholder: "Jean", 
                      required: true,
                      autocomplete: "given-name",
                      aria: has_error ? {
                        required: true,
                        describedby: "error_first_name",
                        invalid: true
                      } : { required: true } %>
                </div>
                <% if has_error %>
                  <div class="invalid-feedback d-block" id="error_first_name">
                    <%= resource.errors[:first_name].first %>
                  </div>
                <% end %>
              </div>
              
              <div class="col-md-6">
                <%= f.label :last_name, "Nom (optionnel)", class: "form-label" %>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                  <%= f.text_field :last_name, 
                      class: "form-control form-control-liquid", 
                      placeholder: "Dupont",
                      autocomplete: "family-name" %>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <%= f.label :email, "Email", class: "form-label fw-semibold required" %>
                <% has_error = resource.errors[:email].any? %>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                  <%= f.email_field :email, 
                      class: "form-control form-control-liquid #{'is-invalid' if has_error}", 
                      placeholder: "votre@email.com", 
                      autocomplete: "email",
                      required: true,
                      aria: has_error ? {
                        required: true,
                        describedby: "error_email",
                        invalid: true
                      } : { required: true } %>
                </div>
                <% if has_error %>
                  <div class="invalid-feedback d-block" id="error_email">
                    <%= resource.errors[:email].first %>
                  </div>
                <% end %>
                <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
                  <div class="alert alert-liquid-warning rounded-liquid mt-2 mb-0 p-2" role="alert">
                    <i class="bi bi-clock-history me-1"></i>
                    <small>En attente de confirmation pour : <%= resource.unconfirmed_email %></small>
                  </div>
                <% end %>
              </div>
              
              <div class="col-md-6">
                <%= f.label :phone, "Téléphone", class: "form-label" %>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                  <%= f.text_field :phone, class: "form-control form-control-liquid", placeholder: "Téléphone", autocomplete: "tel", inputmode: "tel", data: { controller: "phone-mask", phone_mask_target: "input", action: "input->phone-mask#format" } %>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <%= f.label :date_of_birth, "Date de naissance", class: "form-label" do %>
                  <i class="bi bi-calendar3 me-1"></i>Date de naissance
                <% end %>
                <div class="row g-2">
                  <div class="col-4">
                    <%= select_tag "user[date_of_birth_day]", 
                        options_for_select((1..31).map { |d| [d, d] }, resource.date_of_birth&.day), 
                        { 
                          prompt: "Jour", 
                          include_blank: true,
                          class: "form-select", 
                          id: "date_of_birth_day_edit",
                          onchange: "updateEditDateOfBirth()"
                        } %>
                  </div>
                  <div class="col-4">
                    <%= select_tag "user[date_of_birth_month]", 
                        options_for_select([
                          ["Janvier", 1], ["Février", 2], ["Mars", 3], ["Avril", 4],
                          ["Mai", 5], ["Juin", 6], ["Juillet", 7], ["Août", 8],
                          ["Septembre", 9], ["Octobre", 10], ["Novembre", 11], ["Décembre", 12]
                        ], resource.date_of_birth&.month), 
                        { 
                          prompt: "Mois", 
                          include_blank: true,
                          class: "form-select", 
                          id: "date_of_birth_month_edit",
                          onchange: "updateEditDateOfBirth()"
                        } %>
                  </div>
                  <div class="col-4">
                    <%= select_tag "user[date_of_birth_year]", 
                        options_for_select(Date.today.year.downto(Date.today.year - 120).map { |y| [y, y] }, resource.date_of_birth&.year), 
                        { 
                          prompt: "Année", 
                          include_blank: true,
                          class: "form-select",
                          id: "date_of_birth_year_edit",
                          onchange: "updateEditDateOfBirth()"
                        } %>
                  </div>
                </div>
                <%= f.hidden_field :date_of_birth, id: "date_of_birth_edit" %>
                <div class="form-text small mt-2">
                  <i class="bi bi-info-circle me-1"></i>Nécessaire pour les adhésions
                </div>
                <div class="invalid-feedback d-block mt-2" id="date_of_birth_error_edit" style="display: none;"></div>
              </div>
            </div>

            <!-- Adresse -->
            <div class="row g-3 mb-3">
              <div class="col-12">
                <%= f.label :address, "Adresse", class: "form-label" do %>
                  <i class="bi bi-house me-1"></i>Adresse
                <% end %>
                <%= f.text_field :address, 
                    class: "form-control form-control-liquid", 
                    placeholder: "Adresse",
                    autocomplete: "street-address" %>
              </div>
              <div class="col-md-6">
                <%= f.label :postal_code, "Code postal", class: "form-label" do %>
                  <i class="bi bi-mailbox me-1"></i>Code postal
                <% end %>
                <%= f.text_field :postal_code, 
                    class: "form-control form-control-liquid", 
                    placeholder: "Code postal",
                    autocomplete: "postal-code",
                    maxlength: 5,
                    pattern: "[0-9]{5}" %>
              </div>
              <div class="col-md-6">
                <%= f.label :city, "Ville", class: "form-label" do %>
                  <i class="bi bi-building me-1"></i>Ville
                <% end %>
                <%= f.text_field :city, 
                    class: "form-control form-control-liquid", 
                    placeholder: "Ville",
                    autocomplete: "address-level2" %>
              </div>
            </div>

            <!-- Préférences de communication -->
            <div class="mb-4">
              <label class="form-label fw-semibold mb-3">
                <i class="bi bi-bell me-1"></i>Préférences de communication
              </label>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-check">
                    <%= f.check_box :wants_initiation_mail, class: "form-check-input" %>
                    <%= f.label :wants_initiation_mail, "Emails initiations et randos", class: "form-check-label fw-semibold" %>
                    <small class="form-text text-muted d-block mt-1">
                      Recevoir les informations sur les initiations du samedi et les randos
                    </small>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="form-check">
                    <%= f.check_box :wants_events_mail, class: "form-check-input" %>
                    <%= f.label :wants_events_mail, "Emails événements", class: "form-check-label fw-semibold" %>
                    <small class="form-text text-muted d-block mt-1">
                      Recevoir les informations sur les événements et actualités
                    </small>
                  </div>
                </div>
              </div>
              <div class="alert alert-info mt-3 mb-0">
                <i class="bi bi-info-circle me-2"></i>
                <small>Vous pouvez modifier ces préférences à tout moment</small>
              </div>
            </div>

            <!-- Skill Level -->
            <div class="mb-4">
              <%= f.label :skill_level, "Niveau de pratique", class: "form-label fw-semibold" %>
              <% has_error = resource.errors[:skill_level].any? %>
              <div class="row g-2">
                <!-- Débutant -->
                <div class="col-4">
                  <%= f.radio_button :skill_level, "beginner", 
                      class: "btn-check", 
                      id: "skill_beginner_edit",
                      autocomplete: "off" %>
                  <label class="btn btn-outline-primary w-100 py-3 skill-level-btn" for="skill_beginner_edit">
                    <i class="bi bi-person-plus d-block fs-3 mb-1"></i>
                    <small class="d-block fw-semibold">Débutant</small>
                  </label>
                </div>
                
                <!-- Intermédiaire -->
                <div class="col-4">
                  <%= f.radio_button :skill_level, "intermediate", 
                      class: "btn-check", 
                      id: "skill_intermediate_edit",
                      autocomplete: "off" %>
                  <label class="btn btn-outline-primary w-100 py-3 skill-level-btn" for="skill_intermediate_edit">
                    <i class="bi bi-person-check d-block fs-3 mb-1"></i>
                    <small class="d-block fw-semibold">Intermédiaire</small>
                  </label>
                </div>
                
                <!-- Avancé -->
                <div class="col-4">
                  <%= f.radio_button :skill_level, "advanced", 
                      class: "btn-check", 
                      id: "skill_advanced_edit",
                      autocomplete: "off" %>
                  <label class="btn btn-outline-primary w-100 py-3 skill-level-btn" for="skill_advanced_edit">
                    <i class="bi bi-trophy d-block fs-3 mb-1"></i>
                    <small class="d-block fw-semibold">Avancé</small>
                  </label>
                </div>
              </div>
              <% if has_error %>
                <div class="invalid-feedback d-block" id="error_skill_level">
                  <%= resource.errors[:skill_level].first %>
                </div>
              <% end %>
            </div>

            <div class="mb-0">
              <%= f.label :bio, "Biographie (optionnel)", class: "form-label" %>
              <%= f.text_area :bio, rows: 4, class: "form-control form-control-liquid", placeholder: "Parlez-nous de vous, de votre passion pour le roller..." %>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Présentez-vous brièvement à la communauté
              </small>
            </div>
          </div>
        </div>

        <!-- Modifier le mot de passe (INTÉGRÉ ICI) -->
        <div class="card card-liquid rounded-liquid shadow-liquid mb-4">
          <div class="card-body p-4">
            <h3 class="h5 text-liquid-primary mb-3">
              <i class="bi bi-shield-lock me-2"></i>Modifier le mot de passe
            </h3>
            <p class="text-muted small mb-3">
              Laissez ces champs vides si vous ne souhaitez pas modifier votre mot de passe.
            </p>
            
            <!-- Nouveau mot de passe -->
            <div class="mb-3" data-controller="password-toggle password-strength">
              <%= f.label :password, "Nouveau mot de passe (laisser vide si inchangé)", class: "form-label" %>
              <% has_error = resource.errors[:password].any? %>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                <%= f.password_field :password, 
                    autocomplete: "new-password", 
                    class: "form-control form-control-liquid #{'is-invalid' if has_error}",
                    minlength: "12",
                    placeholder: "12 caractères minimum",
                    data: { 
                      password_toggle_target: "input",
                      password_strength_target: "input"
                    },
                    aria: { describedby: "password_help_edit" } %>
                <button type="button" 
                        class="btn btn-outline-secondary password-toggle-btn" 
                        data-action="click->password-toggle#toggle"
                        data-password-toggle-target="toggle"
                        aria-label="Afficher le mot de passe"
                        aria-pressed="false"
                        title="Afficher le mot de passe"
                        style="min-height: 44px; min-width: 44px;">
                  <i class="bi bi-eye" data-password-toggle-target="icon"></i>
                  <span class="visually-hidden" data-password-toggle-target="label">Afficher</span>
                </button>
              </div>
              
              <!-- Indicateur de force du mot de passe -->
              <div class="password-strength-container d-none mt-2" id="password_strength_feedback_edit">
                <div class="password-strength-bar">
                  <div class="password-strength-meter" 
                       data-password-strength-target="meter"></div>
                </div>
                <div class="password-strength-feedback mt-1 small" 
                     data-password-strength-target="feedback"
                     role="status"
                     aria-live="polite">
                  <span data-password-strength-target="strengthText"></span>
                </div>
              </div>
              
              <div class="form-text" id="password_help_edit">
                <i class="bi bi-lightbulb text-warning me-1"></i>
                <strong>Astuce :</strong> Utilisez une phrase facile à retenir
                <br>
                <span class="text-muted small">Exemple : café-roller-grenoble</span>
              </div>
              
              <% if has_error %>
                <div class="invalid-feedback d-block" id="error_password">
                  <%= resource.errors[:password].first %>
                </div>
              <% end %>
            </div>
            
            <!-- Confirmer nouveau mot de passe -->
            <div class="mb-0" data-controller="password-toggle">
              <%= f.label :password_confirmation, "Confirmer le nouveau mot de passe", class: "form-label" %>
              <% has_error = resource.errors[:password_confirmation].any? %>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-check"></i></span>
                <%= f.password_field :password_confirmation, 
                    autocomplete: "new-password", 
                    class: "form-control form-control-liquid #{'is-invalid' if has_error}",
                    placeholder: "Resaisissez le nouveau mot de passe",
                    data: { password_toggle_target: "input" } %>
                <button type="button" 
                        class="btn btn-outline-secondary password-toggle-btn" 
                        data-action="click->password-toggle#toggle"
                        data-password-toggle-target="toggle"
                        aria-label="Afficher le mot de passe"
                        aria-pressed="false"
                        title="Afficher le mot de passe"
                        style="min-height: 44px; min-width: 44px;">
                  <i class="bi bi-eye" data-password-toggle-target="icon"></i>
                  <span class="visually-hidden" data-password-toggle-target="label">Afficher</span>
                </button>
              </div>
              <% if has_error %>
                <div class="invalid-feedback d-block" id="error_password_confirmation">
                  <%= resource.errors[:password_confirmation].first %>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Confirmation (current_password) -->
        <div class="card card-liquid rounded-liquid shadow-liquid mb-4">
          <div class="card-body p-4">
            <h3 class="h5 text-liquid-primary mb-3">
              <i class="bi bi-shield-check me-2"></i>Confirmation
            </h3>
            
            <div class="mb-3">
              <%= f.label :current_password, "Mot de passe actuel (requis pour toute modification)", class: "form-label fw-semibold required" %>
              <% has_error = resource.errors[:current_password].any? %>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-key"></i></span>
                <%= f.password_field :current_password, 
                    class: "form-control form-control-liquid #{'is-invalid' if has_error}", 
                    placeholder: "••••••••", 
                    autocomplete: "current-password", 
                    required: true,
                    aria: has_error ? {
                      required: true,
                      describedby: "current_password_help error_current_password",
                      invalid: true
                    } : {
                      required: true,
                      describedby: "current_password_help"
                    } %>
              </div>
              <small class="form-text text-muted" id="current_password_help">
                <i class="bi bi-info-circle me-1"></i>
                Pour votre sécurité, nous avons besoin de votre mot de passe actuel pour confirmer vos modifications.
              </small>
              <% if has_error %>
                <div class="invalid-feedback d-block" id="error_current_password">
                  <%= resource.errors[:current_password].first %>
                </div>
              <% end %>
            </div>
            
            <div class="d-flex gap-2">
              <%= link_to :back, class: "btn btn-outline-secondary" do %>
                <i class="bi bi-arrow-left me-1"></i>Retour
              <% end %>
              <%= f.submit "Mettre à jour mon profil", class: "btn btn-liquid-primary" %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Supprimer le compte -->
      <div class="card card-liquid rounded-liquid shadow-liquid">
        <div class="card-body p-4">
          <h3 class="h5 text-liquid-danger mb-3">
            <i class="bi bi-exclamation-triangle me-2"></i>Zone de danger
          </h3>
          <p class="text-muted mb-3">
            Vous n'êtes pas satisfait ? La suppression de votre compte est <strong>irréversible</strong> et entraînera la perte de toutes vos données.
          </p>
          <%= button_to "Supprimer définitivement mon compte", 
              registration_path(resource_name), 
              data: { 
                confirm: "Êtes-vous vraiment sûr(e) ? Cette action est irréversible !", 
                turbo_confirm: "Êtes-vous vraiment sûr(e) ? Cette action est irréversible !" 
              }, 
              method: :delete,
              class: "btn btn-liquid-danger" %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Mettre à jour le champ caché date_of_birth à partir des 3 sélecteurs (profil)
  function updateEditDateOfBirth() {
    const day = document.getElementById('date_of_birth_day_edit').value;
    const month = document.getElementById('date_of_birth_month_edit').value;
    const year = document.getElementById('date_of_birth_year_edit').value;
    const hiddenField = document.getElementById('date_of_birth_edit');
    
    if (day && month && year) {
      // Vérifier que la date est valide (ex: pas de 31 février)
      const date = new Date(year, month - 1, day);
      if (date.getDate() != day || date.getMonth() != month - 1 || date.getFullYear() != year) {
        const errorDiv = document.getElementById('date_of_birth_error_edit');
        if (errorDiv) {
          errorDiv.textContent = 'Date invalide';
          errorDiv.style.display = 'block';
        }
        hiddenField.value = '';
        return;
      }
      
      // Format: YYYY-MM-DD pour le champ caché
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      hiddenField.value = dateStr;
      
      // Masquer l'erreur si elle existe
      const errorDiv = document.getElementById('date_of_birth_error_edit');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    } else {
      hiddenField.value = '';
    }
  }
</script>
