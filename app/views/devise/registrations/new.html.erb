<div class="container-fluid py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card card-liquid rounded-liquid shadow-liquid auth-form">
        <div class="card-body p-4">
          
          <!-- Header Moderne -->
          <div class="text-center mb-4">
            <div class="auth-icon-wrapper mb-3">
              <i class="bi bi-person-plus-fill text-liquid-primary" style="font-size: 3rem;"></i>
            </div>
            <h2 class="fw-bold mb-2">Rejoignez-nous</h2>
            <p class="text-muted">Créez votre compte en 1 minute</p>
          </div>
          
          <%= form_for(resource, as: resource_name, url: registration_path(resource_name), data: { turbo: false }) do |f| %>
            <%= render "devise/shared/error_messages", resource: resource %>

            <!-- Email -->
            <div class="mb-3">
              <%= f.label :email, class: "form-label fw-semibold required", for: "user_email" do %>
                <i class="bi bi-envelope me-1"></i> Email
              <% end %>
              <% has_error = resource.errors[:email].any? %>
              <%= f.email_field :email, 
                  id: "user_email",
                  autocomplete: "email", 
                  class: "form-control form-control-liquid form-control-lg #{'is-invalid' if has_error}", 
                  placeholder: "Email", 
                  required: true,
                  style: "font-size: 16px; min-height: 44px;",
                  aria: has_error ? { 
                    required: true,
                    describedby: "error_email",
                    invalid: true
                  } : { required: true } %>
              <% if has_error %>
                <div class="invalid-feedback d-block" id="error_email">
                  <%= resource.errors[:email].first %>
                </div>
              <% end %>
            </div>
            
            <!-- Prénom (obligatoire pour personnaliser les événements) -->
            <div class="mb-3">
              <%= f.label :first_name, class: "form-label fw-semibold required", for: "user_first_name" do %>
                <i class="bi bi-person me-1"></i> Prénom
              <% end %>
              <% has_error = resource.errors[:first_name].any? %>
              <%= f.text_field :first_name, 
                  id: "user_first_name",
                  autocomplete: "given-name", 
                  class: "form-control form-control-liquid form-control-lg #{'is-invalid' if has_error}", 
                  placeholder: "Jean", 
                  required: true,
                  style: "font-size: 16px; min-height: 44px;",
                  aria: has_error ? { 
                    required: true,
                    describedby: "error_first_name",
                    invalid: true
                  } : { required: true } %>
              <div class="form-text small" id="first_name_help">
                Utilisé pour personnaliser vos interactions (événements, emails)
              </div>
              <% if has_error %>
                <div class="invalid-feedback d-block" id="error_first_name">
                  <%= resource.errors[:first_name].first %>
                </div>
              <% end %>
            </div>
            
            <!-- Password (12 caractères, UX optimisé) -->
            <div class="mb-3" data-controller="password-toggle password-strength">
              <%= f.label :password, class: "form-label fw-semibold required", for: "user_password" do %>
                <i class="bi bi-shield-lock me-1"></i> Mot de passe
              <% end %>
              <% has_error = resource.errors[:password].any? %>
              <% describedby_ids = ["password_help"] %>
              <% describedby_ids << "error_password" if has_error %>
              <% describedby_ids << "password_strength_feedback" %>
              
              <div class="input-group">
                <%= f.password_field :password, 
                    id: "user_password",
                    autocomplete: "new-password", 
                    class: "form-control form-control-liquid form-control-lg #{'is-invalid' if has_error}", 
                    placeholder: "Mot de passe",
                    minlength: "12",
                    required: true,
                    title: "Le mot de passe doit contenir au moins 12 caractères",
                    style: "font-size: 16px; min-height: 44px;",
                    data: { 
                      password_toggle_target: "input",
                      password_strength_target: "input"
                    },
                    aria: { 
                      required: true,
                      describedby: describedby_ids.join(" "),
                      invalid: has_error
                    } %>
                
                <button type="button" 
                        class="btn btn-outline-secondary password-toggle-btn" 
                        data-action="click->password-toggle#toggle"
                        data-password-toggle-target="toggle"
                        aria-label="Afficher le mot de passe"
                        aria-pressed="false"
                        title="Afficher le mot de passe"
                        style="min-height: 44px; min-width: 44px;">
                  <i class="bi bi-eye" data-password-toggle-target="icon"></i>
                  <span class="visually-hidden" data-password-toggle-target="label">Afficher</span>
                </button>
              </div>
              
              <!-- Indicateur de force du mot de passe -->
              <div class="password-strength-container d-none mt-2" id="password_strength_feedback">
                <div class="password-strength-bar">
                  <div class="password-strength-meter" 
                       data-password-strength-target="meter"></div>
                </div>
                <div class="password-strength-feedback mt-1 small" 
                     data-password-strength-target="feedback"
                     role="status"
                     aria-live="polite">
                  <span data-password-strength-target="strengthText"></span>
                </div>
              </div>
              
              <!-- Help Text Positif & Concis -->
              <div class="form-text mt-2" id="password_help">
                <i class="bi bi-lightbulb text-warning me-1"></i>
                <strong>Astuce :</strong> Utilisez une phrase facile à retenir
                <br>
                <span class="text-muted small">Exemple : café-roller-grenoble</span>
              </div>
              
              <% if has_error %>
                <div class="invalid-feedback d-block" id="error_password">
                  <%= resource.errors[:password].first %>
                </div>
              <% end %>
            </div>
            
            <!-- Skill Level (Cards Bootstrap) -->
            <div class="mb-4">
              <%= f.label :skill_level, class: "form-label fw-semibold required", for: "user_skill_level" do %>
                <i class="bi bi-speedometer me-1"></i> Votre niveau
              <% end %>
              <% has_error = resource.errors[:skill_level].any? %>
              
              <div class="row g-2">
                <!-- Débutant -->
                <div class="col-4">
                  <%= f.radio_button :skill_level, "beginner", 
                      class: "btn-check", 
                      id: "skill_beginner",
                      required: true,
                      autocomplete: "off" %>
                  <label class="btn btn-outline-primary w-100 py-3 skill-level-btn" for="skill_beginner">
                    <i class="bi bi-person d-block fs-3 mb-1"></i>
                    <small class="d-block fw-semibold">Débutant</small>
                  </label>
                </div>
                
                <!-- Intermédiaire -->
                <div class="col-4">
                  <%= f.radio_button :skill_level, "intermediate", 
                      class: "btn-check", 
                      id: "skill_intermediate",
                      autocomplete: "off" %>
                  <label class="btn btn-outline-primary w-100 py-3 skill-level-btn" for="skill_intermediate">
                    <i class="bi bi-person-check d-block fs-3 mb-1"></i>
                    <small class="d-block fw-semibold">Intermédiaire</small>
                  </label>
                </div>
                
                <!-- Avancé -->
                <div class="col-4">
                  <%= f.radio_button :skill_level, "advanced", 
                      class: "btn-check", 
                      id: "skill_advanced",
                      autocomplete: "off" %>
                  <label class="btn btn-outline-primary w-100 py-3 skill-level-btn" for="skill_advanced">
                    <i class="bi bi-trophy d-block fs-3 mb-1"></i>
                    <small class="d-block fw-semibold">Avancé</small>
                  </label>
                </div>
              </div>
              <% if has_error %>
                <div class="invalid-feedback d-block" id="error_skill_level">
                  <%= resource.errors[:skill_level].first %>
                </div>
              <% end %>
            </div>
            
            <!-- RGPD - Consentement (Compact) -->
            <div class="mb-3">
              <div class="form-check">
                <% terms_error = flash[:alert]&.include?('Conditions Générales') || flash[:alert]&.include?('consentement') %>
                <%= check_box_tag :accept_terms, "1", false, 
                    id: "accept_terms",
                    class: "form-check-input #{'is-invalid' if terms_error}",
                    required: true,
                    aria: { 
                      required: true,
                      describedby: "terms_help #{'terms_error' if terms_error}".strip,
                      invalid: terms_error
                    } %>
                <%= label_tag :accept_terms, class: "form-check-label small" do %>
                  J'accepte les&nbsp;
                  <%= link_to "CGU", cgu_path, target: "_blank", rel: "noopener noreferrer", class: "text-decoration-none" %>&nbsp;
                  et la&nbsp;
                  <%= link_to "Politique", politique_confidentialite_path, target: "_blank", rel: "noopener noreferrer", class: "text-decoration-none" %>
                  <span class="required-marker">*</span>
                <% end %>
              </div>
              <div class="form-text small" id="terms_help">
                Le consentement est obligatoire pour créer un compte
              </div>
              <% if terms_error %>
                <div class="invalid-feedback d-block" id="terms_error" role="alert">
                  <%= flash[:alert] %>
                </div>
              <% end %>
            </div>

            <%= f.hidden_field :role_id, value: Role.find_by(code: 'USER')&.id || Role.find_by(name: 'Utilisateur')&.id || Role.first&.id %>
            
            <!-- Turnstile Widget (Implicit Rendering - Protection Anti-Bot) -->
            <% unless Rails.env.test? %>
              <% turnstile_site_key = Rails.application.credentials.dig(:turnstile, :site_key) || ENV['TURNSTILE_SITE_KEY'] %>
              <% if turnstile_site_key.present? %>
                <div class="cf-turnstile mb-3 text-center" 
                     data-sitekey="<%= turnstile_site_key %>"
                     data-theme="light">
                </div>
              <% end %>
            <% end %>
            
            <!-- Submit Button (Moderne) -->
            <div class="d-grid gap-2 mb-3">
              <%= f.submit "Créer mon compte", 
                  class: "btn btn-liquid-primary btn-lg fw-semibold",
                  style: "font-size: 16px; min-height: 44px;",
                  id: "submit-registration" %>
            </div>
          <% end %>
          
          <!-- Login Link (Subtil) -->
          <div class="text-center">
            <small class="text-muted">
              Déjà membre ? 
              <%= link_to "Connectez-vous", new_session_path(resource_name), class: "text-decoration-none fw-semibold", style: "min-height: 24px; display: inline-block; padding: 4px 0;" %>
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% unless Rails.env.test? %>
  <% turnstile_site_key = Rails.application.credentials.dig(:turnstile, :site_key) || ENV['TURNSTILE_SITE_KEY'] %>
  <% if turnstile_site_key.present? %>
    <!-- Cloudflare Turnstile Script -->
    <!-- Implicit Rendering : Cloudflare scanne automatiquement les divs .cf-turnstile et les rend -->
    <!-- Le token est automatiquement ajouté au formulaire dans un champ hidden cf-turnstile-response -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    
    <script>
      // S'assurer que Turnstile a généré le token avant de permettre la soumission
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form[action*="registration"]');
        const submitButton = document.getElementById('submit-registration');
        
        if (form && submitButton) {
          // Désactiver le bouton initialement si Turnstile est présent
          const turnstileWidget = form.querySelector('.cf-turnstile');
          if (turnstileWidget) {
            submitButton.disabled = true;
            submitButton.setAttribute('aria-disabled', 'true');
            
            // Attendre que Turnstile soit chargé et le widget rendu
            const checkTurnstile = setInterval(function() {
              const tokenInput = form.querySelector('input[name="cf-turnstile-response"]');
              if (tokenInput && tokenInput.value) {
                // Token généré, activer le bouton
                submitButton.disabled = false;
                submitButton.removeAttribute('aria-disabled');
                clearInterval(checkTurnstile);
              }
            }, 100);
            
            // Timeout après 10 secondes (au cas où Turnstile ne charge pas)
            setTimeout(function() {
              clearInterval(checkTurnstile);
              submitButton.disabled = false;
              submitButton.removeAttribute('aria-disabled');
            }, 10000);
          }
          
          // Vérifier au moment de la soumission que le token est présent
          form.addEventListener('submit', function(e) {
            const turnstileWidget = form.querySelector('.cf-turnstile');
            if (turnstileWidget) {
              const tokenInput = form.querySelector('input[name="cf-turnstile-response"]');
              if (!tokenInput || !tokenInput.value) {
                e.preventDefault();
                alert('Veuillez patienter, la vérification de sécurité est en cours...');
                return false;
              }
            }
          });
        }
      });
    </script>
  <% end %>
<% end %>
