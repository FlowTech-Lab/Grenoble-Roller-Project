<%# Tableau statut glassmorphism avec mini-cards row %>
<div class="status-table-container">
  <div class="status-table-wrapper">
    <!-- En-tête du tableau -->
    <div class="status-table-header">
      <div class="status-col-person">Personne</div>
      <div class="status-col-status">Statut</div>
    </div>

    <!-- Contenu du tableau -->
    <div class="status-table-body">
      <!-- VOUS (Parent) -->
      <div class="status-row status-row-parent">
        <div class="status-cell status-col-person">
          <span class="status-badge-person">
            <i class="bi bi-person-circle text-liquid-primary me-2" aria-hidden="true"></i>
            <strong>Vous</strong>
          </span>
        </div>
        
        <div class="status-cell status-col-status">
          <% parent_has_active = current_user.memberships.active_now.exists? %>
          <% parent_free_trial_used = current_user.attendances.active.where(free_trial_used: true, child_membership_id: nil).exists? %>
          
          <% if parent_has_active %>
            <span class="badge bg-success fs-6">
              <i class="bi bi-check-circle me-1" aria-hidden="true"></i>
              Adhérent actif
            </span>
          <% elsif parent_free_trial_used %>
            <span class="badge bg-danger fs-6">
              <i class="bi bi-x-circle me-1" aria-hidden="true"></i>
              Essai utilisé
            </span>
          <% else %>
            <span class="badge bg-info fs-6">
              <i class="bi bi-lightning-charge me-1" aria-hidden="true"></i>
              Essai disponible
            </span>
          <% end %>
        </div>
      </div>

      <!-- ENFANTS -->
      <% child_memberships = current_user.memberships.where(is_child_membership: true).order(created_at: :desc) %>
      <% if child_memberships.any? %>
        <% child_memberships.each do |child| %>
          <div class="status-row status-row-child">
            <div class="status-cell status-col-person">
              <span class="status-badge-person">
                <i class="bi bi-person text-liquid-primary me-2" aria-hidden="true"></i>
                <span>
                  <strong><%= child.child_first_name %></strong> <small class="text-muted"><%= child.child_last_name %></small>
                </span>
              </span>
            </div>
            
            <div class="status-cell status-col-status">
              <% case child.status %>
              <% when 'active' %>
                <span class="badge bg-success fs-6">
                  <i class="bi bi-check-circle me-1" aria-hidden="true"></i>
                  Adhérent actif
                </span>
              <% when 'pending' %>
                <%# v4.0 : Essais gratuits NOMINATIFS - afficher l'état de l'essai gratuit indépendamment du statut du parent %>
                <% child_free_trial_used = current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists? %>
                <% if child_free_trial_used %>
                  <span class="badge bg-danger fs-6">
                    <i class="bi bi-x-circle me-1" aria-hidden="true"></i>
                    Essai utilisé
                  </span>
                <% else %>
                  <span class="badge bg-info fs-6">
                    <i class="bi bi-lightning-charge me-1" aria-hidden="true"></i>
                    Essai disponible
                  </span>
                <% end %>
              <% when 'trial' %>
                <%# v4.0 : Essais gratuits NOMINATIFS - afficher l'état de l'essai gratuit indépendamment du statut du parent %>
                <% child_free_trial_used = current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists? %>
                <% if child_free_trial_used %>
                  <span class="badge bg-danger fs-6">
                    <i class="bi bi-x-circle me-1" aria-hidden="true"></i>
                    Essai utilisé
                  </span>
                <% else %>
                  <span class="badge bg-info fs-6">
                    <i class="bi bi-lightning-charge me-1" aria-hidden="true"></i>
                    Essai disponible
                  </span>
                <% end %>
              <% when 'expired' %>
                <%# v4.0 : Essais gratuits NOMINATIFS - un enfant expired peut avoir un essai gratuit disponible s'il était pending/trial avant %>
                <%# Documentation ligne 2314 : Un enfant expired est traité comme un non-adhérent, les règles des cas 5-8 s'appliquent %>
                <% child_free_trial_used = current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists? %>
                <% if child_free_trial_used %>
                  <span class="badge bg-danger fs-6">
                    <i class="bi bi-x-circle me-1" aria-hidden="true"></i>
                    Essai utilisé
                  </span>
                <% else %>
                  <%# Essai disponible : l'enfant expired peut utiliser son essai gratuit (était pending/trial avant) %>
                  <span class="badge bg-info fs-6">
                    <i class="bi bi-lightning-charge me-1" aria-hidden="true"></i>
                    Essai disponible
                  </span>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
