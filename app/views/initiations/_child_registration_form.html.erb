<div class="card card-liquid shadow-sm">
  <div class="card-body p-3">
    <h4 class="h6 mb-3">
      <i class="bi bi-person-plus text-liquid-primary me-2" aria-hidden="true"></i>
      Inscrire un enfant supplémentaire
    </h4>

    <%= form_with url: attend_event_path_for(initiation), method: :post, local: true, data: { turbo: false } do |f| %>
      <!-- Sélection enfant -->
      <% 
        # Filtrer les enfants avec des adhésions actives, trial (essai gratuit) ou pending (en attente)
        # Pour les initiations, on permet les essais gratuits et les adhésions en attente
        child_memberships = current_user.memberships.where(is_child_membership: true)
          .where(status: [Membership.statuses[:active], Membership.statuses[:trial], Membership.statuses[:pending]])
        registered_child_ids = @child_attendances&.pluck(:child_membership_id).compact || []
        available_children = child_memberships.where.not(id: registered_child_ids)
      %>
      
      <% if available_children.any? %>
        <div class="mb-3">
          <%= f.label :child_membership_id, "Sélectionner un enfant", class: "form-label" %>
          <%= f.collection_select :child_membership_id, 
              available_children, 
              :id, 
              ->(m) { "#{m.child_first_name} #{m.child_last_name}" }, 
              { prompt: "Choisir un enfant" }, 
              { class: "form-select", required: true } %>
          <small class="text-muted">
            <i class="bi bi-check-circle me-1 text-success" aria-hidden="true"></i>
            Seuls les enfants avec une adhésion active, un essai gratuit ou une adhésion en attente, et non déjà inscrits sont affichés.
          </small>
        </div>

        <!-- Demande matériel -->
        <div class="mb-3">
          <%= f.label :equipment_note, "Demande de matériel (optionnel)", class: "form-label" %>
          <%= f.text_area :equipment_note, 
              class: "form-control", 
              rows: 2,
              placeholder: "Ex: Demande rollers taille 32" %>
          <small class="text-muted">
            <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
            Sous réserve de disponibilité du matériel.
          </small>
        </div>

        <!-- Essai gratuit (OBLIGATOIRE pour enfants pending et trial - nominatif) -->
        <% 
          # RÈGLE v4.0 : Les essais gratuits sont NOMINATIFS - chaque enfant DOIT utiliser son propre essai gratuit
          # Vérifier si l'enfant sélectionné a un statut pending ou trial et peut utiliser son essai gratuit
          # Note: On ne peut pas vérifier ici car l'enfant n'est pas encore sélectionné, mais le contrôleur vérifiera
          # On affichera la checkbox via JavaScript selon l'enfant sélectionné
        %>
        <div class="mb-3 form-check" id="free_trial_container_child_form" style="display: none;">
          <%= f.check_box :use_free_trial, { class: "form-check-input", id: "use_free_trial_child_form", required: false }, "1", "0" %>
          <%= f.label :use_free_trial, class: "form-check-label", id: "free_trial_text_child_form" do %>
            <i class="bi bi-gift me-1" aria-hidden="true"></i>
            <span id="free_trial_label_child_form">Utiliser l'essai gratuit (OBLIGATOIRE)</span>
          <% end %>
          <small class="text-muted d-block mt-1" id="free_trial_help_text_child_form">
            Les essais gratuits sont nominatifs - chaque enfant a droit à son propre essai gratuit. Cette case doit être cochée pour confirmer l'inscription.
          </small>
        </div>

        <!-- Rappel email -->
        <div class="mb-3 form-check">
          <%= f.check_box :wants_reminder, { checked: true, class: "form-check-input" }, "1", "0" %>
          <%= f.label :wants_reminder, class: "form-check-label" do %>
            <i class="bi bi-bell me-1" aria-hidden="true"></i>
            Recevoir un rappel email la veille à 19h
          <% end %>
        </div>

        <!-- Bouton submit -->
        <div class="d-grid">
          <%= f.submit "Inscrire cet enfant", 
              class: "btn btn-liquid-primary",
              id: "submit_child_form",
              data: { disable_with: "Inscription en cours..." } %>
        </div>
        
        <script>
          // RÈGLE v4.0 : Les essais gratuits sont NOMINATIFS - chaque enfant DOIT utiliser son propre essai gratuit
          // Gérer l'affichage de la checkbox d'essai gratuit selon l'enfant sélectionné
          (function() {
            const childSelect = document.querySelector('select[name="child_membership_id"]');
            const freeTrialContainer = document.getElementById('free_trial_container_child_form');
            const freeTrialCheckbox = document.getElementById('use_free_trial_child_form');
            const freeTrialLabel = document.getElementById('free_trial_label_child_form');
            const freeTrialHelpText = document.getElementById('free_trial_help_text_child_form');
            const submitBtn = document.getElementById('submit_child_form');
            
            // Données des enfants (récupérées depuis le serveur)
            const childMemberships = <%= raw available_children.map { |child| {
              id: child.id,
              status: child.status,
              first_name: child.child_first_name,
              last_name: child.child_last_name,
              has_used_trial: current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?,
              can_use_trial: !current_user.attendances.active.where(free_trial_used: true, child_membership_id: child.id).exists?
            } }.to_json %>;
            
            function updateFreeTrialDisplay() {
              if (!childSelect || !freeTrialContainer) return;
              
              const selectedChildId = parseInt(childSelect.value);
              const selectedChild = childMemberships.find(c => c.id === selectedChildId);
              
              if (selectedChild && (selectedChild.status === 'trial' || selectedChild.status === 'pending')) {
                // Enfant trial ou pending : essai gratuit OBLIGATOIRE (nominatif)
                if (selectedChild.can_use_trial) {
                  freeTrialContainer.style.display = 'block';
                  const childName = `${selectedChild.first_name} ${selectedChild.last_name}`;
                  freeTrialLabel.textContent = `Utiliser l'essai gratuit de ${childName} (OBLIGATOIRE)`;
                  freeTrialHelpText.textContent = `Les essais gratuits sont nominatifs - chaque enfant a droit à son propre essai gratuit. Cette case doit être cochée pour confirmer l'inscription.`;
                  if (freeTrialCheckbox) {
                    freeTrialCheckbox.checked = true;
                    freeTrialCheckbox.required = true;
                  }
                } else {
                  // Essai déjà utilisé
                  freeTrialContainer.style.display = 'none';
                  if (freeTrialCheckbox) {
                    freeTrialCheckbox.checked = false;
                    freeTrialCheckbox.required = false;
                  }
                }
              } else {
                // Enfant active ou aucun enfant sélectionné
                freeTrialContainer.style.display = 'none';
                if (freeTrialCheckbox) {
                  freeTrialCheckbox.checked = false;
                  freeTrialCheckbox.required = false;
                }
              }
            }
            
            if (childSelect) {
              childSelect.addEventListener('change', updateFreeTrialDisplay);
              // Initialiser au chargement
              updateFreeTrialDisplay();
            }
          })();
        </script>
      <% else %>
        <p class="text-muted mb-0">
          <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
          Tous vos enfants sont déjà inscrits à cette séance.
        </p>
      <% end %>
    <% end %>
  </div>
</div>

