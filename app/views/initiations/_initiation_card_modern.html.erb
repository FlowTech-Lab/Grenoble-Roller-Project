<div class="col-12 col-sm-6 col-lg-4<%= ' position-relative' if local_assigns[:is_first] %>">
  <% if local_assigns[:is_first] %>
    <!-- Badge "Prochaine" sur la première initiation -->
    <span class="badge bg-warning text-dark position-absolute" style="left: 2.5rem; z-index: 10;">
      <i class="bi bi-star-fill me-1" aria-hidden="true"></i>Prochaine
    </span>
  <% end %>
  <article class="card card-event card-liquid rounded-liquid shadow-liquid h-100">
    <div class="card-event-image">
      <% if initiation.cover_image.attached? %>
        <%= image_tag(rails_representation_path(initiation.cover_image_card), alt: initiation.title, loading: 'lazy', class: 'w-100 h-100 object-fit-cover') %>
      <% end %>
      <span class="card-event-date badge badge-liquid-primary">
        <i class="bi bi-calendar3 me-1" aria-hidden="true"></i>
        <%= l initiation.start_at, format: :day_month, locale: :fr %>
      </span>
    </div>

    <div class="card-body d-flex flex-column p-3 p-md-4">
      <!-- Zone de contenu -->
      <div class="flex-grow-1 mb-3">
        <h5 class="card-title mb-2 text-body h6 fw-bold">
          <%= link_to initiation.title, initiation_path(initiation), 
              class: 'text-decoration-none text-body', 
              aria: { label: "Voir les détails de #{initiation.title}" } %>
        </h5>

        <div class="card-event-info mb-3 text-body-secondary small">
          <p class="mb-1">
            <i class="bi bi-calendar-week text-liquid-primary me-2" aria-hidden="true"></i>
            <%= l initiation.start_at, format: :event_long, locale: :fr %>
          </p>
          <p class="mb-1">
            <i class="bi bi-geo-alt text-liquid-primary me-2" aria-hidden="true"></i>
            <% 
              # Retirer "France" du texte de localisation
              location_text_clean = initiation.location_text.to_s.gsub(/\s*,\s*France\s*$/i, '').gsub(/\s*France\s*$/i, '').strip
              # Séparer l'adresse pour mobile : saut de ligne avant code postal et ville
              location_parts = location_text_clean.split(',').map(&:strip).reject(&:blank?)
              if location_parts.length > 1
                # Prendre tout sauf le dernier élément (adresse), puis le dernier (code postal + ville)
                address_part = location_parts[0..-2].join(', ')
                postal_city = location_parts.last
            %>
              <span class="d-inline"><%= address_part %>,</span><br><span class="d-inline"><%= postal_city %></span>
            <% else %>
              <%= location_text_clean %>
            <% end %>
          </p>
          <p class="mb-0">
            <i class="bi bi-clock text-liquid-primary me-2" aria-hidden="true"></i>
            <%= format_event_duration(initiation) %>
          </p>
        </div>

        <div class="d-flex flex-wrap gap-2 mb-3">
          <!-- Badge Statut (pour admins/moderateurs) -->
          <% if can_moderate? && !initiation.published? && !initiation.canceled? %>
            <span class="badge bg-warning text-dark">
              <i class="bi bi-hourglass-split me-1" aria-hidden="true"></i>En attente
            </span>
          <% end %>
          <!-- Badge Annulé (prioritaire) -->
          <% if initiation.canceled? %>
            <span class="badge bg-danger">
              <i class="bi bi-x-octagon me-1" aria-hidden="true"></i>Annulé
            </span>
          <% end %>
          
          <span class="badge bg-primary">
            <i class="bi bi-people-fill me-1" aria-hidden="true"></i>
            <%= pluralize(initiation.participants_count, "inscrit", "inscrits") %>
          </span>
          
            <% if initiation.allow_non_member_discovery? %>
              <!-- Affichage séparé si l'option est activée -->
              <% if initiation.full? %>
                <span class="badge bg-danger">
                  <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Complet
                </span>
              <% else %>
                <% if initiation.available_member_places > 0 %>
                  <span class="badge bg-success">
                    <i class="bi bi-check-circle me-1" aria-hidden="true"></i>
                    <%= pluralize(initiation.available_member_places, "place adhérent") %>
                  </span>
                <% end %>
                <% if initiation.available_non_member_places > 0 %>
                  <span class="badge bg-info">
                    <i class="bi bi-gift me-1" aria-hidden="true"></i>
                    <%= pluralize(initiation.available_non_member_places, "place découverte") %>
                  </span>
                <% end %>
              <% end %>
            <% else %>
              <!-- Affichage classique -->
              <% if initiation.full? %>
                <span class="badge bg-danger">
                  <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Complet
                </span>
              <% elsif initiation.available_places <= 5 %>
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-exclamation-triangle me-1" aria-hidden="true"></i>
                  <%= pluralize(initiation.available_places, "place disponible") %>
                </span>
              <% else %>
                <span class="badge bg-success">
                  <i class="bi bi-check-circle me-1" aria-hidden="true"></i>
                  <%= pluralize(initiation.available_places, "place disponible") %>
                </span>
              <% end %>
            <% end %>
          
          <% if user_signed_in? && current_user_has_attendance?(initiation) %>
            <span class="badge bg-success">
              <i class="bi bi-check-circle me-1" aria-hidden="true"></i>Vous êtes inscrit(e)
            </span>
          <% end %>
        </div>
      </div>

      <div class="mt-auto">
        <div class="action-row d-flex flex-wrap gap-2">
          <!-- Bouton Découvrir en premier (action principale) -->
          <%= link_to(initiation_path(initiation), 
              class: "btn btn-liquid-primary btn-sm", 
              aria: { label: "Découvrir #{initiation.title}" }) do %>
            <i class="bi bi-compass me-1" aria-hidden="true"></i>Découvrir
          <% end %>

          <% if user_signed_in? %>
            <% if current_user_has_attendance?(initiation) %>
              <!-- Calendrier (action positive) -->
              <%= link_to initiation_path(initiation, format: :ics), 
                  class: "btn btn-outline-primary btn-sm", 
                  title: 'Ajouter au calendrier',
                  aria: { label: 'Ajouter au calendrier' } do %>
                <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>Calendrier
              <% end %>
            <% elsif initiation.full? %>
              <!-- Calendrier même si complet -->
              <%= link_to initiation_path(initiation, format: :ics), 
                  class: "btn btn-outline-primary btn-sm", 
                  title: 'Ajouter au calendrier',
                  aria: { label: 'Ajouter au calendrier' } do %>
                <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>Calendrier
              <% end %>
            <% end %>
          <% else %>
            <%= link_to new_user_session_path, 
                class: "btn btn-outline-primary btn-sm",
                aria: { label: 'Se connecter pour s\'inscrire' } do %>
              <i class="bi bi-box-arrow-in-right me-1" aria-hidden="true"></i>Connexion
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </article>
</div>

<% if user_signed_in? && policy(initiation).attend? && !initiation.full? %>
  <div class="modal fade" id="confirmAttendModalInitiation<%= initiation.id %>" tabindex="-1" aria-labelledby="confirmAttendModalInitiationLabel<%= initiation.id %>" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title h5" id="confirmAttendModalInitiationLabel<%= initiation.id %>">
            <i class="bi bi-calendar-check me-2" aria-hidden="true"></i>Confirmer votre inscription
          </h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <%= form_with url: attend_event_path_for(initiation), method: :post, local: true, data: { turbo: false }, id: "attendFormInitiation#{initiation.id}", class: "attend-form" do |f| %>
          <div class="modal-body">
            <%= render 'shared/registration_form_fields', 
                form: f, 
                event: initiation, 
                prefix_id: "_modal_#{initiation.id}", 
                show_alert: true, 
                show_summary: true %>

            <!-- Bouton Ajouter au calendrier -->
            <div class="mb-3 text-center">
              <%= link_to initiation_path(initiation, format: :ics), 
                  class: "btn btn-outline-primary btn-sm w-100", 
                  title: 'Ajouter au calendrier',
                  aria: { label: 'Ajouter au calendrier' } do %>
                <i class="bi bi-calendar-event me-2" aria-hidden="true"></i>Ajouter à mon calendrier
              <% end %>
            </div>
            
            <p class="mb-0 text-muted small">
              <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
              Vous recevrez une confirmation par email et pourrez annuler votre inscription à tout moment.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="cancelBtnInitiation<%= initiation.id %>">Annuler</button>
            <%= f.submit "Confirmer l'inscription", class: "btn btn-liquid-primary", id: "submitBtnInitiation#{initiation.id}", data: { bs_dismiss: "modal" } %>
          </div>
          <script>
            (function() {
              var initiationId = <%= initiation.id %>;
              var form = document.getElementById('attendFormInitiation' + initiationId);
              var submitBtn = document.getElementById('submitBtnInitiation' + initiationId);
              var cancelBtn = document.getElementById('cancelBtnInitiation' + initiationId);
              var childSelect = form ? form.querySelector('select[name="child_membership_id"]') : null;
              var volunteerToggle = document.getElementById('volunteer_toggle_' + initiationId);
              
              // Afficher/masquer le toggle bénévole selon la sélection d'enfant
              if (childSelect && volunteerToggle) {
                function toggleVolunteerVisibility() {
                  if (childSelect.value === '' || childSelect.value === null) {
                    volunteerToggle.style.display = 'block';
                  } else {
                    volunteerToggle.style.display = 'none';
                    // Décocher le toggle bénévole si un enfant est sélectionné
                    var volunteerCheckbox = document.getElementById('is_volunteer_modal_' + initiationId);
                    if (volunteerCheckbox) volunteerCheckbox.checked = false;
                  }
                }
                
                childSelect.addEventListener('change', toggleVolunteerVisibility);
                toggleVolunteerVisibility(); // Initialiser au chargement
              }
              
              if (form && submitBtn) {
                form.addEventListener('submit', function() {
                  submitBtn.disabled = true;
                  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Inscription en cours...';
                  if (cancelBtn) cancelBtn.disabled = true;
                });
              }
            })();
          </script>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Modal de désinscription multiple pour initiations -->
<% if user_signed_in? && current_user_has_attendance?(initiation) %>
  <% user_attendances = initiation.attendances.where(user: current_user).includes(:child_membership) %>
  <% parent_attendance = user_attendances.find_by(child_membership_id: nil) %>
  <% child_attendances = user_attendances.where.not(child_membership_id: nil) %>
  <% total_attendances = (parent_attendance ? 1 : 0) + child_attendances.count %>
  
  <% if total_attendances > 1 %>
    <div class="modal fade" id="cancelAttendanceModalInitiation<%= initiation.id %>" tabindex="-1" aria-labelledby="cancelAttendanceModalInitiationLabel<%= initiation.id %>" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title h5" id="cancelAttendanceModalInitiationLabel<%= initiation.id %>">
              <i class="bi bi-calendar-x text-danger me-2" aria-hidden="true"></i>Annuler une inscription
            </h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <p class="mb-3">Plusieurs personnes sont inscrites à cette séance. Sélectionnez celle(s) que vous souhaitez désinscrire :</p>
            
            <div class="list-group">
              <% if parent_attendance %>
                <%= button_to cancel_attendance_event_path_for(initiation), 
                    method: :delete, 
                    class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center",
                    data: { turbo_confirm: 'Annuler votre inscription ? Vous pouvez vous réinscrire plus tard si vous le souhaitez.' } do %>
                  <div>
                    <i class="bi bi-person-fill me-2" aria-hidden="true"></i>
                    <strong>Vous</strong>
                  </div>
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                <% end %>
              <% end %>
              
              <% child_attendances.each do |child_attendance| %>
                <%= button_to cancel_attendance_event_path_for(initiation), 
                    method: :delete, 
                    params: { child_membership_id: child_attendance.child_membership_id },
                    class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center",
                    data: { turbo_confirm: "Annuler l'inscription de #{child_attendance.participant_name} ?" } do %>
                  <div>
                    <i class="bi bi-person-heart me-2" aria-hidden="true"></i>
                    <strong><%= child_attendance.participant_name %></strong>
                  </div>
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                <% end %>
              <% end %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
