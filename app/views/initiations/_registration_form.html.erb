<div class="card card-liquid shadow-sm mb-4">
  <div class="card-body p-4">
    <h3 class="h5 mb-3">
      <i class="bi bi-calendar-check text-liquid-primary me-2" aria-hidden="true"></i>
      Confirmer votre inscription
    </h3>

    <!-- Alerte "Presque complet" si ≤5 places restantes -->
    <% if initiation.available_places <= 5 && initiation.available_places > 0 %>
      <div class="alert alert-warning mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
        <strong>Attention !</strong> Il ne reste que <%= pluralize(initiation.available_places, "place disponible", "places disponibles") %> pour cette séance.
      </div>
    <% end %>

    <%= form_with url: attend_initiation_path(initiation), method: :post, local: true, data: { turbo: false } do |f| %>
      <!-- Sélection enfant si applicable -->
      <% 
        # Filtrer uniquement les enfants avec des adhésions actives (éligibles pour les initiations)
        child_memberships = current_user.memberships.active_now.where(is_child_membership: true)
      %>
      <% if child_memberships.any? %>
        <div class="mb-3">
          <%= f.label :child_membership_id, "S'inscrire pour un enfant (optionnel)", class: "form-label" %>
          <%= f.collection_select :child_membership_id, 
              child_memberships, 
              :id, 
              ->(m) { "#{m.child_first_name} #{m.child_last_name}" }, 
              { prompt: "S'inscrire pour moi-même" }, 
              { class: "form-select" } %>
          <small class="text-muted">
            <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
            Seuls les enfants avec une adhésion active sont affichés. Laissez vide pour vous inscrire vous-même.
          </small>
        </div>
      <% end %>

      <!-- Demande matériel -->
      <div class="mb-3">
        <%= f.label :equipment_note, "Demande de matériel (optionnel)", class: "form-label" %>
        <%= f.text_area :equipment_note, 
            class: "form-control", 
            rows: 3,
            placeholder: "Ex: Demande rollers taille 40" %>
        <small class="text-muted">
          <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
          Sous réserve de disponibilité du matériel.
        </small>
      </div>

      <!-- Essai gratuit si disponible -->
      <% if !current_user.memberships.active_now.exists? && 
            !current_user.attendances.where(free_trial_used: true).exists? %>
        <div class="mb-3 form-check">
          <%= check_box_tag :use_free_trial, "1", false, { class: "form-check-input" } %>
          <%= label_tag :use_free_trial, class: "form-check-label" do %>
            <i class="bi bi-gift me-1" aria-hidden="true"></i>
            Utiliser mon essai gratuit
          <% end %>
          <small class="text-muted d-block mt-1">
            Vous n'avez pas encore utilisé votre essai gratuit. Après cet essai, une adhésion sera requise pour continuer.
          </small>
        </div>
      <% end %>

      <!-- Rappel email -->
      <div class="mb-4 form-check">
        <%= f.check_box :wants_reminder, { checked: true, class: "form-check-input" }, "1", "0" %>
        <%= f.label :wants_reminder, class: "form-check-label" do %>
          <i class="bi bi-bell me-1" aria-hidden="true"></i>
          Recevoir un rappel la veille à 19h
        <% end %>
      </div>

      <!-- Bouton submit -->
      <div class="d-grid">
        <%= f.submit "Confirmer l'inscription", 
            class: "btn btn-liquid-primary btn-lg",
            data: { disable_with: "Inscription en cours..." } %>
      </div>

      <p class="text-muted small mt-3 mb-0">
        <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
        Vous recevrez une confirmation par email et pourrez annuler votre inscription à tout moment.
      </p>
    <% end %>
  </div>
</div>

