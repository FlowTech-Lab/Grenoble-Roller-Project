<% content_for :title, "#{@product.name} - Boutique Grenoble Roller" %>
<% content_for :description, "#{@product.name} - #{@product.description.presence || 'Produit disponible dans la boutique Grenoble Roller'}. Commandez en ligne !" %>

<div class="container py-4 py-lg-5">
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "Accueil", root_path %></li>
          <li class="breadcrumb-item"><%= link_to "Boutique", shop_path %></li>
          <li class="breadcrumb-item active" aria-current="page"><%= @product.name %></li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Card unique : image à gauche, infos à droite -->
  <div class="card card-liquid rounded-liquid product-show-card">
    <div class="row g-4 align-items-stretch flex-column flex-lg-row">
      <!-- Image principale -->
      <div class="col-12 col-lg-5">
        <div class="card-product-image-wrapper product-show-image-wrapper" style="aspect-ratio: 1 / 1; max-height: 600px;">
          <div class="card-product-image">
            <% if @product.image_url.present? %>
              <%= image_tag @product.image_url, alt: @product.name, loading: "eager", decoding: "async", style: "object-fit: contain;" %>
            <% else %>
              <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                <i class="bi bi-image fs-1 text-muted" aria-hidden="true"></i>
              </div>
            <% end %>
          </div>
          <% 
            has_stock = @variants.any? { |v| v.stock_qty > 0 }
          %>
          <% if has_stock %>
            <span class="badge badge-liquid-success badge-stock">En stock</span>
          <% else %>
            <span class="badge badge-liquid-danger badge-stock">Rupture</span>
          <% end %>
        </div>
      </div>

      <!-- Informations produit -->
      <div class="col-12 col-lg-7 d-flex">
        <div class="card-body d-flex flex-column">
          <!-- Titre et catégorie -->
          <div class="mb-3">
            <h1 class="product-title mb-2"><%= @product.name %></h1>
            <% if @product.category %>
              <p class="text-muted mb-0">
                <i class="bi bi-tag me-1" aria-hidden="true"></i><%= @product.category.name %>
              </p>
            <% end %>
          </div>

          <!-- Description -->
          <% if @product.description.present? %>
            <div class="mb-4">
              <p class="product-description text-muted">
                <%= simple_format(@product.description) %>
              </p>
            </div>
          <% end %>

          <!-- pousse le bloc options + prix + CTA vers le bas -->
          <div class="spacer"></div>

          <!-- Sélection variantes -->
          <% if @variants.any? %>
            <% 
              size_options = @variants.flat_map { |v| v.option_values.select { |ov| ov.option_type.name == 'size' } }.uniq
              color_options = @variants.flat_map { |v| v.option_values.select { |ov| ov.option_type.name == 'color' } }.uniq
              single_variant = @variants.count == 1 ? @variants.first : nil

              size_stock = Hash.new(0)
              color_stock = Hash.new(0)
              @variants.each do |v|
                v.option_values.each do |ov|
                  case ov.option_type.name
                  when 'size'
                    size_stock[ov.id] += v.stock_qty
                  when 'color'
                    color_stock[ov.id] += v.stock_qty
                  end
                end
              end
            %>
            <% 
              min_price = @variants.minimum(:price_cents) || @product.price_cents
              max_price = @variants.maximum(:price_cents) || @product.price_cents
              has_multiple_prices = min_price != max_price
            %>
            <div class="product-options-section mb-3">
              <div class="product-options">
                <% if size_options.size > 1 %>
                  <select class="form-select form-select-sm product-size-select" 
                          aria-label="Choisir la taille" 
                          id="size-select-detail">
                    <option value="">Choisir taille</option>
                    <% size_options.each do |size_opt| %>
                      <% 
                        option_stock = size_stock[size_opt.id]
                      %>
                      <option value="<%= size_opt.id %>" <%= 'disabled' if option_stock <= 0 %>>
                        <%= size_opt.presentation %><%= ' (épuisé)' if option_stock <= 0 %>
                      </option>
                    <% end %>
                  </select>
                <% elsif size_options.size == 1 %>
                  <% size_opt = size_options.first %>
                  <p class="small text-body-secondary mb-1">
                    <strong>Taille :</strong> <%= size_opt.presentation %>
                    <% if size_stock[size_opt.id] <= 0 %>
                      <span class="text-danger ms-1">(plus en stock)</span>
                    <% end %>
                  </p>
                <% end %>
                
                <% if color_options.size > 1 %>
                  <select class="form-select form-select-sm product-color-select" 
                          aria-label="Choisir la couleur" 
                          id="color-select-detail">
                    <option value="">Choisir couleur</option>
                    <% color_options.each do |color_opt| %>
                      <% 
                        option_stock = color_stock[color_opt.id]
                      %>
                      <option value="<%= color_opt.id %>" <%= 'disabled' if option_stock <= 0 %>>
                        <%= color_opt.presentation %><%= ' (épuisé)' if option_stock <= 0 %>
                      </option>
                    <% end %>
                  </select>
                <% elsif color_options.size == 1 %>
                  <% color_opt = color_options.first %>
                  <p class="small text-body-secondary mb-1">
                    <strong>Couleur :</strong> <%= color_opt.presentation %>
                    <% if color_stock[color_opt.id] <= 0 %>
                      <span class="text-danger ms-1">(plus en stock)</span>
                    <% end %>
                  </p>
                <% end %>
                
                <% if size_options.empty? && color_options.empty? %>
                  <p class="small text-body-secondary mb-1">
                    <strong>Taille :</strong> Taille unique
                  </p>
                <% end %>
              </div>
              <small id="stock_hint" class="text-muted d-block mt-2" style="display: none;">
                Stock: <span id="stock_value">0</span>
                &mdash;
                Prix unitaire: <span id="unit_price_value"><%= format_price(min_price) %></span>
              </small>
            </div>
          <% end %>

          <!-- Prix + Quantité et ajout au panier -->
          <div class="mt-auto">
            <%= form_with url: add_item_cart_path, method: :post, class: "d-flex flex-column gap-3", id: "add-to-cart-form", data: { turbo: false } do |f| %>
              <%= hidden_field_tag :variant_id, single_variant ? single_variant.id : "", id: "variant-id-detail", required: true %>
              
              <div class="d-flex align-items-center justify-content-between gap-3 align-items-end flex-wrap product-qty-total-row">
                <label for="quantity_field" class="form-label mb-0">Quantité:</label>
                <div class="qty-control">
                  <%= button_tag type: "button", class: "qty-btn", aria: { label: "Diminuer" }, onclick: "decrementQtyDetail()" do %>
                    <i class="bi bi-dash" aria-hidden="true"></i>
                  <% end %>
                  <%= number_field_tag :quantity, 1, min: 1, max: (single_variant&.stock_qty.to_i if single_variant), class: "form-control form-control-sm border-0 bg-transparent p-0 form-control-number-compact", id: "quantity_field", style: "width: 3em;" %>
                  <%= button_tag type: "button", class: "qty-btn", aria: { label: "Augmenter" }, onclick: "incrementQtyDetail()" do %>
                    <i class="bi bi-plus" aria-hidden="true"></i>
                  <% end %>
                </div>
                <div class="text-end fw-semibold text-liquid-primary product-total">
                  <span class="product-total-label">Total :</span>
                  <span id="price_detail"><%= format_price(min_price) %></span>
                </div>
              </div>

              <div class="d-flex flex-column flex-md-row gap-2 mt-3 product-actions-row">
                <%= link_to cart_path, class: "btn btn-outline-primary btn-sm w-100 w-md-auto product-cart-link" do %>
                  <i class="bi bi-basket me-1" aria-hidden="true"></i>
                  Voir le panier
                <% end %>

                <button type="submit" 
                        class="btn btn-liquid-primary w-100 product-add-btn" 
                        id="add-btn-detail"
                        <%= 'disabled' unless single_variant && single_variant.stock_qty > 0 %>>
                  <i class="bi bi-cart-plus me-2" aria-hidden="true"></i>
                  <span>Ajouter au panier</span>
                </button>
              </div>
            <% end %>
          </div> <!-- /.mt-auto -->
        </div> <!-- /.card-body -->
      </div> <!-- /.col infos -->
    </div> <!-- /.row -->
  </div> <!-- /.card product-show-card -->
</div>

<script>
  function initProductShow() {
    // Map des variantes avec leurs options
    const productVariants = [
      <% @variants.each do |v| %>
        {
          id: <%= v.id %>,
          sizeId: <%= (v.option_values.find { |ov| ov.option_type.name == 'size' }&.id || 'null') %>,
          colorId: <%= (v.option_values.find { |ov| ov.option_type.name == 'color' }&.id || 'null') %>,
          stock: <%= v.stock_qty %>,
          price: <%= v.price_cents %>
        },
      <% end %>
    ];

    const sizeSelect = document.getElementById('size-select-detail');
    const colorSelect = document.getElementById('color-select-detail');
    const variantInput = document.getElementById('variant-id-detail');
    const addBtn = document.getElementById('add-btn-detail');
    const stockHint = document.getElementById('stock_hint');
    const qtyField = document.getElementById('quantity_field');
    const priceDisplay = document.getElementById('price_detail');

    function updateVariant() {
      const sizeId = sizeSelect && sizeSelect.value ? parseInt(sizeSelect.value) : null;
      const colorId = colorSelect && colorSelect.value ? parseInt(colorSelect.value) : null;

      // Si des sélecteurs existent mais sont vides, ne pas trouver de variante
      const hasSizeSelect = sizeSelect !== null;
      const hasColorSelect = colorSelect !== null;
      const sizeSelected = sizeId !== null;
      const colorSelected = colorId !== null;

      // Si des sélecteurs existent mais sont vides, ne pas trouver de variante
      let variant = null;
      
      if ((hasSizeSelect && !sizeSelected) || (hasColorSelect && !colorSelected)) {
        // Au moins un sélecteur existe mais n'est pas rempli, pas de variante
        variant = null;
      } else {
        // Trouver la variante correspondante
        variant = productVariants.find(v => {
          const matchSize = !hasSizeSelect ? true : (v.sizeId === sizeId || v.sizeId === null);
          const matchColor = !hasColorSelect ? true : (v.colorId === colorId || v.colorId === null);
          return matchSize && matchColor;
        });
      }

      if (variant && variant.stock > 0) {
        variantInput.value = variant.id;
        addBtn.disabled = false;
        
        // Afficher et mettre à jour le stock
        if (stockHint) {
          const stockValue = stockHint.querySelector('#stock_value');
          if (stockValue) {
            stockValue.textContent = variant.stock;
          }
          // on affiche le bloc stock + prix unitaire
          stockHint.style.display = 'block';
        }
        
        // Mettre à jour la quantité max
        if (qtyField) {
          qtyField.max = variant.stock;
          let current = parseInt(qtyField.value || '1', 10);
          if (current > variant.stock) {
            current = variant.stock;
          }
          if (current < 1 || isNaN(current)) {
            current = 1;
          }
          qtyField.value = current;
        }
        
        // Mettre à jour le prix total en fonction de la quantité
        if (priceDisplay) {
          const qty = qtyField ? Math.max(1, parseInt(qtyField.value || '1', 10)) : 1;
          priceDisplay.textContent = formatPriceFromCents(variant.price * qty);
        }
      } else {
        variantInput.value = '';
        addBtn.disabled = true;
        
        // Cacher le stock si aucune variante sélectionnée
        if (stockHint) {
          const stockValue = stockHint.querySelector('#stock_value');
          if (stockValue) {
            stockValue.textContent = '0';
          }
          // on masque complètement l'info stock quand aucune variante n'est sélectionnée
          stockHint.style.display = 'none';
        }
        
        if (qtyField) {
          qtyField.max = 0;
        }
      }
    }

    // Event listeners pour les sélecteurs
    if (sizeSelect) sizeSelect.addEventListener('change', updateVariant);
    if (colorSelect) colorSelect.addEventListener('change', updateVariant);

    // Initial update (ne sélectionne rien par défaut si options présentes)
    updateVariant();

    // Fonctions pour la quantité
    window.incrementQtyDetail = function() {
      if (!qtyField) return;
      const max = parseInt(qtyField.max || '0', 10);
      const current = parseInt(qtyField.value || '1', 10);
      if (max > 0 && current < max) {
        qtyField.value = current + 1;
        updateVariant();
      }
    };

    window.decrementQtyDetail = function() {
      if (!qtyField) return;
      const current = parseInt(qtyField.value || '1', 10);
      if (current > 1) {
        qtyField.value = current - 1;
        updateVariant();
      }
    };

    // Formatage du prix
    function formatPriceFromCents(cents) {
      const amount = cents / 100.0;
      const formatted = amount === Math.floor(amount) ? amount.toString() : amount.toFixed(2);
      return formatted.replace('.', ',') + '€';
    }

    // Validation du formulaire
    const form = document.getElementById('add-to-cart-form');
    if (form && qtyField) {
      form.addEventListener('submit', function(e) {
        const max = parseInt(qtyField.max || '0', 10);
        const val = parseInt(qtyField.value || '1', 10);
        if (max > 0 && val > max) {
          e.preventDefault();
          qtyField.value = max;
          alert('Quantité ajustée au stock disponible (' + max + ').');
        }
        if (!variantInput.value) {
          e.preventDefault();
          alert('Veuillez sélectionner une variante.');
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', initProductShow);
  document.addEventListener('turbo:load', initProductShow);
</script>
