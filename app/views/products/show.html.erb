<% content_for :title, "#{@product.name} - Boutique Grenoble Roller" %>
<% content_for :description, "#{@product.name} - #{@product.description.presence || 'Produit disponible dans la boutique Grenoble Roller'}. Commandez en ligne !" %>

<div class="container py-4 py-lg-5">
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "Accueil", root_path %></li>
          <li class="breadcrumb-item"><%= link_to "Boutique", shop_path %></li>
          <li class="breadcrumb-item active" aria-current="page"><%= @product.name %></li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Bannière temporaire vers l'ancienne boutique HelloAsso -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-info d-flex align-items-center justify-content-between flex-wrap gap-2" role="alert">
        <div class="d-flex align-items-center">
          <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
          <span>Boutique temporairement en cours de migration. En attendant, accédez à notre <strong>ancienne boutique HelloAsso</strong>.</span>
        </div>
        <%= link_to "https://www.helloasso.com/associations/grenoble-roller/boutiques/boutique", 
            target: "_blank", 
            rel: "noopener noreferrer",
            class: "btn btn-sm btn-outline-primary flex-shrink-0" do %>
          <i class="bi bi-box-arrow-up-right me-1" aria-hidden="true"></i>
          Accéder à la boutique HelloAsso
        <% end %>
      </div>
    </div>
  </div>

  <!-- Card unique : image à gauche, infos à droite -->
  <div class="card card-liquid rounded-liquid product-show-card"
       data-controller="product-show"
       data-product-show-variants-value='<%= @variants.map { |v| 
         begin
           option_vals = v.option_values.to_a
         rescue
           option_vals = []
         end
         {
           id: v.id,
           sizeId: option_vals.find { |ov| ov.option_type&.name == 'size' }&.id,
           colorId: option_vals.find { |ov| ov.option_type&.name == 'color' }&.id,
           stock: v.stock_qty,
           price: v.price_cents,
           imageUrl: variant_image_url(v).present? ? (v.image.attached? ? url_for(v.image) : asset_path(v.image_url.presence || @product.image_url)) : ""
         }
       }.to_json.html_safe %>'
       data-product-show-default-image-url-value="<%= (@product.image.attached? ? url_for(@product.image) : asset_path(@product.image_url)).to_json.html_safe %>">
    <div class="row g-4 align-items-stretch flex-column flex-lg-row">
      <!-- Image principale -->
      <div class="col-12 col-lg-5">
        <div class="card-product-image-wrapper product-show-image-wrapper" style="aspect-ratio: 1 / 1; max-height: 600px;">
          <div class="card-product-image" 
               style="<%= 'cursor: pointer;' if @product.image.attached? || @product.image_url.present? %>"
               <% if @product.image.attached? || @product.image_url.present? %>
                 data-bs-toggle="modal" 
                 data-bs-target="#productImageModalShow"
                 aria-label="Agrandir l'image de <%= @product.name %>"
               <% end %>>
            <% if @product.image.attached? %>
              <%= image_tag @product.image, alt: @product.name, loading: "eager", decoding: "async", style: "object-fit: contain;", data: { product_show_target: "productImage" } %>
            <% elsif @product.image_url.present? %>
              <%= image_tag @product.image_url, alt: @product.name, loading: "eager", decoding: "async", style: "object-fit: contain;", data: { product_show_target: "productImage" } %>
            <% else %>
              <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                <i class="bi bi-image fs-1 text-muted" aria-hidden="true"></i>
              </div>
            <% end %>
          </div>
          <% 
            has_stock = @variants.any? { |v| v.stock_qty > 0 }
          %>
          <% if has_stock %>
            <span class="badge badge-liquid-success badge-stock">En stock</span>
          <% else %>
            <span class="badge badge-liquid-danger badge-stock">Rupture</span>
          <% end %>
        </div>
      </div>

      <!-- Informations produit -->
      <div class="col-12 col-lg-7 d-flex">
        <div class="card-body d-flex flex-column">
          <!-- Titre et catégorie -->
          <div class="mb-3">
            <h1 class="product-title mb-2"><%= @product.name %></h1>
            <% if @product.category %>
              <p class="text-muted mb-0">
                <i class="bi bi-tag me-1" aria-hidden="true"></i><%= @product.category.name %>
              </p>
            <% end %>
          </div>

          <!-- Description -->
          <% if @product.description.present? %>
            <div class="mb-4">
              <p class="product-description text-muted">
                <%= simple_format(@product.description) %>
              </p>
            </div>
          <% end %>

          <!-- pousse le bloc options + prix + CTA vers le bas -->
          <div class="spacer"></div>

          <!-- Sélection variantes -->
          <% if @variants.any? %>
            <% 
              size_options = @variants.flat_map { |v| v.option_values.select { |ov| ov.option_type.name == 'size' } }.uniq
              color_options = @variants.flat_map { |v| v.option_values.select { |ov| ov.option_type.name == 'color' } }.uniq
              single_variant = @variants.count == 1 ? @variants.first : nil

              size_stock = Hash.new(0)
              color_stock = Hash.new(0)
              @variants.each do |v|
                v.option_values.each do |ov|
                  case ov.option_type.name
                  when 'size'
                    size_stock[ov.id] += v.stock_qty
                  when 'color'
                    color_stock[ov.id] += v.stock_qty
                  end
                end
              end
            %>
            <% 
              min_price = @variants.minimum(:price_cents) || @product.price_cents
              max_price = @variants.maximum(:price_cents) || @product.price_cents
              has_multiple_prices = min_price != max_price
            %>
            <div class="product-options-section mb-3">
              <div class="product-options">
                <% if size_options.size > 1 %>
                  <select class="form-select form-select-sm product-size-select" 
                          aria-label="Choisir la taille" 
                          id="size-select-detail"
                          data-product-show-target="sizeSelect"
                          data-action="change->product-show#sizeChanged">
                    <option value="">Choisir taille</option>
                    <% size_options.each do |size_opt| %>
                      <% 
                        option_stock = size_stock[size_opt.id]
                      %>
                      <option value="<%= size_opt.id %>" <%= 'disabled' if option_stock <= 0 %>>
                        <%= size_opt.presentation %><%= ' (épuisé)' if option_stock <= 0 %>
                      </option>
                    <% end %>
                  </select>
                <% elsif size_options.size == 1 %>
                  <% size_opt = size_options.first %>
                  <p class="small text-body-secondary mb-1">
                    <strong>Taille :</strong> <%= size_opt.presentation %>
                    <% if size_stock[size_opt.id] <= 0 %>
                      <span class="text-danger ms-1">(plus en stock)</span>
                    <% end %>
                  </p>
                <% end %>
                
                <% if color_options.size > 1 %>
                  <select class="form-select form-select-sm product-color-select" 
                          aria-label="Choisir la couleur" 
                          id="color-select-detail"
                          data-product-show-target="colorSelect"
                          data-action="change->product-show#colorChanged">
                    <option value="">Choisir couleur</option>
                    <% color_options.each do |color_opt| %>
                      <% 
                        option_stock = color_stock[color_opt.id]
                      %>
                      <option value="<%= color_opt.id %>" <%= 'disabled' if option_stock <= 0 %>>
                        <%= color_opt.presentation %><%= ' (épuisé)' if option_stock <= 0 %>
                      </option>
                    <% end %>
                  </select>
                <% elsif color_options.size == 1 %>
                  <% color_opt = color_options.first %>
                  <p class="small text-body-secondary mb-1">
                    <strong>Couleur :</strong> <%= color_opt.presentation %>
                    <% if color_stock[color_opt.id] <= 0 %>
                      <span class="text-danger ms-1">(plus en stock)</span>
                    <% end %>
                  </p>
                <% end %>
                
                <% if size_options.empty? && color_options.empty? %>
                  <p class="small text-body-secondary mb-1">
                    <strong>Taille :</strong> Taille unique
                  </p>
                <% end %>
              </div>
              <small id="stock_hint" class="text-muted d-block mt-2" style="display: none;" data-product-show-target="stockHint">
                Stock: <span id="stock_value" data-product-show-target="stockValue">0</span>
                &mdash;
                Prix unitaire: <span id="unit_price_value" data-product-show-target="unitPriceValue"><%= format_price(min_price) %></span>
              </small>
            </div>
          <% end %>

          <!-- Prix + Quantité et ajout au panier -->
          <div class="mt-auto">
            <%= form_with url: add_item_cart_path, method: :post, class: "d-flex flex-column gap-3", id: "add-to-cart-form", data: { turbo: false } do |f| %>
              <%= hidden_field_tag :variant_id, single_variant ? single_variant.id : "", id: "variant-id-detail", required: true, data: { product_show_target: "variantInput" } %>
              
              <div class="d-flex align-items-center justify-content-between gap-3 align-items-end flex-wrap product-qty-total-row">
                <label for="quantity_field" class="form-label mb-0">Quantité:</label>
                <div class="qty-control">
                  <%= button_tag type: "button", class: "qty-btn", aria: { label: "Diminuer" }, data: { action: "click->product-show#decrementQty" } do %>
                    <i class="bi bi-dash" aria-hidden="true"></i>
                  <% end %>
                  <%= number_field_tag :quantity, 1, min: 1, max: (single_variant&.stock_qty.to_i if single_variant), class: "form-control form-control-sm border-0 bg-transparent p-0 form-control-number-compact", id: "quantity_field", style: "width: 3em;", data: { product_show_target: "qtyField", action: "input->product-show#quantityChanged" } %>
                  <%= button_tag type: "button", class: "qty-btn", aria: { label: "Augmenter" }, data: { action: "click->product-show#incrementQty" } do %>
                    <i class="bi bi-plus" aria-hidden="true"></i>
                  <% end %>
                </div>
                <div class="text-end fw-semibold text-liquid-primary product-total">
                  <span class="product-total-label">Total :</span>
                  <span id="price_detail" data-product-show-target="priceDisplay"><%= format_price(min_price) %></span>
                </div>
              </div>

              <div class="d-flex flex-column flex-md-row gap-2 mt-3 product-actions-row">
                <%= link_to cart_path, class: "btn btn-outline-primary btn-sm w-100 w-md-auto product-cart-link" do %>
                  <i class="bi bi-basket me-1" aria-hidden="true"></i>
                  Voir le panier
                <% end %>

                <button type="submit" 
                        class="btn btn-liquid-primary w-100 product-add-btn" 
                        id="add-btn-detail"
                        data-product-show-target="addButton"
                        <%= 'disabled' unless single_variant && single_variant.stock_qty > 0 %>>
                  <i class="bi bi-cart-plus me-2" aria-hidden="true"></i>
                  <span>Ajouter au panier</span>
                </button>
              </div>
            <% end %>
          </div> <!-- /.mt-auto -->
        </div> <!-- /.card-body -->
      </div> <!-- /.col infos -->
    </div> <!-- /.row -->
  </div> <!-- /.card product-show-card -->
</div>

<!-- Modal Lightbox pour image produit (en dehors de la card pour le z-index Bootstrap) -->
<% if @product.image_url.present? || @product.image.attached? %>
  <div class="modal fade" id="productImageModalShow" tabindex="-1" aria-labelledby="productImageModalLabelShow" aria-hidden="true"
       data-product-show-target="modal">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title text-white" id="productImageModalLabelShow"><%= @product.name %></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body p-0 text-center">
          <% if @product.image.attached? %>
            <%= image_tag @product.image, alt: @product.name, class: "img-fluid rounded", style: "max-height: 80vh; width: auto;", id: "productModalImage" %>
          <% elsif @product.image_url.present? %>
            <%= image_tag @product.image_url, alt: @product.name, class: "img-fluid rounded", style: "max-height: 80vh; width: auto;", id: "productModalImage" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>
