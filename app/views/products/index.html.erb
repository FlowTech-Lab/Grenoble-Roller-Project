<% content_for :title, "Boutique - Grenoble Roller" %>
<% content_for :description, "Boutique officielle Grenoble Roller. Découvrez nos produits et accessoires Roller. Commandez en ligne et recevez vos articles rapidement !" %>

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="display-5 text-liquid-primary-white mb-2">
        <i class="bi bi-bag-heart me-2" aria-hidden="true"></i>Boutique
      </h1>
    </div>
  </div>

  <!-- Bannière temporaire vers l'ancienne boutique HelloAsso -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-info d-flex align-items-center justify-content-between flex-wrap gap-2" role="alert">
        <div class="d-flex align-items-center">
          <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
          <span>Boutique en cours de migration. En attendant, accédez à notre <strong>ancienne boutique HelloAsso</strong>.</span>
        </div>
        <%= link_to "https://www.helloasso.com/associations/grenoble-roller/boutiques/boutique", 
            target: "_blank", 
            rel: "noopener noreferrer",
            class: "btn btn-sm btn-outline-primary flex-shrink-0" do %>
          <i class="bi bi-box-arrow-up-right me-1" aria-hidden="true"></i>
          Accéder à la boutique HelloAsso
        <% end %>
      </div>
    </div>
  </div>

  <section class="mb-5" aria-label="Catalogue produits">
    <div class="row">
      <!-- Sidebar filtres catégories -->
      <aside class="col-12 col-md-3 mb-4 mb-md-0" aria-label="Filtres par catégorie">
        <div class="card card-liquid rounded-liquid shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-3">
              <i class="bi bi-funnel text-liquid-primary me-2" aria-hidden="true"></i>Catégories
            </h2>
            
            <div class="d-flex flex-column gap-2">
              <%= link_to products_path, 
                  class: "category-filter-item text-decoration-none #{'active' unless @selected_category}" do %>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-truncate me-2">
                    <i class="bi bi-grid me-2" aria-hidden="true"></i>Tous les produits
                  </span>
                  <span class="badge <%= @selected_category.nil? ? 'bg-primary' : 'bg-secondary' %> flex-shrink-0"><%= Product.where(is_active: true).count %></span>
                </div>
              <% end %>
              
              <% @categories.each do |category| %>
                <% 
                  is_active = @selected_category&.id == category.id
                  count = @category_counts[category.id] || 0
                %>
                <% if count > 0 %>
                  <%= link_to products_path(category: category.slug), 
                      class: "category-filter-item text-decoration-none #{'active' if is_active}" do %>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="text-truncate me-2">
                        <i class="bi bi-tag me-2" aria-hidden="true"></i><%= category.name %>
                      </span>
                      <span class="badge <%= is_active ? 'bg-primary' : 'bg-secondary' %> flex-shrink-0"><%= count %></span>
                    </div>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </aside>
      
      <!-- Contenu principal -->
      <div class="col-12 col-md-9">
        <% if @selected_category %>
          <div class="mb-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <h2 class="h5 mb-0">
                <i class="bi bi-tag-fill text-liquid-primary me-2" aria-hidden="true"></i>
                <%= @selected_category.name %>
                <span class="badge bg-secondary ms-2"><%= @products.count %> produit<%= 's' if @products.count > 1 %></span>
              </h2>
              <%= link_to products_path, class: "btn btn-sm btn-outline-secondary" do %>
                <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Effacer le filtre
              <% end %>
            </div>
          </div>
        <% end %>
        
        <div class="product-grid">
          <% @products.each do |product| %>
            <% 
              active_variants = product.product_variants.where(is_active: true).includes(variant_option_values: { option_value: :option_type })
              has_stock = active_variants.any? { |v| v.stock_qty > 0 }
              min_price = active_variants.minimum(:price_cents) || product.price_cents
              max_price = active_variants.maximum(:price_cents) || product.price_cents
              has_multiple_prices = min_price != max_price
              
              # Group variants by option types (size, color)
              size_options = active_variants.flat_map { |v| v.option_values.select { |ov| ov.option_type.name == 'size' } }.uniq
              color_options = active_variants.flat_map { |v| v.option_values.select { |ov| ov.option_type.name == 'color' } }.uniq

              # Stock par option (pour marquer les tailles/couleurs épuisées)
              size_stock = Hash.new(0)
              color_stock = Hash.new(0)
              active_variants.each do |v|
                v.option_values.each do |ov|
                  case ov.option_type.name
                  when 'size'
                    size_stock[ov.id] += v.stock_qty
                  when 'color'
                    color_stock[ov.id] += v.stock_qty
                  end
                end
              end

              has_options = size_options.any? || color_options.any?
            %>
            <article class="card card-product card-liquid rounded-liquid" 
                     data-product-url="<%= product_path(product.slug.presence || product) %>" 
                     style="cursor: pointer;">
              <div class="card-product-image-wrapper">
                <div class="card-product-image <%= 'product-image-clickable' if product.image.attached? || product.image_url.present? %>" 
                     <% if product.image.attached? || product.image_url.present? %>
                       style="cursor: pointer;" 
                       data-bs-toggle="modal" 
                       data-bs-target="#productImageModal<%= product.id %>"
                       aria-label="Agrandir l'image de <%= product.name %>"
                     <% end %>>
                  <% if product.image.attached? %>
                    <%= image_tag product.image, alt: product.name, loading: "lazy", decoding: "async" %>
                  <% elsif product.image_url.present? %>
                    <%= image_tag product.image_url, alt: product.name, loading: "lazy", decoding: "async" %>
                  <% end %>
                </div>
                <% if has_stock %>
                  <span class="badge badge-liquid-success badge-stock">En stock</span>
                <% else %>
                  <span class="badge badge-liquid-danger badge-stock">Rupture</span>
                <% end %>
              </div>
              <div class="card-body">
                <div class="product-content">
                  <h5 class="product-title mb-2"><%= product.name %></h5>
                  <p class="product-description mb-2 small text-muted">
                    <%= product.description.presence || "Porter les couleurs de Grenoble Roller !" %>
                  </p>
                </div>

                <!-- pousse le bloc options + footer en bas de la card -->
                <div class="spacer"></div>
                
                <% if active_variants.any? %>
                  <div class="product-options-section mb-1">
                    <div class="product-options">
                      <% if size_options.size > 1 %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Tailles :</strong>
                          <%= size_options.map(&:presentation).join(', ') %>
                        </p>
                      <% elsif size_options.size == 1 %>
                        <% size_opt = size_options.first %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Taille :</strong> <%= size_opt.presentation %>
                          <% if size_stock[size_opt.id] <= 0 %>
                            <span class="text-danger ms-1">(plus en stock)</span>
                          <% end %>
                        </p>
                      <% end %>
                      
                      <% if color_options.size > 1 %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Couleurs :</strong>
                          <%= color_options.map(&:presentation).join(', ') %>
                        </p>
                      <% elsif color_options.size == 1 %>
                        <% color_opt = color_options.first %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Couleur :</strong> <%= color_opt.presentation %>
                          <% if color_stock[color_opt.id] <= 0 %>
                            <span class="text-danger ms-1">(plus en stock)</span>
                          <% end %>
                        </p>
                      <% end %>
                      
                      <% if size_options.empty? && color_options.empty? %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Taille :</strong> Taille unique
                        </p>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <div class="product-footer">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="price-section-vertical mb-0">
                      <div class="price-display">
                        <% if has_multiple_prices %>
                          <span class="price">À partir de <%= format_price(min_price) %></span>
                        <% else %>
                          <span class="price"><%= format_price(min_price) %></span>
                        <% end %>
                      </div>
                    </div>
                  </div>

                  <%= link_to product_path(product.slug.presence || product),
                              class: "btn btn-liquid-primary btn-add w-100",
                              aria: { label: "Voir le produit #{product.name}" } do %>
                    <i class="bi bi-eye me-2" aria-hidden="true"></i>
                    <span><%= has_options ? "Choisir les options" : "Voir le produit" %></span>
                  <% end %>
                </div>
              </div>
            </article>
          <% end %>
        </div>
        
        <% if @products.empty? %>
          <div class="text-center py-5">
            <div class="card card-liquid rounded-liquid shadow-sm p-5">
              <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
              <h3 class="h5 fw-bold mt-3 mb-2">Aucun produit trouvé</h3>
              <p class="text-body-secondary mb-4">
                <% if @selected_category %>
                  Aucun produit disponible dans la catégorie "<%= @selected_category.name %>".
                <% else %>
                  Aucun produit disponible pour le moment.
                <% end %>
              </p>
              <% if @selected_category %>
                <%= link_to products_path, class: "btn btn-liquid-primary" do %>
                  <i class="bi bi-arrow-left me-2" aria-hidden="true"></i>Voir tous les produits
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </section>
</div>

<!-- Modals Lightbox pour images produits -->
<% @products.each do |product| %>
  <% if product.image.attached? || product.image_url.present? %>
    <div class="modal fade" id="productImageModal<%= product.id %>" tabindex="-1" aria-labelledby="productImageModalLabel<%= product.id %>" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title text-white" id="productImageModalLabel<%= product.id %>"><%= product.name %></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body p-0 text-center">
            <% if product.image.attached? %>
              <%= image_tag product.image, alt: product.name, class: "img-fluid rounded", style: "max-height: 80vh; width: auto;" %>
            <% elsif product.image_url.present? %>
              <%= image_tag product.image_url, alt: product.name, class: "img-fluid rounded", style: "max-height: 80vh; width: auto;" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
