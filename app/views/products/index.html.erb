<% content_for :title, "Boutique - Grenoble Roller" %>
<% content_for :description, "Boutique officielle Grenoble Roller. Découvrez nos produits et accessoires Roller. Commandez en ligne et recevez vos articles rapidement !" %>

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="display-5 text-liquid-primary-white mb-2">
        <i class="bi bi-bag-heart me-2" aria-hidden="true"></i>Boutique
      </h1>
    </div>
  </div>

  <section class="mb-5" aria-label="Catalogue produits">
    <div class="row">
      <div class="col-12 col-lg-8 mx-auto">
        <div class="product-grid">
          <% @products.each do |product| %>
            <% 
              active_variants = product.product_variants.where(is_active: true).includes(variant_option_values: { option_value: :option_type })
              has_stock = active_variants.any? { |v| v.stock_qty > 0 }
              min_price = active_variants.minimum(:price_cents) || product.price_cents
              max_price = active_variants.maximum(:price_cents) || product.price_cents
              has_multiple_prices = min_price != max_price
              
              # Group variants by option types (size, color)
              size_options = active_variants.flat_map { |v| v.option_values.select { |ov| ov.option_type.name == 'size' } }.uniq
              color_options = active_variants.flat_map { |v| v.option_values.select { |ov| ov.option_type.name == 'color' } }.uniq

              # Stock par option (pour marquer les tailles/couleurs épuisées)
              size_stock = Hash.new(0)
              color_stock = Hash.new(0)
              active_variants.each do |v|
                v.option_values.each do |ov|
                  case ov.option_type.name
                  when 'size'
                    size_stock[ov.id] += v.stock_qty
                  when 'color'
                    color_stock[ov.id] += v.stock_qty
                  end
                end
              end

              has_options = size_options.any? || color_options.any?
            %>
            <article class="card card-product card-liquid rounded-liquid" 
                     data-product-url="<%= product_path(product.slug.presence || product) %>" 
                     style="cursor: pointer;">
              <div class="card-product-image-wrapper">
                <div class="card-product-image">
                  <% if product.image.attached? %>
                    <%= image_tag product.image, alt: product.name, loading: "lazy", decoding: "async" %>
                  <% elsif product.image_url.present? %>
                    <%= image_tag product.image_url, alt: product.name, loading: "lazy", decoding: "async" %>
                  <% end %>
                </div>
                <% if has_stock %>
                  <span class="badge badge-liquid-success badge-stock">En stock</span>
                <% else %>
                  <span class="badge badge-liquid-danger badge-stock">Rupture</span>
                <% end %>
              </div>
              <div class="card-body">
                <div class="product-content">
                  <h5 class="product-title mb-2"><%= product.name %></h5>
                  <p class="product-description mb-2 small text-muted">
                    <%= product.description.presence || "Porter les couleurs de Grenoble Roller !" %>
                  </p>
                </div>

                <!-- pousse le bloc options + footer en bas de la card -->
                <div class="spacer"></div>
                
                <% if active_variants.any? %>
                  <div class="product-options-section mb-1">
                    <div class="product-options">
                      <% if size_options.size > 1 %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Tailles :</strong>
                          <%= size_options.map(&:presentation).join(', ') %>
                        </p>
                      <% elsif size_options.size == 1 %>
                        <% size_opt = size_options.first %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Taille :</strong> <%= size_opt.presentation %>
                          <% if size_stock[size_opt.id] <= 0 %>
                            <span class="text-danger ms-1">(plus en stock)</span>
                          <% end %>
                        </p>
                      <% end %>
                      
                      <% if color_options.size > 1 %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Couleurs :</strong>
                          <%= color_options.map(&:presentation).join(', ') %>
                        </p>
                      <% elsif color_options.size == 1 %>
                        <% color_opt = color_options.first %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Couleur :</strong> <%= color_opt.presentation %>
                          <% if color_stock[color_opt.id] <= 0 %>
                            <span class="text-danger ms-1">(plus en stock)</span>
                          <% end %>
                        </p>
                      <% end %>
                      
                      <% if size_options.empty? && color_options.empty? %>
                        <p class="small text-body-secondary mb-1">
                          <strong>Taille :</strong> Taille unique
                        </p>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <div class="product-footer">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="price-section-vertical mb-0">
                      <div class="price-display">
                        <% if has_multiple_prices %>
                          <span class="price">À partir de <%= format_price(min_price) %></span>
                        <% else %>
                          <span class="price"><%= format_price(min_price) %></span>
                        <% end %>
                      </div>
                    </div>
                  </div>

                  <%= link_to product_path(product.slug.presence || product),
                              class: "btn btn-liquid-primary btn-add w-100",
                              aria: { label: "Voir le produit #{product.name}" } do %>
                    <i class="bi bi-eye me-2" aria-hidden="true"></i>
                    <span><%= has_options ? "Choisir les options" : "Voir le produit" %></span>
                  <% end %>
                </div>
              </div>
            </article>
          <% end %>
        </div>
      </div>
    </div>
  </section>
</div>
