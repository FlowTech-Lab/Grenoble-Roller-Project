<% content_for :title, @event.title %>

<section class="container py-4 py-lg-5">
  <article class="card card-liquid event-detail-card shadow-liquid border-0 mx-auto">
    <!-- Hero image avec overlay gradient et informations superposées -->
    <div class="hero-event-wrapper">
      <div class="hero-image-container">
        <%= image_tag(event_cover_image_url(@event), alt: @event.title, class: "hero-image", loading: "eager") %>
        <div class="hero-overlay"></div>
        
        <!-- Badge de statut en haut à droite (z-index élevé) -->
        <div class="position-absolute top-0 end-0 p-3" style="z-index: 10;">
          <span class="badge badge-liquid-<%= @event.published? ? 'success' : @event.draft? ? 'warning' : 'danger' %> text-uppercase shadow-sm">
            <%= @event.status.humanize %>
          </span>
        </div>
        
        <!-- Informations directement sur l'image -->
        <div class="hero-content">
          <h1 class="hero-title"><%= @event.title %></h1>
          
          <div class="hero-meta">
            <span class="meta-item">
              <i class="bi bi-geo-alt"></i>
              <%= @event.location_text %>
            </span>
            <span class="meta-item">
              <i class="bi bi-clock"></i>
              <%= @event.duration_min %> min
            </span>
            <% if @event.route.present? %>
              <span class="meta-item">
                <i class="bi bi-signpost"></i>
                <%= @event.route.name %>
              </span>
            <% end %>
          </div>
          
          <div class="hero-badges">
            <span class="badge bg-primary">
              <i class="bi bi-people-fill me-1"></i>
              <%= pluralize(@event.attendances_count, "inscrit") %>
            </span>
            
            <% unless @event.unlimited? %>
              <% if @event.full? %>
                <span class="badge bg-danger">
                  <i class="bi bi-x-circle me-1"></i>Complet
                </span>
              <% else %>
                <span class="badge bg-success">
                  <i class="bi bi-check-circle me-1"></i><%= pluralize(@event.remaining_spots, "place disponible") %>
                </span>
              <% end %>
            <% else %>
              <span class="badge bg-info">
                <i class="bi bi-infinity me-1"></i>Illimité
              </span>
            <% end %>
            
            <% if user_signed_in? && current_user_has_attendance?(@event) %>
              <span class="badge bg-success">
                <i class="bi bi-check-circle me-1"></i>Vous êtes inscrit(e)
              </span>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body p-3 p-md-4 p-lg-5">
      <!-- Informations essentielles (What, When, Where) -->
      <section class="event-details-section mb-4">
        <div class="detail-row">
          <div class="detail-icon">
            <i class="bi bi-calendar-event"></i>
          </div>
          <div class="detail-content">
            <p class="detail-label">Quand</p>
            <p class="detail-value">
              <strong><%= l @event.start_at, format: :event_long, locale: :fr %></strong>
            </p>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-icon">
            <i class="bi bi-geo-alt<%= @event.has_gps_coordinates? ? '-fill text-success' : '' %>"></i>
          </div>
          <div class="detail-content">
            <p class="detail-label">Rendez-vous</p>
            <p class="detail-value mb-2">
              <strong><%= @event.location_text %></strong>
            </p>
            
            <% if @event.has_gps_coordinates? %>
              <div class="d-flex flex-wrap gap-2 mb-2">
                <a href="<%= @event.google_maps_url %>" 
                   target="_blank"
                   rel="noopener noreferrer"
                   class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-map me-1"></i>Ouvrir dans Google Maps
                </a>
                
                <a href="<%= @event.waze_url %>"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="btn btn-sm btn-outline-info">
                  <i class="bi bi-compass me-1"></i>Ouvrir dans Waze
                </a>
              </div>
              
              <p class="text-muted small mb-0">
                <i class="bi bi-pin-map me-1"></i>
                Coordonnées: <%= @event.meeting_lat %>, <%= @event.meeting_lng %>
              </p>
            <% end %>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-icon">
            <i class="bi bi-currency-euro"></i>
          </div>
          <div class="detail-content">
            <p class="detail-label">Tarif</p>
            <p class="detail-value">
              <%= number_to_currency(@event.price_cents / 100.0, unit: @event.currency) %>
            </p>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-icon">
            <i class="bi bi-person-badge"></i>
          </div>
          <div class="detail-content">
            <p class="detail-label">Organisateur</p>
            <p class="detail-value"><%= @event.creator_user.first_name %> <%= @event.creator_user.last_name %></p>
          </div>
        </div>
      </section>

      <!-- Alert de rappel améliorée pour utilisateurs inscrits -->
      <% if current_user_has_attendance?(@event) && @user_attendance %>
        <% if @user_attendance.wants_reminder? %>
          <div class="alert alert-info alert-reminder d-flex align-items-center justify-content-between mb-4" role="alert">
            <div class="d-flex align-items-center">
              <i class="bi bi-bell-fill me-2 fs-5"></i>
              <div>
                <strong>Rappel activé</strong>
                <p class="mb-0 small">Vous recevrez un email la veille à 19h pour vous rappeler l'événement.</p>
              </div>
            </div>
            <%= button_to toggle_reminder_event_path(@event), method: :patch, 
                class: "btn btn-sm btn-outline-secondary", 
                data: { turbo: false },
                aria: { label: 'Désactiver le rappel' } do %>
              <i class="bi bi-bell me-1"></i>Désactiver
            <% end %>
          </div>
        <% else %>
          <div class="alert alert-warning alert-reminder alert-dismissible fade show d-flex align-items-center justify-content-between mb-4" role="alert">
            <div class="d-flex align-items-center">
              <i class="bi bi-bell-exclamation me-2 fs-5"></i>
              <div>
                <strong>Rappel désactivé</strong>
                <p class="mb-0 small">Activez-le pour ne pas oublier cette sortie.</p>
              </div>
            </div>
            <%= button_to toggle_reminder_event_path(@event), method: :patch, 
                class: "btn btn-sm btn-outline-primary", 
                data: { turbo: false, bs_dismiss: "alert" },
                aria: { label: 'Activer le rappel' } do %>
              <i class="bi bi-bell-plus me-1"></i>Activer le rappel
            <% end %>
          </div>
        <% end %>
      <% end %>

      <!-- Description détaillée -->
      <div class="event-description mb-4">
        <h2 class="h5 fw-semibold mb-3">À propos</h2>
        <div class="text-body" style="line-height: 1.7;">
          <%= simple_format(@event.description) %>
        </div>
      </div>


      <!-- Actions avec hiérarchie claire et sticky sur mobile -->
      <div class="event-actions-sticky">
        <!-- Bouton primaire séparé et proéminent -->
        <% if current_user_has_attendance?(@event) %>
          <div class="d-grid">
            <%= button_to cancel_attendance_event_path(@event), method: :delete, 
                class: 'btn btn-outline-secondary btn-lg btn-block', 
                data: { turbo_confirm: 'Annuler votre inscription ?' },
                aria: { label: 'Se désinscrire de cet événement' } do %>
              <i class="bi bi-calendar-x me-2"></i>Se désinscrire
            <% end %>
          </div>
        <% elsif policy(@event).can_attend? && !@event.full? %>
          <div class="d-grid">
            <button type="button" 
                    class="btn btn-liquid-primary btn-lg btn-block" 
                    data-bs-toggle="modal" 
                    data-bs-target="#confirmAttendModalShow"
                    aria-label="S'inscrire à cet événement">
              <i class="bi bi-calendar-plus me-2"></i>S'inscrire
            </button>
          </div>
        <% elsif @event.full? %>
          <div class="d-grid">
            <button type="button" class="btn btn-outline-secondary btn-lg btn-block" disabled aria-label="Événement complet">
              <i class="bi bi-x-circle me-2"></i>Cet événement est complet
            </button>
          </div>
        <% end %>

        <!-- Boutons secondaires groupés -->
        <div class="secondary-actions">
          <% if user_signed_in? %>
            <%= link_to ical_event_path(@event, format: :ics), 
                class: 'btn btn-outline-primary btn-sm', 
                title: 'Télécharger le fichier .ics pour l\'ajouter à votre calendrier', 
                data: { bs_toggle: 'tooltip', bs_placement: 'top' },
                aria: { label: 'Ajouter au calendrier' } do %>
              <i class="bi bi-calendar-event me-1"></i>Calendrier
            <% end %>
          <% else %>
            <%= link_to new_user_session_path, 
                class: 'btn btn-outline-primary btn-sm',
                aria: { label: 'Se connecter pour accéder aux fonctionnalités' } do %>
              <i class="bi bi-box-arrow-in-right me-1"></i>Connexion
            <% end %>
          <% end %>

          <%= link_to events_path, 
              class: 'btn btn-outline-secondary btn-sm',
              aria: { label: 'Voir tous les événements' } do %>
            <i class="bi bi-calendar-event me-1"></i>Tous les événements
          <% end %>

          <% if policy(@event).edit? %>
            <%= link_to edit_event_path(@event), 
                class: 'btn btn-link text-decoration-none btn-sm',
                aria: { label: 'Modifier cet événement' } do %>
              <i class="bi bi-pencil-square me-1"></i>Modifier
            <% end %>
          <% end %>

          <% if policy(@event).destroy? %>
            <button type="button" 
                    class="btn btn-link text-danger text-decoration-none btn-sm" 
                    data-bs-toggle="modal" 
                    data-bs-target="#confirmDeleteModalShow"
                    aria-label="Supprimer cet événement">
              <i class="bi bi-trash me-1"></i>Supprimer
            </button>
          <% end %>
        </div>
      </div>
    </div>
  </article>
</section>

<!-- Modal de confirmation d'inscription simplifiée -->
<% if policy(@event).can_attend? && !@event.full? %>
  <div class="modal fade" id="confirmAttendModalShow" tabindex="-1" aria-labelledby="confirmAttendModalShowLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmAttendModalShowLabel">
            <i class="bi bi-calendar-check me-2"></i>Confirmer votre inscription
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <%= form_with url: attend_event_path(@event), method: :post, data: { turbo: false } do |f| %>
          <div class="modal-body">
            <p class="lead mb-3">
              Confirmez votre participation à <strong><%= @event.title %></strong>
            </p>
            
            <div class="form-check mb-3">
              <%= f.check_box :wants_reminder, { checked: true, class: 'form-check-input' }, '1', '0' %>
              <label class="form-check-label" for="wants_reminder">
                <i class="bi bi-bell me-1"></i>
                Recevoir un rappel par email la veille à 19h
              </label>
            </div>
            
            <p class="text-muted small mb-0">
              <i class="bi bi-info-circle me-1"></i>
              Vous recevrez une confirmation par email et pourrez annuler votre inscription à tout moment.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <%= f.submit "Confirmer l'inscription", class: "btn btn-liquid-primary", data: { bs_dismiss: "modal" } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Modal de confirmation de suppression -->
<% if policy(@event).destroy? %>
  <div class="modal fade" id="confirmDeleteModalShow" tabindex="-1" aria-labelledby="confirmDeleteModalShowLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalShowLabel">Supprimer l'événement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">
            Cette action est définitive. Souhaitez-vous supprimer
            <strong><%= @event.title %></strong> ?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
          <%= button_to event_path(@event), method: :delete, form: { data: { turbo: true } }, class: "btn btn-danger" do %>
            <i class="bi bi-trash me-2"></i>Oui, supprimer
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>
