<div class="col-12 col-sm-6 col-lg-4<%= ' position-relative' if local_assigns[:is_first] %>">
  <% if local_assigns[:is_first] %>
    <!-- Badge "Prochain" sur le premier événement - aligné avec le badge de date -->
    <span class="badge bg-warning text-dark position-absolute" style="left: 2.5rem; z-index: 10;">
      <i class="bi bi-star-fill me-1" aria-hidden="true"></i>Prochain
    </span>
  <% end %>
  <article class="card card-event card-liquid rounded-liquid shadow-liquid h-100">
    <div class="card-event-image">
      <% if event.cover_image.attached? %>
        <%= image_tag(rails_representation_path(event.cover_image_card), alt: event.title, loading: 'lazy', class: 'w-100 h-100 object-fit-cover') %>
      <% end %>
      <span class="card-event-date badge <%= (defined?(past) && past) || event.past? ? 'badge-liquid-secondary' : 'badge-liquid-primary' %>">
        <i class="bi bi-calendar3 me-1" aria-hidden="true"></i>
        <%= l event.start_at, format: :day_month, locale: :fr %>
      </span>
    </div>

    <div class="card-body d-flex flex-column p-3 p-md-4">
      <!-- Zone de contenu (titre, description, infos) -->
      <div class="flex-grow-1 mb-3">
        <h5 class="card-title mb-2 text-body h6 fw-bold">
          <%= link_to event.title, event_path(event), class: 'text-decoration-none text-body', aria: { label: "Voir les détails de #{event.title}" } %>
        </h5>

        <div class="card-event-info mb-3 text-body-secondary small">
          <p class="mb-1">
            <i class="bi bi-calendar-week text-liquid-primary me-2" aria-hidden="true"></i>
            <%= l event.start_at, format: :event_long, locale: :fr %>
          </p>
          <p class="mb-1">
            <i class="bi bi-geo-alt text-liquid-primary me-2" aria-hidden="true"></i>
            <%= truncate(event.location_text, length: 50) %>
          </p>
          <p class="mb-1">
            <i class="bi bi-signpost-2 text-liquid-primary me-2" aria-hidden="true"></i>
            <% if event.loops_count && event.loops_count > 1 %>
              <%= number_with_precision(event.total_distance_km, precision: 1, strip_insignificant_zeros: true) %> km
              <span class="badge bg-info ms-2"><%= pluralize(event.loops_count, "boucle") %></span>
            <% else %>
              <%= number_with_precision(event.distance_km, precision: 1, strip_insignificant_zeros: true) %> km
            <% end %>
          </p>
          <p class="mb-0">
            <i class="bi bi-clock text-liquid-primary me-2" aria-hidden="true"></i>
            <%= event.duration_min %> min
          </p>
        </div>

        <p class="text-muted small mb-3"><%= truncate(event.description, length: 100, omission: '...') %></p>

        <div class="d-flex flex-wrap gap-2 mb-3">
          <!-- Badge Statut (pour admins/moderateurs) - exclure les rejetés -->
          <% if can_moderate? && event.draft? %>
            <span class="badge bg-warning text-dark">
              <i class="bi bi-hourglass-split me-1" aria-hidden="true"></i>En attente
            </span>
          <% elsif can_moderate? && event.rejected? %>
            <span class="badge bg-danger">
              <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Rejeté
            </span>
          <% end %>
          <!-- Badge Passé (si événement passé) -->
          <% if (defined?(past) && past) || event.past? %>
            <span class="badge badge-liquid-secondary">
              <i class="bi bi-archive me-1" aria-hidden="true"></i>Passé
            </span>
          <% end %>
          <!-- Badge Annulé (prioritaire) -->
          <% if event.canceled? %>
            <span class="badge bg-danger">
              <i class="bi bi-x-octagon me-1" aria-hidden="true"></i>Annulé
            </span>
          <% end %>
          
          <!-- Badge Nouveau (événements créés dans les 7 dernièr jours) -->
          <% if event.recent? && !event.canceled? %>
            <span class="badge badge-liquid-success">
              <i class="bi bi-star-fill me-1" aria-hidden="true"></i>Nouveau
            </span>
          <% end %>
          
          <span class="badge bg-primary">
            <i class="bi bi-people-fill me-1" aria-hidden="true"></i>
            <%= pluralize(event.attendances_count, "inscrit") %>
          </span>
          
          <% unless event.unlimited? %>
            <% if event.full? %>
              <span class="badge bg-danger">
                <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Complet
              </span>
            <% elsif event.remaining_spots <= 5 %>
              <span class="badge bg-warning text-dark">
                <i class="bi bi-exclamation-triangle me-1" aria-hidden="true"></i><%= pluralize(event.remaining_spots, "place disponible") %>
              </span>
            <% else %>
              <span class="badge bg-success">
                <i class="bi bi-check-circle me-1" aria-hidden="true"></i><%= pluralize(event.remaining_spots, "place disponible") %>
              </span>
            <% end %>
          <% else %>
            <span class="badge bg-info">
              <i class="bi bi-infinity me-1" aria-hidden="true"></i>Illimité
            </span>
          <% end %>
          
          <% if defined?(render_signup_button) && render_signup_button && user_signed_in? && current_user_has_attendance?(event) %>
            <span class="badge bg-success">
              <i class="bi bi-check-circle me-1" aria-hidden="true"></i>Vous êtes inscrit(e)
            </span>
          <% end %>
          
          <!-- Badge Rappel (si attendance est passé et wants_reminder est défini) -->
          <% if defined?(attendance) && attendance.present? && attendance.wants_reminder != nil %>
            <% if attendance.wants_reminder %>
              <span class="badge badge-liquid-success">
                <i class="bi bi-bell-fill me-1" aria-hidden="true"></i>Rappel activé
              </span>
            <% else %>
              <span class="badge badge-liquid-secondary">
                <i class="bi bi-bell-slash me-1" aria-hidden="true"></i>Rappel désactivé
              </span>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="mt-auto">
        <div class="action-row d-flex flex-wrap gap-2">
          <!-- Bouton Découvrir en premier (action principale) -->
          <%= link_to(event_path(event), 
              class: "btn btn-liquid-primary btn-sm", 
              aria: { label: "Découvrir #{event.title}" }) do %>
            <i class="bi bi-compass me-1" aria-hidden="true"></i>Découvrir
          <% end %>

          <% if defined?(render_signup_button) && render_signup_button %>
            <% if current_user_has_attendance?(event) %>
              <!-- Calendrier (action positive) -->
              <% if user_signed_in? %>
                <%= link_to event_path(event, format: :ics), 
                    class: "btn btn-outline-primary btn-sm", 
                    title: 'Ajouter au calendrier',
                    aria: { label: 'Ajouter au calendrier' } do %>
                  <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>Calendrier
                <% end %>
              <% end %>
            <% elsif event.full? %>
              <!-- Calendrier même si complet -->
              <% if user_signed_in? %>
                <%= link_to event_path(event, format: :ics), 
                    class: "btn btn-outline-primary btn-sm", 
                    title: 'Ajouter au calendrier',
                    aria: { label: 'Ajouter au calendrier' } do %>
                  <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>Calendrier
                <% end %>
              <% end %>
            <% end %>
          <% else %>
            <!-- Si pas de bouton d'inscription, afficher Calendrier/Connexion -->
            <% if user_signed_in? %>
              <%= link_to event_path(event, format: :ics), 
                  class: "btn btn-outline-primary btn-sm", 
                  title: 'Ajouter au calendrier',
                  aria: { label: 'Ajouter au calendrier' } do %>
                <i class="bi bi-calendar-event me-1"></i>Calendrier
              <% end %>
            <% else %>
              <%= link_to new_user_session_path, 
                  class: "btn btn-outline-primary btn-sm",
                  aria: { label: 'Se connecter pour accéder aux fonctionnalités' } do %>
                <i class="bi bi-box-arrow-in-right me-1" aria-hidden="true"></i>Connexion
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
      </div>
  </article>
</div>

<% if defined?(render_signup_button) && render_signup_button && policy(event).can_attend? && !event.full? %>
    <div class="modal fade" id="confirmAttendModal<%= event.id %>" tabindex="-1" aria-labelledby="confirmAttendModalLabel<%= event.id %>" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title h5" id="confirmAttendModalLabel<%= event.id %>">
              <i class="bi bi-calendar-check me-2" aria-hidden="true"></i>Confirmer votre inscription
            </h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <%= form_with url: attend_event_path_for(event), method: :post, data: { turbo: false }, id: "attendForm#{event.id}", class: "attend-form" do |f| %>
            <div class="modal-body">
              <%= render 'shared/registration_form_fields', 
                  form: f, 
                  event: event, 
                  prefix_id: "_modal_#{event.id}", 
                  show_alert: true, 
                  show_summary: true %>

              <!-- Bouton Ajouter au calendrier -->
              <% if user_signed_in? %>
                <div class="mb-3 text-center">
                  <%= link_to event_path(event, format: :ics), 
                      class: "btn btn-outline-primary btn-sm w-100", 
                      title: 'Ajouter au calendrier',
                      aria: { label: 'Ajouter au calendrier' } do %>
                    <i class="bi bi-calendar-event me-2" aria-hidden="true"></i>Ajouter à mon calendrier
                  <% end %>
                </div>
              <% end %>
              
              <p class="mb-0 text-muted small">
                <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                Vous recevrez une confirmation par email et pourrez annuler votre inscription à tout moment.
              </p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="cancelBtn<%= event.id %>">Annuler</button>
              <%= f.submit "Confirmer l'inscription", class: "btn btn-liquid-primary", id: "submitBtn#{event.id}", data: { bs_dismiss: "modal" } %>
            </div>
            <script>
              (function() {
                var eventId = <%= event.id %>;
                var form = document.getElementById('attendForm' + eventId);
                var submitBtn = document.getElementById('submitBtn' + eventId);
                var cancelBtn = document.getElementById('cancelBtn' + eventId);
                
                if (form && submitBtn) {
                  form.addEventListener('submit', function() {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Inscription en cours...';
                    if (cancelBtn) cancelBtn.disabled = true;
                  });
                }
              })();
            </script>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Modal de désinscription multiple -->
  <% if user_signed_in? && defined?(render_signup_button) && render_signup_button && current_user_has_attendance?(event) %>
    <% user_attendances = event.attendances.where(user: current_user).includes(:child_membership) %>
    <% parent_attendance = user_attendances.find_by(child_membership_id: nil) %>
    <% child_attendances = user_attendances.where.not(child_membership_id: nil) %>
    <% total_attendances = (parent_attendance ? 1 : 0) + child_attendances.count %>
    
    <% if total_attendances > 1 %>
      <div class="modal fade" id="cancelAttendanceModal<%= event.id %>" tabindex="-1" aria-labelledby="cancelAttendanceModalLabel<%= event.id %>" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title h5" id="cancelAttendanceModalLabel<%= event.id %>">
                <i class="bi bi-calendar-x text-danger me-2" aria-hidden="true"></i>Annuler une inscription
              </h2>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
              <p class="mb-3">Plusieurs personnes sont inscrites à cet événement. Sélectionnez celle(s) que vous souhaitez désinscrire :</p>
              
              <div class="list-group">
                <% if parent_attendance %>
                  <%= button_to cancel_attendance_event_path_for(event), 
                      method: :delete, 
                      class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center",
                      data: { turbo_confirm: 'Annuler votre inscription ? Vous pouvez vous réinscrire plus tard si vous le souhaitez.' } do %>
                    <div>
                      <i class="bi bi-person-fill me-2" aria-hidden="true"></i>
                      <strong>Vous</strong>
                    </div>
                    <i class="bi bi-chevron-right" aria-hidden="true"></i>
                  <% end %>
                <% end %>
                
                <% child_attendances.each do |child_attendance| %>
                  <%= button_to cancel_attendance_event_path_for(event), 
                      method: :delete, 
                      params: { child_membership_id: child_attendance.child_membership_id },
                      class: "list-group-item list-group-item-action d-flex justify-content-between align-items-center",
                      data: { turbo_confirm: "Annuler l'inscription de #{child_attendance.participant_name} ?" } do %>
                    <div>
                      <i class="bi bi-person-heart me-2" aria-hidden="true"></i>
                      <strong><%= child_attendance.participant_name %></strong>
                    </div>
                    <i class="bi bi-chevron-right" aria-hidden="true"></i>
                  <% end %>
                <% end %>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

