# --- ops/production/docker-compose.yml ---
# Usage: docker compose -f ops/production/docker-compose.yml up -d
#
# Configuration sécurisée production :
# - Caddy reverse proxy avec HTTPS automatique (Let's Encrypt)
# - Application Rails isolée (pas de ports exposés)
# - Tout le trafic passe par Caddy (ports 80/443 uniquement)
# - Réseau Docker interne pour communication entre services

services:
  # Caddy reverse proxy - Point d'entrée unique avec HTTPS automatique
  caddy:
    image: caddy:2-alpine
    container_name: grenoble-roller-caddy-production
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3 (QUIC)
      - "2019:2019"    # API admin (optionnel pour debug)
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data          # Certificats Let's Encrypt et données persistantes
      - caddy-config:/config       # Configuration runtime Caddy
    depends_on:
      web:
        condition: service_healthy
    networks:
    - app-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Permettre à Caddy d'accéder à internet pour Let's Encrypt
    dns:
      - 8.8.8.8
      - 8.8.4.4

  # Application Rails - ISOLÉE (pas de ports exposés)
  web:
    build:
      context: ../..
      dockerfile: Dockerfile
      args:
        BUILD_ID: ${BUILD_ID:-latest}
    container_name: grenoble-roller-production
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/grenoble_roller_production
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      DATABASE_NAME: grenoble_roller_production
      RAILS_ENV: production
      APP_ENV: production
      DEPLOY_ENV: production
      MAILER_HOST: ${VIRTUAL_HOST:-grenoble-roller.org}
      MAILER_PROTOCOL: https
      PORT: 3000
      # Rails doit savoir qu'il est derrière un proxy HTTPS
      RAILS_FORCE_SSL: "true"
      # Master key Rails (nécessaire pour décrypter les credentials)
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY:-}
    # AUCUN port exposé - accès uniquement via réseau Docker interne
    expose:
      - "3000"
    # Monter le fichier master.key pour que Rails puisse décrypter les credentials
    volumes:
      - ../../config/master.key:/rails/config/master.key:ro
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/up"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # Base de données PostgreSQL - ISOLÉE
  db:
    image: postgres:16-alpine
    container_name: grenoble-roller-db-production
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: grenoble_roller_production
    volumes:
      - grenoble-roller-prod-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
    # AUCUN port exposé - accès uniquement via réseau Docker interne

  # MinIO pour Active Storage - ISOLÉ
  minio:
    image: minio/minio:latest
    container_name: grenoble-roller-minio-production
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - grenoble-roller-prod-minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network
    # AUCUN port exposé - accès uniquement via réseau Docker interne

volumes:
  grenoble-roller-prod-db-data:
  grenoble-roller-prod-minio-data:
  caddy-data:      # Certificats Let's Encrypt et données persistantes Caddy
  caddy-config:    # Configuration runtime Caddy

networks:
  app-network:
    driver: bridge
    internal: false  # Caddy doit pouvoir accéder à internet pour Let's Encrypt
